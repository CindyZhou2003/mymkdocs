
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Cindy的笔记本">
      
      
      
        <link rel="canonical" href="https://cindyzhou2003.github.io/mymkdocs/Courses/DB.html">
      
      
        <link rel="prev" href="ADS.html">
      
      
        <link rel="next" href="DM.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.12">
    
    
      
        <title>数据库系统 - Cindy的笔记本</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW+WenKai:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"LXGW WenKai";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    
      <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
    
      <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
      <link rel="stylesheet" href="https://cdn.tonycrane.cc/jbmono/jetbrainsmono.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/neoteroi-mkdocs.css">
    
      <link rel="stylesheet" href="../css/style.css">
    
      <link rel="stylesheet" href="../css/font.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-system" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="Cindy的笔记本" class="md-header__button md-logo" aria-label="Cindy的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cindy的笔记本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              数据库系统
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/CindyZhou2003/mymkdocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Cindy's notebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../index.html" class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="ADS.html" class="md-tabs__link">
          
  
    
  
  Courses

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../skills/Algorithm.html" class="md-tabs__link">
          
  
    
  
  Skills

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../other/IELTs.html" class="md-tabs__link">
          
  
    
  
  Other

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
  <!-- Add scripts that need to run before here -->
  
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cindy的笔记本" class="md-nav__button md-logo" aria-label="Cindy的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cindy的笔记本
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CindyZhou2003/mymkdocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Cindy's notebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Home
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Courses
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Courses
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ADS.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高级数据结构与算法分析
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    数据库系统
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="DB.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    数据库系统
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1 Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-relation-schema" class="md-nav__link">
    <span class="md-ellipsis">
      2 Relation schema
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3 SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 基本类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 查询基本结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 查询基本结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      字符串运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      集合运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      关于空值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-aggregate-function" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Aggregate function 聚集函数
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 Aggregate function 聚集函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#group-by" class="md-nav__link">
    <span class="md-ellipsis">
      group by 分组聚集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      执行顺序
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-nested-subqueries" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Nested Subqueries 嵌套子查询
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4 Nested Subqueries 嵌套子查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-not-in" class="md-nav__link">
    <span class="md-ellipsis">
      in &amp; not in
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exist-not-exist" class="md-nav__link">
    <span class="md-ellipsis">
      exist &amp; not exist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unique" class="md-nav__link">
    <span class="md-ellipsis">
      unique
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with" class="md-nav__link">
    <span class="md-ellipsis">
      with
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      标量子查询
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 数据库创建、修改
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5 数据库创建、修改">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ddl" class="md-nav__link">
    <span class="md-ellipsis">
      DDL 数据定义语言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dml" class="md-nav__link">
    <span class="md-ellipsis">
      DML 数据操作语言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcl" class="md-nav__link">
    <span class="md-ellipsis">
      DCL 数据控制语言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 形式化关系查询语言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-sql-medium" class="md-nav__link">
    <span class="md-ellipsis">
      4 SQL medium
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 SQL medium">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-join" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Join 连接
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1 Join 连接">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural-join" class="md-nav__link">
    <span class="md-ellipsis">
      natural join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outer-join" class="md-nav__link">
    <span class="md-ellipsis">
      outer join 外连接
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-views" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Views 视图
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 Views 视图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      定义视图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#materialized-view" class="md-nav__link">
    <span class="md-ellipsis">
      物化视图 Materialized view
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 事物 transaction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-integrity-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 完整性约束 Integrity Constraints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 完整性约束 Integrity Constraints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.1 单关系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.2 引用完整性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#443" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.3 给约束赋名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#444" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.4 断言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    <span class="md-ellipsis">
      4.5 数据类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5 数据类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.1 时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.2 类型转换
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#453-default" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.3 缺省值default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#454" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.4 大对象
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#455" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.5 自定义类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#456" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.6 生成唯一码值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#457-createtable" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.7 createtable 拓展
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-index" class="md-nav__link">
    <span class="md-ellipsis">
      4.6 Index 索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      4.7 授权 Authorization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.7 授权 Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.1 授权与收权
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.2 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.3 视图
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-advanced-sql" class="md-nav__link">
    <span class="md-ellipsis">
      5 Advanced SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 Advanced SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-sql" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 使用程序设计语言访问SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.1 使用程序设计语言访问SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511-jdbc" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1 JDBC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#512-odbc" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.2 ODBC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    <span class="md-ellipsis">
      嵌入式SQL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 函数与过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.2 函数与过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.1 函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#522-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.2 过程 procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-trigger" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 Trigger 触发器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-e-r" class="md-nav__link">
    <span class="md-ellipsis">
      6 E-R 模型的数据库设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6 E-R 模型的数据库设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 实体和联系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 复杂属性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 映射基数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    <span class="md-ellipsis">
      6.5 主码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.5 主码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#651-r" class="md-nav__link">
    <span class="md-ellipsis">
      6.5.1 联系集R的主码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#652" class="md-nav__link">
    <span class="md-ellipsis">
      6.5.2 弱实体集
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66" class="md-nav__link">
    <span class="md-ellipsis">
      6.6 删除冗余属性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-e-r" class="md-nav__link">
    <span class="md-ellipsis">
      6.7 将E-R图转换成关系模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68" class="md-nav__link">
    <span class="md-ellipsis">
      6.8 拓展
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.8 拓展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#681" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.1 特化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#682" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.2 概化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#685" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.5 聚集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#69" class="md-nav__link">
    <span class="md-ellipsis">
      6.9 问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      - 联系集中已经隐含相关实体集主码属性了，不能再将它们作为联系集的属性
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7 关系数据库设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7 关系数据库设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 好的设计关系的特点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.1 好的设计关系的特点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#711" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.1 分解
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#712" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.2 规范化理论
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 使用函数依赖进行分解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 使用函数依赖进行分解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#721" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.1 符号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#722" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.2  函数依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#723" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.3 无损分解
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 范式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 范式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-bcnfboyce-codd-normal-form" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.1 BCNF(Boyce-Codd Normal Form)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-3nf" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.2 第三范式 3NF
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    <span class="md-ellipsis">
      7.4 函数依赖理论
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.4 函数依赖理论">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#741" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.1 函数依赖的闭包
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#742" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.2 属性集的闭包
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#743-canonical-cover" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.3 正则覆盖 Canonical cover
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76" class="md-nav__link">
    <span class="md-ellipsis">
      7.6 使用多值依赖的分解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.6 使用多值依赖的分解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#761" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.1 多值依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#762" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.2 第四范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#763-4nf" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.3 4NF分解
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#77" class="md-nav__link">
    <span class="md-ellipsis">
      7.7 第一范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questions" class="md-nav__link">
    <span class="md-ellipsis">
      Questions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8 存储管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8 存储管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 物理存储概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 磁盘
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 闪存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 文件组织
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.4 文件组织">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#841" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.1 定长记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#842" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.2 变长记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#843" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.3 列式存储
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85" class="md-nav__link">
    <span class="md-ellipsis">
      8.5 文件中记录的组织
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.5 文件中记录的组织">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#851" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.1 堆文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#852" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.2 顺序文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#853" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.3 多表聚簇文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#854" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.4 划分
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86" class="md-nav__link">
    <span class="md-ellipsis">
      8.6 数据字典存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87" class="md-nav__link">
    <span class="md-ellipsis">
      8.7 数据库缓冲区
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.7 数据库缓冲区">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#871" class="md-nav__link">
    <span class="md-ellipsis">
      8.7.1 缓冲区管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#872-buffer-replacement-policy" class="md-nav__link">
    <span class="md-ellipsis">
      8.7.2 替换策略 Buffer-Replacement Policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Questions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9 索引
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9 索引">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 顺序索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-b" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 B+树索引
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.3 B+树索引">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#931" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.1 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#932" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.2 查询
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#933" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.3 更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#934" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.4 非唯一性搜索码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quiz" class="md-nav__link">
    <span class="md-ellipsis">
      Quiz
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-hash-indices" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 散列索引 Hash indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95" class="md-nav__link">
    <span class="md-ellipsis">
      9.5 多码索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96" class="md-nav__link">
    <span class="md-ellipsis">
      9.6 位图索引
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      10 查询处理和查询优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10 查询处理和查询优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 查询代价
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      10.3 关系代数运算的执行
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.3 关系代数运算的执行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1031" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.1 选择运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1032" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.2 排序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1033" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.3 连接运算
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104" class="md-nav__link">
    <span class="md-ellipsis">
      10.4 表达式执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105" class="md-nav__link">
    <span class="md-ellipsis">
      10.5 查询优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.5 查询优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1051" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.1 等价关系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1053" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.3 查询规模估计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1054" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.4 执行优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      11 事务管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11 事务管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      11.1 概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115" class="md-nav__link">
    <span class="md-ellipsis">
      11.5 并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116" class="md-nav__link">
    <span class="md-ellipsis">
      11.6 可串行化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.6 可串行化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_4" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    <span class="md-ellipsis">
      - 前驱图无环，则是冲突可串行化的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="- 前驱图无环，则是冲突可串行化的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#117" class="md-nav__link">
    <span class="md-ellipsis">
      11.7 事物隔离性和原子性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      12 并发控制与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12 并发控制与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121" class="md-nav__link">
    <span class="md-ellipsis">
      12.1 锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12.1 锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#two-phrase-locking-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      two-phrase locking protocol 两阶段封锁协议
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122" class="md-nav__link">
    <span class="md-ellipsis">
      12.2 死锁处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124" class="md-nav__link">
    <span class="md-ellipsis">
      12.4 插入、删除与谓词读
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#128" class="md-nav__link">
    <span class="md-ellipsis">
      12.8 故障分类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#129" class="md-nav__link">
    <span class="md-ellipsis">
      12.9 存储器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1210" class="md-nav__link">
    <span class="md-ellipsis">
      12.10 恢复与原子性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12.10 恢复与原子性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#12101" class="md-nav__link">
    <span class="md-ellipsis">
      12.10.1 日志记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12102-checkpoint" class="md-nav__link">
    <span class="md-ellipsis">
      12.10.2 检查点 checkpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1211" class="md-nav__link">
    <span class="md-ellipsis">
      12.11 恢复算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1212" class="md-nav__link">
    <span class="md-ellipsis">
      12.12 缓冲区管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1213-aries-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      12.13 ARIES recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="DM.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    离散数学及其应用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="FDS.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据结构基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ML.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    机器学习（国际化）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="OOP.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    面向对象程序设计
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="PIS.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    信息安全原理
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Skills
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Skills
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skills/Algorithm.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skills/deeplearning.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    深度学习
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Other
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Other
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other/IELTs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IELTS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other/test.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1 Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-relation-schema" class="md-nav__link">
    <span class="md-ellipsis">
      2 Relation schema
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3 SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 基本类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 查询基本结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 查询基本结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      字符串运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      集合运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      关于空值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-aggregate-function" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Aggregate function 聚集函数
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 Aggregate function 聚集函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#group-by" class="md-nav__link">
    <span class="md-ellipsis">
      group by 分组聚集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      执行顺序
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-nested-subqueries" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Nested Subqueries 嵌套子查询
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4 Nested Subqueries 嵌套子查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-not-in" class="md-nav__link">
    <span class="md-ellipsis">
      in &amp; not in
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exist-not-exist" class="md-nav__link">
    <span class="md-ellipsis">
      exist &amp; not exist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unique" class="md-nav__link">
    <span class="md-ellipsis">
      unique
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with" class="md-nav__link">
    <span class="md-ellipsis">
      with
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      标量子查询
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 数据库创建、修改
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5 数据库创建、修改">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ddl" class="md-nav__link">
    <span class="md-ellipsis">
      DDL 数据定义语言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dml" class="md-nav__link">
    <span class="md-ellipsis">
      DML 数据操作语言
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcl" class="md-nav__link">
    <span class="md-ellipsis">
      DCL 数据控制语言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 形式化关系查询语言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-sql-medium" class="md-nav__link">
    <span class="md-ellipsis">
      4 SQL medium
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 SQL medium">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-join" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Join 连接
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1 Join 连接">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural-join" class="md-nav__link">
    <span class="md-ellipsis">
      natural join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outer-join" class="md-nav__link">
    <span class="md-ellipsis">
      outer join 外连接
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-views" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Views 视图
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 Views 视图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      定义视图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#materialized-view" class="md-nav__link">
    <span class="md-ellipsis">
      物化视图 Materialized view
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 事物 transaction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-integrity-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 完整性约束 Integrity Constraints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 完整性约束 Integrity Constraints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.1 单关系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.2 引用完整性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#443" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.3 给约束赋名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#444" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.4 断言
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    <span class="md-ellipsis">
      4.5 数据类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5 数据类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.1 时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.2 类型转换
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#453-default" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.3 缺省值default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#454" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.4 大对象
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#455" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.5 自定义类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#456" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.6 生成唯一码值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#457-createtable" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.7 createtable 拓展
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-index" class="md-nav__link">
    <span class="md-ellipsis">
      4.6 Index 索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      4.7 授权 Authorization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.7 授权 Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.1 授权与收权
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.2 角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.3 视图
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-advanced-sql" class="md-nav__link">
    <span class="md-ellipsis">
      5 Advanced SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 Advanced SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-sql" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 使用程序设计语言访问SQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.1 使用程序设计语言访问SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511-jdbc" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1 JDBC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#512-odbc" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.2 ODBC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    <span class="md-ellipsis">
      嵌入式SQL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 函数与过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.2 函数与过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.1 函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#522-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.2 过程 procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-trigger" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 Trigger 触发器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-e-r" class="md-nav__link">
    <span class="md-ellipsis">
      6 E-R 模型的数据库设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6 E-R 模型的数据库设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 实体和联系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 复杂属性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 映射基数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    <span class="md-ellipsis">
      6.5 主码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.5 主码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#651-r" class="md-nav__link">
    <span class="md-ellipsis">
      6.5.1 联系集R的主码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#652" class="md-nav__link">
    <span class="md-ellipsis">
      6.5.2 弱实体集
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66" class="md-nav__link">
    <span class="md-ellipsis">
      6.6 删除冗余属性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-e-r" class="md-nav__link">
    <span class="md-ellipsis">
      6.7 将E-R图转换成关系模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68" class="md-nav__link">
    <span class="md-ellipsis">
      6.8 拓展
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.8 拓展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#681" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.1 特化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#682" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.2 概化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#685" class="md-nav__link">
    <span class="md-ellipsis">
      6.8.5 聚集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#69" class="md-nav__link">
    <span class="md-ellipsis">
      6.9 问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      - 联系集中已经隐含相关实体集主码属性了，不能再将它们作为联系集的属性
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7 关系数据库设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7 关系数据库设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 好的设计关系的特点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.1 好的设计关系的特点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#711" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.1 分解
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#712" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.2 规范化理论
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 使用函数依赖进行分解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 使用函数依赖进行分解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#721" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.1 符号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#722" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.2  函数依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#723" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.3 无损分解
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 范式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 范式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-bcnfboyce-codd-normal-form" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.1 BCNF(Boyce-Codd Normal Form)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-3nf" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.2 第三范式 3NF
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    <span class="md-ellipsis">
      7.4 函数依赖理论
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.4 函数依赖理论">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#741" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.1 函数依赖的闭包
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#742" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.2 属性集的闭包
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#743-canonical-cover" class="md-nav__link">
    <span class="md-ellipsis">
      7.4.3 正则覆盖 Canonical cover
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76" class="md-nav__link">
    <span class="md-ellipsis">
      7.6 使用多值依赖的分解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.6 使用多值依赖的分解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#761" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.1 多值依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#762" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.2 第四范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#763-4nf" class="md-nav__link">
    <span class="md-ellipsis">
      7.6.3 4NF分解
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#77" class="md-nav__link">
    <span class="md-ellipsis">
      7.7 第一范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questions" class="md-nav__link">
    <span class="md-ellipsis">
      Questions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8 存储管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8 存储管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 物理存储概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 磁盘
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 闪存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 文件组织
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.4 文件组织">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#841" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.1 定长记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#842" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.2 变长记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#843" class="md-nav__link">
    <span class="md-ellipsis">
      8.4.3 列式存储
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85" class="md-nav__link">
    <span class="md-ellipsis">
      8.5 文件中记录的组织
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.5 文件中记录的组织">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#851" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.1 堆文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#852" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.2 顺序文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#853" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.3 多表聚簇文件组织
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#854" class="md-nav__link">
    <span class="md-ellipsis">
      8.5.4 划分
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86" class="md-nav__link">
    <span class="md-ellipsis">
      8.6 数据字典存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87" class="md-nav__link">
    <span class="md-ellipsis">
      8.7 数据库缓冲区
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.7 数据库缓冲区">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#871" class="md-nav__link">
    <span class="md-ellipsis">
      8.7.1 缓冲区管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#872-buffer-replacement-policy" class="md-nav__link">
    <span class="md-ellipsis">
      8.7.2 替换策略 Buffer-Replacement Policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Questions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9 索引
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9 索引">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 顺序索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-b" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 B+树索引
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.3 B+树索引">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#931" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.1 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#932" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.2 查询
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#933" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.3 更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#934" class="md-nav__link">
    <span class="md-ellipsis">
      9.3.4 非唯一性搜索码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quiz" class="md-nav__link">
    <span class="md-ellipsis">
      Quiz
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-hash-indices" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 散列索引 Hash indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95" class="md-nav__link">
    <span class="md-ellipsis">
      9.5 多码索引
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96" class="md-nav__link">
    <span class="md-ellipsis">
      9.6 位图索引
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      10 查询处理和查询优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10 查询处理和查询优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 查询代价
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      10.3 关系代数运算的执行
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.3 关系代数运算的执行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1031" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.1 选择运算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1032" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.2 排序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1033" class="md-nav__link">
    <span class="md-ellipsis">
      10.3.3 连接运算
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104" class="md-nav__link">
    <span class="md-ellipsis">
      10.4 表达式执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105" class="md-nav__link">
    <span class="md-ellipsis">
      10.5 查询优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.5 查询优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1051" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.1 等价关系
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1053" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.3 查询规模估计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1054" class="md-nav__link">
    <span class="md-ellipsis">
      10.5.4 执行优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      11 事务管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11 事务管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      11.1 概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115" class="md-nav__link">
    <span class="md-ellipsis">
      11.5 并发控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116" class="md-nav__link">
    <span class="md-ellipsis">
      11.6 可串行化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.6 可串行化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_4" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    <span class="md-ellipsis">
      - 前驱图无环，则是冲突可串行化的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="- 前驱图无环，则是冲突可串行化的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#117" class="md-nav__link">
    <span class="md-ellipsis">
      11.7 事物隔离性和原子性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      12 并发控制与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12 并发控制与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121" class="md-nav__link">
    <span class="md-ellipsis">
      12.1 锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12.1 锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#two-phrase-locking-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      two-phrase locking protocol 两阶段封锁协议
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122" class="md-nav__link">
    <span class="md-ellipsis">
      12.2 死锁处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124" class="md-nav__link">
    <span class="md-ellipsis">
      12.4 插入、删除与谓词读
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#128" class="md-nav__link">
    <span class="md-ellipsis">
      12.8 故障分类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#129" class="md-nav__link">
    <span class="md-ellipsis">
      12.9 存储器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1210" class="md-nav__link">
    <span class="md-ellipsis">
      12.10 恢复与原子性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12.10 恢复与原子性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#12101" class="md-nav__link">
    <span class="md-ellipsis">
      12.10.1 日志记录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12102-checkpoint" class="md-nav__link">
    <span class="md-ellipsis">
      12.10.2 检查点 checkpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1211" class="md-nav__link">
    <span class="md-ellipsis">
      12.11 恢复算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1212" class="md-nav__link">
    <span class="md-ellipsis">
      12.12 缓冲区管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1213-aries-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      12.13 ARIES recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
  <!-- Add scripts that need to run afterwards here -->
  
    <script src="../js/toc.js" defer></script>
    <link rel="stylesheet" href="../css/fold_toc.css">
  

          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="database-system">数据库系统 Database System<a class="headerlink" href="#database-system" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 13689 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span> 349 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13Z"/></svg></span> 预计阅读时间 50 分钟</p>
</div>
<div class="toc">
<ul>
<li><a href="#database-system">数据库系统 Database System</a><ul>
<li><a href="#1-introduction">1 Introduction</a></li>
<li><a href="#2-relation-schema">2 Relation schema</a></li>
<li><a href="#3-sql">3 SQL</a><ul>
<li><a href="#31">3.1 基本类型</a></li>
<li><a href="#32">3.2 查询基本结构</a><ul>
<li><a href="#_1">字符串运算</a></li>
<li><a href="#_2">集合运算</a></li>
<li><a href="#_3">关于空值</a></li>
</ul>
</li>
<li><a href="#33-aggregate-function">3.3 Aggregate function 聚集函数</a><ul>
<li><a href="#group-by">group by 分组聚集</a></li>
<li><a href="#_4">执行顺序</a></li>
</ul>
</li>
<li><a href="#34-nested-subqueries">3.4 Nested Subqueries 嵌套子查询</a><ul>
<li><a href="#in-not-in">in &amp; not in</a></li>
<li><a href="#exist-not-exist">exist &amp; not exist</a></li>
<li><a href="#unique">unique</a></li>
<li><a href="#with">with</a></li>
<li><a href="#_5">标量子查询</a></li>
</ul>
</li>
<li><a href="#35">3.5 数据库创建、修改</a><ul>
<li><a href="#ddl">DDL 数据定义语言</a></li>
<li><a href="#dml">DML 数据操作语言</a></li>
<li><a href="#dcl">DCL 数据控制语言</a></li>
</ul>
</li>
<li><a href="#36">3.6 形式化关系查询语言</a></li>
</ul>
</li>
<li><a href="#4-sql-medium">4 SQL medium</a><ul>
<li><a href="#41-join">4.1 Join 连接</a><ul>
<li><a href="#natural-join">natural join</a></li>
<li><a href="#outer-join">outer join 外连接</a></li>
</ul>
</li>
<li><a href="#42-views">4.2 Views 视图</a><ul>
<li><a href="#_6">定义视图</a></li>
<li><a href="#materialized-view">物化视图 Materialized view</a></li>
</ul>
</li>
<li><a href="#43-transaction">4.3 事物 transaction</a></li>
<li><a href="#44-integrity-constraints">4.4 完整性约束 Integrity Constraints</a><ul>
<li><a href="#441">4.4.1 单关系</a></li>
<li><a href="#442">4.4.2 引用完整性</a></li>
<li><a href="#443">4.4.3 给约束赋名</a></li>
<li><a href="#444">4.4.4 断言</a></li>
</ul>
</li>
<li><a href="#45">4.5 数据类型</a><ul>
<li><a href="#451">4.5.1 时间</a></li>
<li><a href="#452">4.5.2 类型转换</a></li>
<li><a href="#453-default">4.5.3 缺省值default</a></li>
<li><a href="#454">4.5.4 大对象</a></li>
<li><a href="#455">4.5.5 自定义类型</a></li>
<li><a href="#456">4.5.6 生成唯一码值</a></li>
<li><a href="#457-createtable">4.5.7 createtable 拓展</a></li>
</ul>
</li>
<li><a href="#46-index">4.6 Index 索引</a></li>
<li><a href="#47-authorization">4.7 授权 Authorization</a><ul>
<li><a href="#471">4.7.1 授权与收权</a></li>
<li><a href="#472">4.7.2 角色</a></li>
<li><a href="#473">4.7.3 视图</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-advanced-sql">5 Advanced SQL</a><ul>
<li><a href="#51-sql">5.1 使用程序设计语言访问SQL</a><ul>
<li><a href="#511-jdbc">5.1.1 JDBC</a></li>
<li><a href="#512-odbc">5.1.2 ODBC</a></li>
<li><a href="#sql">嵌入式SQL</a></li>
</ul>
</li>
<li><a href="#52">5.2 函数与过程</a><ul>
<li><a href="#521">5.2.1 函数</a></li>
<li><a href="#522-procedures">5.2.2 过程 procedures</a></li>
</ul>
</li>
<li><a href="#53-trigger">5.3 Trigger 触发器</a></li>
</ul>
</li>
<li><a href="#6-e-r">6 E-R 模型的数据库设计</a><ul>
<li><a href="#61">6.1 设计</a></li>
<li><a href="#62">6.2 实体和联系</a></li>
<li><a href="#63">6.3 复杂属性</a></li>
<li><a href="#64">6.4 映射基数</a></li>
<li><a href="#65">6.5 主码</a><ul>
<li><a href="#651-r">6.5.1 联系集R的主码</a></li>
<li><a href="#652">6.5.2 弱实体集</a></li>
</ul>
</li>
<li><a href="#66">6.6 删除冗余属性</a></li>
<li><a href="#67-e-r">6.7 将E-R图转换成关系模式</a></li>
<li><a href="#68">6.8 拓展</a><ul>
<li><a href="#681">6.8.1 特化</a></li>
<li><a href="#682">6.8.2 概化</a></li>
<li><a href="#685">6.8.5 聚集</a></li>
<li><a href="#69">6.9 问题</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#-">- 联系集中已经隐含相关实体集主码属性了，不能再将它们作为联系集的属性</a></li>
<li><a href="#7">7 关系数据库设计</a><ul>
<li><a href="#71">7.1 好的设计关系的特点</a><ul>
<li><a href="#711">7.1.1 分解</a></li>
<li><a href="#712">7.1.2 规范化理论</a></li>
</ul>
</li>
<li><a href="#72">7.2 使用函数依赖进行分解</a><ul>
<li><a href="#721">7.2.1 符号</a></li>
<li><a href="#722">7.2.2  函数依赖</a></li>
<li><a href="#723">7.2.3 无损分解</a></li>
</ul>
</li>
<li><a href="#73">7.3 范式</a><ul>
<li><a href="#731-bcnfboyce-codd-normal-form">7.3.1 BCNF(Boyce-Codd Normal Form)</a></li>
<li><a href="#732-3nf">7.3.2 第三范式 3NF</a></li>
</ul>
</li>
<li><a href="#74">7.4 函数依赖理论</a><ul>
<li><a href="#741">7.4.1 函数依赖的闭包</a></li>
<li><a href="#742">7.4.2 属性集的闭包</a></li>
<li><a href="#743-canonical-cover">7.4.3 正则覆盖 Canonical cover</a></li>
</ul>
</li>
<li><a href="#76">7.6 使用多值依赖的分解</a><ul>
<li><a href="#761">7.6.1 多值依赖</a></li>
<li><a href="#762">7.6.2 第四范式</a></li>
<li><a href="#763-4nf">7.6.3 4NF分解</a></li>
</ul>
</li>
<li><a href="#77">7.7 第一范式</a></li>
<li><a href="#questions">Questions</a></li>
</ul>
</li>
<li><a href="#8">8 存储管理</a><ul>
<li><a href="#81">8.1 物理存储概述</a></li>
<li><a href="#82">8.2 磁盘</a></li>
<li><a href="#83">8.3 闪存</a></li>
<li><a href="#84">8.4 文件组织</a><ul>
<li><a href="#841">8.4.1 定长记录</a></li>
<li><a href="#842">8.4.2 变长记录</a></li>
<li><a href="#843">8.4.3 列式存储</a></li>
</ul>
</li>
<li><a href="#85">8.5 文件中记录的组织</a><ul>
<li><a href="#851">8.5.1 堆文件组织</a></li>
<li><a href="#852">8.5.2 顺序文件组织</a></li>
<li><a href="#853">8.5.3 多表聚簇文件组织</a></li>
<li><a href="#854">8.5.4 划分</a></li>
</ul>
</li>
<li><a href="#86">8.6 数据字典存储</a></li>
<li><a href="#87">8.7 数据库缓冲区</a><ul>
<li><a href="#871">8.7.1 缓冲区管理器</a></li>
<li><a href="#872-buffer-replacement-policy">8.7.2 替换策略 Buffer-Replacement Policy</a></li>
</ul>
</li>
<li><a href="#questions_1">Questions</a></li>
</ul>
</li>
<li><a href="#9">9 索引</a><ul>
<li><a href="#91">9.1 基础</a></li>
<li><a href="#92">9.2 顺序索引</a></li>
<li><a href="#93-b">9.3 B+树索引</a><ul>
<li><a href="#931">9.3.1 结构</a></li>
<li><a href="#932">9.3.2 查询</a></li>
<li><a href="#933">9.3.3 更新</a></li>
<li><a href="#934">9.3.4 非唯一性搜索码</a></li>
<li><a href="#quiz">Quiz</a></li>
</ul>
</li>
<li><a href="#94-hash-indices">9.4 散列索引 Hash indices</a></li>
<li><a href="#95">9.5 多码索引</a></li>
<li><a href="#96">9.6 位图索引</a></li>
</ul>
</li>
<li><a href="#10">10 查询处理和查询优化</a><ul>
<li><a href="#101">10.1 概述</a></li>
<li><a href="#102">10.2 查询代价</a></li>
<li><a href="#103">10.3 关系代数运算的执行</a><ul>
<li><a href="#1031">10.3.1 选择运算</a></li>
<li><a href="#1032">10.3.2 排序</a></li>
<li><a href="#1033">10.3.3 连接运算</a></li>
</ul>
</li>
<li><a href="#104">10.4 表达式执行</a></li>
<li><a href="#105">10.5 查询优化</a><ul>
<li><a href="#1051">10.5.1 等价关系</a></li>
<li><a href="#1053">10.5.3 查询规模估计</a></li>
<li><a href="#1054">10.5.4 执行优化</a></li>
</ul>
</li>
<li><a href="#exercises">Exercises</a></li>
</ul>
</li>
<li><a href="#11">11 事务管理</a><ul>
<li><a href="#111">11.1 概念</a></li>
<li><a href="#115">11.5 并发控制</a></li>
<li><a href="#116">11.6 可串行化</a><ul>
<li><a href="#example_4">Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#-_1">- 前驱图无环，则是冲突可串行化的</a><ul>
<li><a href="#117">11.7 事物隔离性和原子性</a></li>
</ul>
</li>
<li><a href="#12">12 并发控制与恢复</a><ul>
<li><a href="#121">12.1 锁</a><ul>
<li><a href="#two-phrase-locking-protocol">two-phrase locking protocol 两阶段封锁协议</a></li>
</ul>
</li>
<li><a href="#122">12.2 死锁处理</a></li>
<li><a href="#124">12.4 插入、删除与谓词读</a></li>
<li><a href="#128">12.8 故障分类</a></li>
<li><a href="#129">12.9 存储器</a></li>
<li><a href="#1210">12.10 恢复与原子性</a><ul>
<li><a href="#12101">12.10.1 日志记录</a></li>
<li><a href="#12102-checkpoint">12.10.2 检查点 checkpoint</a></li>
</ul>
</li>
<li><a href="#1211">12.11 恢复算法</a></li>
<li><a href="#1212">12.12 缓冲区管理</a></li>
<li><a href="#1213-aries-recovery">12.13 ARIES recovery</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h2 id="1-introduction">1 Introduction<a class="headerlink" href="#1-introduction" title="Permanent link">&para;</a></h2>
<p>Database-management system(DBMS) </p>
<h2 id="2-relation-schema">2 Relation schema<a class="headerlink" href="#2-relation-schema" title="Permanent link">&para;</a></h2>
<p>realtion 表<br />tuple 元组<br />attribute 列<br />domain 域<br />atomic 原子的：域中的元素是不可再分单元，eg 年龄是原子的，地址不是原子的<br />null value 空值：表示值未知或不存在<br />instance 实例<br />super key 超码：一个或多个属性的集合，可以在一个关系中<strong>唯一</strong>地标识出一个元组<br />candidate key 候选码：<strong>最小的超码</strong><br />primary key(constraint) 主码：一个关系中可以区分不同元组的主要方式的候选码；应选择那些值（基本）从不变化的属性<br />foreign key：r1 引用 r2（主），r1 中每个元组对 A 的取值必须是 r2 中某个元组对 B（被引用） 的取值</p>
<ul>
<li>被引用属性（集）必须是引用关系的主码</li>
</ul>
<p>relational database schema 关系数据库架构</p>
<p>eg, <span class="arithmatex">\(Match(\underline{match\_id},location,time)\)</span></p>
<h2 id="3-sql">3 SQL<a class="headerlink" href="#3-sql" title="Permanent link">&para;</a></h2>
<p>数据定义语言 DDL<br />数据操纵语言 DML</p>
<h3 id="31">3.1 基本类型<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">char</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="cm">/*固定长度的字符串，若没满n，则补空格*/</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">varchar</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nb">int</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nb">smallint</span><span class="w"> </span><span class="cm">/*小整数*/</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nb">numeric</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">)</span><span class="cm">/*共p位，小数点左边有d位*/</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="nb">real</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div>
<h3 id="32">3.2 查询基本结构<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">select</span><span class="w"> </span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">...,</span><span class="n">An</span><span class="w"> </span><span class="err">属性</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">from</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,....,</span><span class="n">rn</span><span class="w"> </span><span class="err">关系列表</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">where</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="err">谓词</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">name</span><span class="cm">/*去重*/</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">select</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">name</span><span class="cm">/*（显式）不去重*/</span>
</code></pre></div>
<code>distinct</code> 强行去重<br /><code>all</code>（显式）不去重<br /><strong>select</strong> 子句可含有 +、-、<em>、/ 运算符<br /></em><em>where</em><em> 子句可以使用逻辑连词 and、or 和 not，也支持 between and 指定查询范围，支持比较运算符<br /></em><em>from</em>* 列出了子句上关系的笛卡尔积</p>
<p><code>as</code>重命名
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">name</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biology&#39;</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="o">#</span><span class="w"> </span><span class="err">同一张表需要在两处出现</span>
</code></pre></div></p>
<h4 id="_1">字符串运算<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p><code>upper(s)</code>大写<br /><code>lower(s)</code>小写<br /><code>trim(s)</code>去后面的空格</p>
<p><code>'Intro%'</code>匹配以 Intro 开头的字符串<br /><code>'%Comp%'</code>匹配包含 Comp 的字符串<br /><code>'___'</code>匹配任意三个字符的字符串<br /><code>'___%'</code>匹配至少含有三个字符的字符串<br /><strong>escape</strong> 定义转义字符, eg <code>like 'ab\%cd%' escape '\'</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">select</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">from</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">where</span><span class="w"> </span><span class="n">xx</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;yy%&#39;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">where</span><span class="w"> </span><span class="n">zz</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;ab\%cd%&#39;</span><span class="w"> </span><span class="k">escape</span><span class="w"> </span><span class="s1">&#39;\&#39;</span>
</code></pre></div></p>
<p><code>*</code>可以在 select 子句中表示“<strong>所有的属性</strong>”，eg <code>select instructor.*****</code>，<code>select *</code>（from 中所有关系的属性）</p>
<p><code>order by</code> 排序，desc 降序、asc 升序，eg <strong><code>order by salary desc, name asc</code></strong>，默认升序</p>
<p>where <strong>子句中可以用</strong> <code>between</code> 或者 <code>not between</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>where A.a = B.a and C = xx
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>相当于
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>where (A.a, C) = (B.a, xx)
</code></pre></div>
<h4 id="_2">集合运算<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p><strong>union </strong>将两个查询语句合并，自动去重；保留重复项用 <code>union all</code></p>
<ul>
<li>UNION和UNION ALL的ORDER BY子句要写在最后一条SELECT语句后面！</li>
</ul>
<p><strong>intersect</strong> 交运算 取交集，自动去重；保留重复项用 <code>intersect all</code></p>
<p><strong>except</strong> 差运算，输出在第一个但不在第二个的元组，保留重复项用 <code>except all</code></p>
<h4 id="_3">关于空值<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th></th>
<th>A</th>
<th>B</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>and</td>
<td>true</td>
<td>unknown</td>
<td>unknown</td>
</tr>
<tr>
<td></td>
<td>false</td>
<td>unknown</td>
<td>false</td>
</tr>
<tr>
<td></td>
<td>unknown</td>
<td>unknown</td>
<td>unknown</td>
</tr>
<tr>
<td>or</td>
<td>true</td>
<td>unknown</td>
<td>true</td>
</tr>
<tr>
<td></td>
<td>false</td>
<td>unknown</td>
<td>unknown</td>
</tr>
<tr>
<td></td>
<td>unknown</td>
<td>unknown</td>
<td>unknown</td>
</tr>
<tr>
<td>not</td>
<td>unknown</td>
<td>unknown</td>
<td>unknown</td>
</tr>
</tbody>
</table>
<p><code>is null</code>, <code>is not null</code><br /><code>is unknown</code>, <code>is not unknown</code></p>
<ul>
<li>注意：<code>null=null</code> 返回 unknown</li>
<li>Where语句中谓词unknown最终被作为false处理</li>
</ul>
<h3 id="33-aggregate-function">3.3 Aggregate function 聚集函数<a class="headerlink" href="#33-aggregate-function" title="Permanent link">&para;</a></h3>
<p><strong>avg(col)</strong> 必须数字集<br /><strong>min(col)</strong><br /><strong>max(col)</strong><br /><strong>sum(col)</strong> 必须数字集，忽略输入的 null 值<br />**count(col) **</p>
<ul>
<li><code>count(*)</code>计算一个关系中元组的数量，除了<strong>count(*) </strong>之外的聚集函数都忽略输入的 null 值</li>
<li>AVG()、MAX()、MIN()、SUM()函数忽略列值为NULL的行</li>
<li>使用COUNT(column)对特定列中具有值的行进行计数，忽略NULL值</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="n">max_salary</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">from</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">participate</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">where</span><span class="w"> </span><span class="n">pId</span><span class="o">=</span><span class="ss">&quot;p1102&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="o">#</span><span class="w"> </span><span class="err">参加</span><span class="ss">&quot;p1102&quot;</span><span class="err">项目中</span><span class="n">employee工资最大的值</span>
</code></pre></div>
<h4 id="group-by">group by 分组聚集<a class="headerlink" href="#group-by" title="Permanent link">&para;</a></h4>
<ul>
<li>任何出现在 select 中但没有被聚集（以上 5 个函数）的属性必须出现在 group by 中，否则是错误查询</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="o">#</span><span class="w"> </span><span class="err">平均工资大于</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="err">的人名并去重</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="k">from</span><span class="w"> </span><span class="n">table_name1</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">having</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span>
</code></pre></div>
<p>having 子句在 group by 后，针对 group by 每个分组，可以在 having 中使用聚集函数</p>
<ul>
<li>where 是针对 from 子句的结果关系</li>
<li>select 最后对剩下的分组得到单个结果元组</li>
</ul>
<p><strong>some() </strong>某一个；=some 等价于 in，≠some不等价于 not in<br /><strong>all() </strong>所有；≠all等价于 not in，=all 不等价于 in</p>
<p><img alt="image-20240618195519958" src="../images/image-20240618195519958.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">select</span><span class="w"> </span><span class="n">eID</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">from</span><span class="w"> </span><span class="n">participate</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eId</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">having</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="k">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="o">#</span><span class="w"> </span><span class="err">以</span><span class="mi">3</span><span class="err">种不同身份参加项目的</span><span class="n">employee</span><span class="w"> </span><span class="n">id</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="k">select</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">movie</span><span class="p">,</span><span class="k">comment</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="k">where</span><span class="w"> </span><span class="n">movie</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commment</span><span class="p">.</span><span class="n">title</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">title</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">having</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">all</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">                         </span><span class="k">from</span><span class="w"> </span><span class="n">movie</span><span class="p">,</span><span class="n">commment</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">                         </span><span class="k">where</span><span class="w"> </span><span class="n">movie</span><span class="p">.</span><span class="n">title</span><span class="o">=</span><span class="k">comment</span><span class="p">.</span><span class="n">title</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">                         </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">title</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="o">#</span><span class="w"> </span><span class="err">平均分最高的电影种类</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="k">FROM</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">B</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">branch_name</span><span class="w"> </span><span class="k">and</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">branch_city</span><span class="w"> </span><span class="o">=</span><span class="err">‘</span><span class="n">Brooklyn</span><span class="err">’</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1200</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="o">#</span><span class="w"> </span><span class="err">平均余额大于分支城市是</span><span class="n">Brooklyn的所有分支的分支名字</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="k">select</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="n">AN</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="k">from</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="k">where</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="p">(</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">B</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">branch_name</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">brantch_name</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">balance</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="o">#</span><span class="w"> </span><span class="err">每家银行余额最多的账户</span>
</code></pre></div>
<h4 id="_4">执行顺序<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>select-&gt;from-&gt;where-&gt;group by-&gt;having-&gt;select-&gt;distinct-&gt;order by</p>
<h3 id="34-nested-subqueries">3.4 Nested Subqueries 嵌套子查询<a class="headerlink" href="#34-nested-subqueries" title="Permanent link">&para;</a></h3>
<p>在where 和 from 里面</p>
<h4 id="in-not-in">in &amp; not in<a class="headerlink" href="#in-not-in" title="Permanent link">&para;</a></h4>
<p>测试资格
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">select</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">from</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">where</span><span class="w"> </span><span class="n">xx</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">yy</span><span class="p">(</span><span class="err">可以是嵌套语句）</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">customer_name</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">customer_name</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="k">FROM</span><span class="w"> </span><span class="n">borrower</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">depositor</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="exist-not-exist">exist &amp; not exist<a class="headerlink" href="#exist-not-exist" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>exist 非空时返回 true</p>
</li>
<li>
<p>关系 A 包含关系 B == <strong>not exist</strong> ( B <strong>except</strong> A )</p>
</li>
<li>for all X, P(X) == <strong>not exist</strong> X such that <strong>not</strong> P(X)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">Select</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">movie</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">Except</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">Select</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">movie</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">Where</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="w"> </span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="k">From</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="n">B</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">Where</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">title</span><span class="o">=</span><span class="n">movie</span><span class="p">.</span><span class="n">title</span><span class="w"> </span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="k">And</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">user_name</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="k">And</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">title</span><span class="o">=</span><span class="err">’</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">avenger</span><span class="err">’</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="k">And</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">grade</span><span class="w"> </span><span class="o">&lt;=</span><span class="n">B</span><span class="p">.</span><span class="n">grade</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<h4 id="unique">unique<a class="headerlink" href="#unique" title="Permanent link">&para;</a></h4>
<p>没有重复的元组 unique = true<br />如果判断元组结果为空，unique = true<br />当且仅当关系中存在两个元组 t1, t2 &amp; t1=t2，则 unique = false</p>
<h4 id="with">with<a class="headerlink" href="#with" title="Permanent link">&para;</a></h4>
<p>定义一种临时关系，只对包含 with 子句的查询有效
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">with</span><span class="w"> </span><span class="n">max_budget</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">xx</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">table1</span><span class="p">)</span><span class="w"> </span><span class="cm">/* 命名（变量名）as 一种关系 */</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">select</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">from</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="k">where</span><span class="w"> </span><span class="p">;</span>
</code></pre></div></p>
<h4 id="_5">标量子查询<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>只返回一个包含单个属性的元组</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">(</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">dept_name</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">)</span><span class="k">as</span><span class="w"> </span><span class="n">num_instructors</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="p">;</span>
</code></pre></div>
<h3 id="35">3.5 数据库创建、修改<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<h4 id="ddl">DDL 数据定义语言<a class="headerlink" href="#ddl" title="Permanent link">&para;</a></h4>
<p>Create, alter, drop table</p>
<p><strong>create &amp; drop &amp; alter</strong></p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">department</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="p">(</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="cm">/*以下是完整性约束*/</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">dept_name</span><span class="p">),</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="k">check</span><span class="p">(</span><span class="err">条件</span><span class="p">);</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="k">check</span><span class="p">()</span><span class="k">in</span><span class="p">();</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">  </span><span class="p">);</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"> </span><span class="cm">/*删除表，表没了*/</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="cm">/*删除元组，表还在*/</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="n">A</span><span class="p">;</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">MODIFY</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
sql 禁止破坏完整性的数据更新</p>
<h4 id="dml">DML 数据操作语言<a class="headerlink" href="#dml" title="Permanent link">&para;</a></h4>
<p>Select, insert, delete, update</p>
<p><strong>delete</strong></p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">r</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">where</span><span class="w"> </span><span class="n">P</span><span class="p">;</span>
</code></pre></div>
where 省略时删除所有关系中的元组，但关系还存在，只是变空了</p>
<p><strong>insert</strong></p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">table1</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="k">values</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="k">c</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">table2</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">  </span><span class="k">select</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="k">from</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">  </span><span class="k">where</span><span class="p">;</span>
</code></pre></div>
在执行插入之前执行完 select 语句很重要，否则以下会产生问题（无限插入）：
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">table1</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="p">;</span>
</code></pre></div>
插入（复制）不能是主键</p>
<p><strong>update</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">update</span><span class="w"> </span><span class="n">table1</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">set</span><span class="w"> </span><span class="n">xxx</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">where</span><span class="w"> </span><span class="n">yyy</span><span class="p">;</span>
</code></pre></div>
<h5 id="case">case<a class="headerlink" href="#case" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">update</span><span class="w"> </span><span class="n">table1</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">set</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">case</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="k">when</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="n">salary</span><span class="o">*</span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="mi">1</span><span class="p">.</span><span class="mi">03</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span><span class="k">end</span><span class="p">;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="k">select</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">简单函数</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">  </span><span class="k">when</span><span class="w"> </span><span class="p">[</span><span class="n">value1</span><span class="p">]</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="p">[</span><span class="n">result1</span><span class="p">]</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="k">default</span><span class="p">]</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w"> </span><span class="k">end</span><span class="p">;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="p">[</span><span class="n">expr</span><span class="p">]</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="p">[</span><span class="n">result1</span><span class="p">]...</span><span class="k">ELSE</span><span class="w"> </span><span class="p">[</span><span class="k">default</span><span class="p">]</span><span class="w"> </span><span class="k">END</span>
</code></pre></div>
<h4 id="dcl">DCL 数据控制语言<a class="headerlink" href="#dcl" title="Permanent link">&para;</a></h4>
<p>Grant, revoke 详见 <a href="#4.7 授权 Authorization">4.7</a></p>
<h3 id="36">3.6 形式化关系查询语言<a class="headerlink" href="#36" title="Permanent link">&para;</a></h3>
<p>选择、投影、并、交、差、笛卡尔积、重命名、自然连接、除</p>
<p><img alt="image-20240619140954313" src="../images/image-20240619140954313.png" /></p>
<p><img alt="image-20240619141017399" src="../images/image-20240619141017399.png" /></p>
<p><img src="../images/image-20240618204426768.png" alt="image-20240618204426768" style="zoom:50%;" /></p>
<p><img src="../images/image-20240618204444579.png" alt="image-20240618204444579" style="zoom:50%;" /></p>
<h2 id="4-sql-medium">4 SQL medium<a class="headerlink" href="#4-sql-medium" title="Permanent link">&para;</a></h2>
<h3 id="41-join">4.1 Join 连接<a class="headerlink" href="#41-join" title="Permanent link">&para;</a></h3>
<h4 id="natural-join">natural join<a class="headerlink" href="#natural-join" title="Permanent link">&para;</a></h4>
<p>只考虑两个关系模式中都出现的属性上取值相同的元组对<br />结果中，相同的属性排在最前（去重），然后先左边再右边的属性
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">course_id</span><span class="w"> </span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="p">,</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">各表做笛卡尔积</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">where</span><span class="w"> </span><span class="n">student</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">takes</span><span class="p">.</span><span class="n">ID</span><span class="p">;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="cm">/*相当于*/</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">course_id</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">takes</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">title</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">takes</span><span class="p">,</span><span class="w"> </span><span class="n">course</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">where</span><span class="w"> </span><span class="n">takes</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">course_id</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="cm">/*相当于*/</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">title</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="n">student</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">takes</span><span class="p">)</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">course_id</span><span class="p">);</span>
</code></pre></div></p>
<ul>
<li><strong>using</strong> 谓词可以指定属性名列表，<code>r1 join r2 using(A1, A2)</code></li>
<li><strong>on</strong> 允许在参与连接上的关系上设置通用的谓词，类似 where；用法与 using 一样，在连接表达式末尾，<code>join···on P</code>。</li>
</ul>
<p><code>select from student join takes on student.ID=takes.ID;</code><br />在很多情况下，on 可以用 where 等价替换，但它们对外连接的表现是不同的</p>
<h4 id="outer-join">outer join 外连接<a class="headerlink" href="#outer-join" title="Permanent link">&para;</a></h4>
<p>类似连接，但是结果中会创建包含空值(NULL)的元组，来保留在连接中会丢失的元组<br /><strong>左（右）外连接</strong>：只保留运算之前左（右）边关系的元组<br /><strong>全外连接（full outer join）</strong>：保留两个关系中的元组<br />eg，<code>select from student natural left outer join takes;</code></p>
<h3 id="42-views">4.2 Views 视图<a class="headerlink" href="#42-views" title="Permanent link">&para;</a></h3>
<p>一种“虚拟关系”，在概念上包含查询的结果，with 子句拓展到单个查询之外的方式</p>
<p>一种只显示数据表中部分属性值的机制：不会在数据库中创建新的表，只是隐藏了部分数据</p>
<p>优点：安全，简单易用，逻辑独立</p>
<h4 id="_6">定义视图<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p><code>create view v（视图名） as &lt;查询表达式&gt;</code></p>
<ul>
<li>一旦我们定义了一个视图，我们就可以用视图名来代指该视图所生成的虚拟关系，用在 from 子句中</li>
<li>视图与 with 语句的不同：视图一旦创建，在它被显式删除前都可用；而 with 语句对定义它的查询来说只是本地可用的</li>
</ul>
<p>视图属性名可以显示指定，下例：
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">de_total_salary</span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="n">total_salary</span><span class="p">)</span><span class="w"> </span><span class="k">as</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">将</span><span class="k">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="err">名字指定为</span><span class="n">total_salary</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
</code></pre></div>
视图可嵌套定义</p>
<h4 id="materialized-view">物化视图 Materialized view<a class="headerlink" href="#materialized-view" title="Permanent link">&para;</a></h4>
<p>定义视图的实际关系发生改变，视图也随之发生改变<br />保持物化视图一直在更新状态的过程为物化视图维护，简称视图维护（view maintenance）</p>
<h5 id="update">更新 update<a class="headerlink" href="#update" title="Permanent link">&para;</a></h5>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">faculty</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;30765&#39;</span><span class="p">,</span><span class="s1">&#39;Green&#39;</span><span class="p">,</span><span class="s1">&#39;Music&#39;</span><span class="p">);</span>
</code></pre></div>
更新可能有问题（插入的值在原来关系上是被新创建的），那么这些值将为 null 在关系表中<br />在这种情况下，通过利用空值来更新关系来得到对视图的更新是不可行的<br />sql 不推荐更新和修改<br />如果满足以下条件，视图是可更新的（插入、更新、删除）：</p>
<ul>
<li>from 子句中只要一个数据库关系（创建时只使用了一张表的数据</li>
<li>The select clause contains only attribute names of the relation and does not have any expressions, aggregates, or distinct specification.  创建时没有进行distinct和聚合操作</li>
<li>Any attribute not listed in the select clause can be set to null; that is, it does not have a not null constraint and is not part of a primary key. 没有出现空值和default</li>
<li>The query does not have a group by or having clause.</li>
</ul>
<h3 id="43-transaction">4.3 事物 transaction<a class="headerlink" href="#43-transaction" title="Permanent link">&para;</a></h3>
<p>查询或更新语句的序列组成<br />commit<br />rollback</p>
<h3 id="44-integrity-constraints">4.4 完整性约束 Integrity Constraints<a class="headerlink" href="#44-integrity-constraints" title="Permanent link">&para;</a></h3>
<p>完整性约束保证授权用户对数据库所做的更改不会导致数据一致性的丢失；而安全性约束(Security constraints) 是防止未经授权的用户访问数据库</p>
<h4 id="441">4.4.1 单关系<a class="headerlink" href="#441" title="Permanent link">&para;</a></h4>
<p>在 create table 中，<br /><code>not null</code> 非空约束，是一种域约束<br /><code>unique</code> 唯一性约束，可以为 null<br /><code>check(P)</code> 关系中的每个元组必须满足谓词 P（可以是包含子查询在内的任意谓词）；若计算结果为未知，它也是满足的</p>
<h4 id="442">4.4.2 引用完整性<a class="headerlink" href="#442" title="Permanent link">&para;</a></h4>
<p><code>foreign key(x) references y</code>或者<code>foreign key(x) references y(x)</code></p>
<p>第二种被指定的属性列表必须声明为被引用关系的超码</p>
<ul>
<li>外码必须引用一组兼容的属性，数量和数据类型必须兼容</li>
<li>可以和定义同时声明外码</li>
<li>如果一个级联的更新或删除所导致的对约束的违反不能通过进一步的级联操作来解决，那么系统就会中止该事物，修改被全部撤销</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">course</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="p">(</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">dept_name</span><span class="p">)</span><span class="k">references</span><span class="w"> </span><span class="n">department</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">cascade</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">cascade</span><span class="p">,</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="p">)</span>
</code></pre></div>
<p>级联删除<code>on delete cascade</code>：删除引用了被删除系得的元组</p>
<h4 id="443">4.4.3 给约束赋名<a class="headerlink" href="#443" title="Permanent link">&para;</a></h4>
<p>在<code>create table()</code>里命名</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">salary</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="k">constraint</span><span class="w"> </span><span class="n">minsalary</span><span class="w"> </span><span class="k">check</span><span class="p">(</span><span class="n">salary</span><span class="o">&gt;</span><span class="mi">29000</span><span class="p">)</span><span class="err">，</span>
</code></pre></div>
<p>取消约束用drop</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">constraint</span><span class="w"> </span><span class="n">minsalary</span><span class="p">;</span>
</code></pre></div>
<h4 id="444">4.4.4 断言<a class="headerlink" href="#444" title="Permanent link">&para;</a></h4>
<p>断言就是一个谓词，数据库总能满足一个条件，检测和维护的开销较高</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">create</span><span class="w"> </span><span class="k">assertion</span><span class="w"> </span><span class="o">&lt;</span><span class="k">assertion</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<h3 id="45">4.5 数据类型<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<h4 id="451">4.5.1 时间<a class="headerlink" href="#451" title="Permanent link">&para;</a></h4>
<p>时间戳timestamp</p>
<p><code>extract(field from d)</code>从date或time中提取单独的域，如year、second</p>
<h4 id="452">4.5.2 类型转换<a class="headerlink" href="#452" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">cast</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="err">将表达式</span><span class="n">e转换成t</span>
</code></pre></div>
<p>输出空值的方式</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="k">coalesce</span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">#</span><span class="err">将</span><span class="n">salary为null的项输出为0</span>
</code></pre></div>
<ul>
<li>
<p><strong>coalesce</strong>要求所有参数必须是同类型，eg 空工资不能显示为’N/A‘</p>
</li>
<li>
<p><strong>decode</strong>函数可以更改类型（在Oracle中</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">decode</span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salary</span>
</code></pre></div>
<h4 id="453-default">4.5.3 缺省值default<a class="headerlink" href="#453-default" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">student</span><span class="p">(</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="n">tot_cred</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="p">)</span>
</code></pre></div>
<h4 id="454">4.5.4 大对象<a class="headerlink" href="#454" title="Permanent link">&para;</a></h4>
<p>字符数据 <code>clob()</code></p>
<p>二进制数据 <code>blob()</code></p>
<p>获取一个定位器提取数据，而不是都放入内存中</p>
<h4 id="455">4.5.5 自定义类型<a class="headerlink" href="#455" title="Permanent link">&para;</a></h4>
<p>创建类型</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">create</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">dollar</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="o">#</span><span class="w"> </span><span class="err">定义为总共</span><span class="mi">12</span><span class="err">位的小数，两位在小数点后</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="o">#</span><span class="w"> </span><span class="n">final没有意义</span><span class="err">，有时可省</span>
</code></pre></div>
<p>创建域</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">create</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">dollar</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>域上可以申明非空或缺省值，但是自定义类型不行</li>
<li>域不是强类型的（not strongly typed），一个域类型的值可以赋值给另一个域类型</li>
</ul>
<h4 id="456">4.5.6 生成唯一码值<a class="headerlink" href="#456" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">ID</span><span class="w"> </span><span class="nb">number</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">generated</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">identity</span><span class="w"> </span><span class="o">#</span><span class="n">Oracle</span><span class="err">、</span><span class="n">DB2</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="o">#</span><span class="err">此后</span><span class="n">insert不用输ID</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="n">ID</span><span class="w"> </span><span class="nb">serial</span><span class="w"> </span><span class="o">#</span><span class="n">PostgreSQL</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">ID</span><span class="w"> </span><span class="nb">number</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">atuo_increment</span><span class="w"> </span><span class="o">#</span><span class="n">MySQL</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="n">ID</span><span class="w"> </span><span class="nb">number</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">identity</span><span class="w"> </span><span class="o">#</span><span class="n">SqlSever</span>
</code></pre></div>
<h4 id="457-createtable">4.5.7 createtable 拓展<a class="headerlink" href="#457-createtable" title="Permanent link">&para;</a></h4>
<p>创建相同模式的表</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">create</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="n">table2</span><span class="p">;</span>
</code></pre></div>
<p>创建查询结果的表</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">create</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="k">as</span><span class="p">(</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="k">select</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="k">from</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="k">where</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p">)</span><span class="k">with</span><span class="w"> </span><span class="k">data</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>与view的区别是：当表被创建时内容被加载，视图总是反应当前查询结果</li>
</ul>
<h3 id="46-index">4.6 Index 索引<a class="headerlink" href="#46-index" title="Permanent link">&para;</a></h3>
<p>索引是一种特殊的数据结构<br />创建</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">create</span><span class="w"> </span><span class="p">(</span><span class="k">unique</span><span class="p">)</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">&lt;</span><span class="err">索引名</span><span class="o">&gt;</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">&lt;</span><span class="err">关系名</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="err">属性列表</span><span class="o">&gt;</span><span class="p">);</span>
</code></pre></div>
<p>撤销</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">drop</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">&lt;</span><span class="err">索引名</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<p>重命名</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">SCno</span><span class="w"> </span><span class="k">RENAME</span><span class="w"> </span><span class="n">SCSno</span><span class="p">;</span>
</code></pre></div>
<h3 id="47-authorization">4.7 授权 Authorization<a class="headerlink" href="#47-authorization" title="Permanent link">&para;</a></h3>
<p>权限操作：选择、插入、更新、删除</p>
<h4 id="471">4.7.1 授权与收权<a class="headerlink" href="#471" title="Permanent link">&para;</a></h4>
<p>授权：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">grant</span><span class="w"> </span><span class="o">&lt;</span><span class="err">权限列表</span><span class="o">&gt;</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">on</span><span class="w"> </span><span class="o">&lt;</span><span class="err">关系名或视图名</span><span class="o">&gt;</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">to</span><span class="w"> </span><span class="o">&lt;</span><span class="err">用户</span><span class="o">/</span><span class="err">角色列表</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<p>如<code>grant select on department to Amit; grant update(budget) on departmrnt to Amit;</code></p>
<p>收权：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">revoke</span><span class="w"> </span><span class="o">&lt;</span><span class="err">权限列表</span><span class="o">&gt;</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">on</span><span class="w"> </span><span class="o">&lt;</span><span class="err">关系名或视图名</span><span class="o">&gt;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="k">to</span><span class="w"> </span><span class="o">&lt;</span><span class="err">用户</span><span class="o">/</span><span class="err">角色列表</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<p>如<code>revoke select on department to Amit; revoke update(budget) on departmrnt to Amit;</code></p>
<h4 id="472">4.7.2 角色<a class="headerlink" href="#472" title="Permanent link">&para;</a></h4>
<p><code>create role A;</code></p>
<p>一个用户/角色的权限包括：</p>
<ol>
<li>直接授予该用户/角色的所有权限；（给自己授权）</li>
<li>授予该用户/角色所拥有角色的所有权限</li>
</ol>
<ul>
<li>权限可被继承，如<code>grant A to B; grant B to C;</code>，那么C有A和B的所有权限</li>
</ul>
<h4 id="473">4.7.3 视图<a class="headerlink" href="#473" title="Permanent link">&para;</a></h4>
<h2 id="5-advanced-sql">5 Advanced SQL<a class="headerlink" href="#5-advanced-sql" title="Permanent link">&para;</a></h2>
<h3 id="51-sql">5.1 使用程序设计语言访问SQL<a class="headerlink" href="#51-sql" title="Permanent link">&para;</a></h3>
<h4 id="511-jdbc">5.1.1 JDBC<a class="headerlink" href="#511-jdbc" title="Permanent link">&para;</a></h4>
<p>动态SQL：JDBC，ODBC</p>
<p>嵌入式SQL</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">JDBCexample</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">passwd</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="p">{</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="c1">//连接</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">            </span><span class="s">&quot;jdbc:oracle:thin:@db.yale.edu:1521:univdb&quot;</span><span class="p">,</span><span class="c1">//协议 服务器主机名称 端口号 特定数据库</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">            </span><span class="n">userid</span><span class="p">,</span><span class="w"> </span><span class="c1">//数据库用户标识</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">            </span><span class="n">passwd</span><span class="p">);</span><span class="c1">//密码</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">        </span><span class="n">Statement</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">            </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">(</span><span class="c1">//执行语句</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">                </span><span class="s">&quot;insert into instructor values(’77987’,’Kim’,’Physics’,98000)&quot;</span><span class="p">);</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">SQLException</span><span class="w"> </span><span class="n">sqle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not insert tuple. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqle</span><span class="p">);</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="c1">//执行语句</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="w">            </span><span class="s">&quot;select dept name, avg (salary) &quot;</span><span class="o">+</span>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">            </span><span class="s">&quot; from instructor &quot;</span><span class="o">+</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">            </span><span class="s">&quot; group by dept name&quot;</span><span class="p">);</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rset</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="c1">//是否还存在尚未提取的元组</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rset</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;dept name&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">                               </span><span class="n">rset</span><span class="p">.</span><span class="na">getFloat</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">sqle</span><span class="p">)</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Exception : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqle</span><span class="p">);</span>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="p">}</span>
</code></pre></div>
<h5 id="prepared-statement">预备语句 prepared statement<a class="headerlink" href="#prepared-statement" title="Permanent link">&para;</a></h5>
<p>用？代替某些值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">pStmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="n">prepareStatement</span><span class="p">(</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="ss">&quot;insert into instructor values(?,?,?,?)&quot;</span><span class="p">);</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;88877&quot;</span><span class="p">);</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Perry&quot;</span><span class="p">);</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Finance&quot;</span><span class="p">);</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">setInt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">125000</span><span class="p">);</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">executeUpdate</span><span class="p">();</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;88878&quot;</span><span class="p">);</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="n">pStmt</span><span class="p">.</span><span class="n">executeUpdate</span><span class="p">();</span>
</code></pre></div>
<ul>
<li>
<p>相同的语句只用编译一次</p>
</li>
<li>
<p>预备语句可以避免SQL注入，因为输入的字符串将被插入转义字符</p>
</li>
<li>
<p>不要创建一条连接字符串的查询</p>
</li>
</ul>
<p><code>.getMetaData()</code> 在运行时从数据库系统获得所处数据的声明</p>
<p><code>.setAutoCommit(true/false)</code> 开/关自动提交</p>
<p><code>.commit()</code>事物必须显式地提交/回退</p>
<p><code>.rollback()</code></p>
<h4 id="512-odbc">5.1.2 ODBC<a class="headerlink" href="#512-odbc" title="Permanent link">&para;</a></h4>
<p>open data connectivity</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">void</span><span class="w"> </span><span class="n">ODBCexample</span><span class="p">()</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="err">{</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">    </span><span class="n">RETCODE</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span><span class="n">HENV</span><span class="w"> </span><span class="n">env</span><span class="p">;</span><span class="w"> </span><span class="cm">/* environment */</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span><span class="n">HDBC</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w"> </span><span class="cm">/* database connection */</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span><span class="n">SQLAllocEnv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">);</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span><span class="n">SQLAllocConnect</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conn</span><span class="p">);</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">    </span><span class="n">SQLConnect</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;db.yale.edu&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">NTS</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;avi&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">NTS</span><span class="w"> </span><span class="p">,</span><span class="ss">&quot;avipasswd&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">NTS</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="err">{</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="nb">char</span><span class="w"> </span><span class="n">deptname</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">    </span><span class="nb">float</span><span class="w"> </span><span class="n">salary</span><span class="p">;</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">    </span><span class="nb">int</span><span class="w"> </span><span class="n">lenOut1</span><span class="p">,</span><span class="w"> </span><span class="n">lenOut2</span><span class="p">;</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">    </span><span class="n">HSTMT</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">    </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqlquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;select dept name, sum (salary)</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="ss">from instructor group by dept name&quot;</span><span class="p">;</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">    </span><span class="n">SQLAllocStmt</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stmt</span><span class="p">);</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SQLExecDirect</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="n">sqlquery</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">NTS</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">SUCCESS</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">        </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="k">C</span><span class="w"> </span><span class="nb">CHAR</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deptname</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut1</span><span class="p">);</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">        </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="k">C</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut2</span><span class="p">);</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="w">        </span><span class="n">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">SQLFetch</span><span class="w"> </span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">SUCCESS</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">            </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot; %s %g∖n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">deptname</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">);</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="w">        </span><span class="err">}</span>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="w">    </span><span class="n">SQLFreeStmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="err">}</span>
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="w">    </span><span class="n">SQLDisconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">    </span><span class="n">SQLFreeConnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">    </span><span class="n">SQLFreeEnv</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="err">}</span>
</code></pre></div>
<h4 id="sql">嵌入式SQL<a class="headerlink" href="#sql" title="Permanent link">&para;</a></h4>
<p><code>EXEC SQL &lt;嵌入式SQL语句&gt; END_EXEC;</code> 识别嵌入sql请求</p>
<p>可使用宿主语言host language的变量，需在变量名前加上<strong>:</strong></p>
<p>遍历一个嵌入式sql的查询结果，声明一个游标变量(cursor)，<code>declare c cursor for &lt;SQL query&gt;</code></p>
<p><code>EXEC SQL open c;</code> open 执行语句并将结果存在一个临时关系中</p>
<p><code>EXEC SQL fetch c into :si, :sn</code> fetch 在查询结果中一个元组的值放在宿主语言变量中</p>
<p>如何更新：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">EXEC</span><span class="w"> </span><span class="k">SQL</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="k">declare</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="n">curor</span><span class="w"> </span><span class="k">for</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="k">select</span><span class="o">*</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="o">=</span><span class="s1">&#39;Music&#39;</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">update</span>
</code></pre></div>
<h3 id="52">5.2 函数与过程<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<h4 id="521">5.2.1 函数<a class="headerlink" href="#521" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">create</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">dept_count</span><span class="p">(</span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="k">returns</span><span class="w"> </span><span class="nb">integer</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="k">begin</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="k">declare</span><span class="w"> </span><span class="n">d_count</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">d_count</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">dept_name</span><span class="o">=</span><span class="w"> </span><span class="n">dept_name</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">d_count</span><span class="p">;</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="k">end</span>
</code></pre></div>
<p>​   使用方法：<code>dept_count(dept_name)</code></p>
<p><strong>表函数（table function）</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">create</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">(</span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="k">returns</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="n">ID</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="nb">numeric</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="k">return</span><span class="w"> </span><span class="k">table</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">of</span><span class="p">.</span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
</code></pre></div>
<p>​   使用方法：<code>select * from table(instructor_of('Finance'));</code></p>
<h4 id="522-procedures">5.2.2 过程 procedures<a class="headerlink" href="#522-procedures" title="Permanent link">&para;</a></h4>
<p>以上dept_count也可以写成一个过程：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">dept_count_proc</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="k">out</span><span class="w"> </span><span class="n">d_count</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="k">begin</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">d_count</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">dept_name</span><span class="o">=</span><span class="w"> </span><span class="n">dept_count_proc</span><span class="p">.</span><span class="n">dept_name</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="k">end</span>
</code></pre></div>
<p>​   in 待赋值的参数；out 返回结果参数</p>
<p>​   使用方式：<code>declare d_count integer; call dept_count_proc('Physics',d_count);</code></p>
<h5 id="while-and-repeat-statements">while and repeat statements<a class="headerlink" href="#while-and-repeat-statements" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">while</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="n">sequence</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">statements</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="k">end</span><span class="w"> </span><span class="n">while</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="n">repeat</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="n">sequence</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">statements</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="k">until</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="k">end</span><span class="w"> </span><span class="n">repeat</span>
</code></pre></div>
<h5 id="loop">loop<a class="headerlink" href="#loop" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">declare</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">budget</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">department</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Music&#39;</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="k">do</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">budget</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="k">end</span><span class="w"> </span><span class="k">for</span>
</code></pre></div>
<h5 id="if-then-else">if-then-else<a class="headerlink" href="#if-then-else" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">if</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="k">then</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">elseif</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="k">then</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="k">else</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="k">end</span><span class="w"> </span><span class="k">if</span>
</code></pre></div>
<h3 id="53-trigger">5.3 Trigger 触发器<a class="headerlink" href="#53-trigger" title="Permanent link">&para;</a></h3>
<p>只要发生特定的事件并且满足相应的条件，数据库系统自动执行</p>
<p>可用来实行特殊的完整性约束</p>
<p>以下展示触发器确保section关系的time_slot_id属性上的引用完整性</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">create</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">timeslot</span><span class="w"> </span><span class="n">check1</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">插入后启动</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">referencing</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">创建了一个过渡变量</span><span class="n">nrow</span><span class="err">，用来存储所插入行的值（除了插入还可以用来更新</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">显式地在被插入每一行上迭代</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">nrow</span><span class="p">.</span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">when指定条件</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="p">))</span><span class="w"> </span><span class="cm">/* time slot id not present in time slot */</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="k">begin</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="k">rollback</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="k">end</span><span class="p">;</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="k">create</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">timeslot</span><span class="w"> </span><span class="n">check2</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">timeslot</span><span class="w"> </span><span class="o">#</span><span class="err">删除后</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="k">referencing</span><span class="w"> </span><span class="k">old</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">orow</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">创建一个变量存储已更新或删除的行的值</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">row</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">orow</span><span class="p">.</span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="p">)</span><span class="w"> </span><span class="cm">/* last tuple for time slot id deleted from time slot */</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">      </span><span class="k">and</span><span class="w"> </span><span class="n">orow</span><span class="p">.</span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">          </span><span class="k">select</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">id</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="p">))</span><span class="w"> </span><span class="cm">/* and time slot id still referenced from section*/</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="k">begin</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="k">rollback</span>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="k">end</span><span class="p">;</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">automic</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sql语句</span><span class="o">&gt;</span><span class="w"> </span><span class="k">end</span><span class="p">;</span>
</code></pre></div>
<h2 id="6-e-r">6 E-R 模型的数据库设计<a class="headerlink" href="#6-e-r" title="Permanent link">&para;</a></h2>
<p>实体-联系模型</p>
<h3 id="61">6.1 设计<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<p>E-R模型由实体entities和关系relation组成
• 实体：用于区分其他种类的物体
• 可以是具体的货抽象的
• 拥有自身的属性
• 关系：实体之间的联系
• 一对一、一对多、多对多</p>
<h3 id="62">6.2 实体和联系<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<p>实体(entity)：可区别于其他对象的“事物”或“对象”；例如，人、课程</p>
<p>实体集(entity set)：共享相同性质、具有相同类型的实体的集合</p>
<ul>
<li>实体集是矩形，属性是由直线连接的椭圆形</li>
<li><img src="../images/image-20240618210650947.png" alt="image-20240618210650947" style="zoom:50%;" /></li>
</ul>
<p>联系(relationship)：多个实体之间相互关联</p>
<p>联系集(relationship set)：相同类型联系的集合</p>
<ul>
<li><strong>联系集</strong>在E-R图中用<strong>菱形</strong>表示，菱形通过<strong>线条</strong>连接都多个不同的<strong>实体集</strong>（<strong>矩形</strong>）</li>
</ul>
<p><img src="./../images/image-20240328111049334.png" alt="image-20240328111049334" style="zoom:33%;" /></p>
<ul>
<li>联系集的<strong>度</strong>(degree)：参与联系集的实体集的数目（二元联系集的度为2）</li>
<li>联系集的<strong>属性</strong>是未分割的矩阵，用<strong>虚线与联系集的菱形相连</strong></li>
<li>联系集仅显示在一个位置，但实体集可以在不止一个位置重复出现</li>
</ul>
<h3 id="63">6.3 复杂属性<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>域/值集：属性可以取值的集合</p>
</li>
<li>
<p>简单属性不能被划分成子部分；复合(composite)属性可以划分，如name包括first name,last name</p>
</li>
<li>
<p>单值single-valued属性：属性对一个特定实体只有一个单独的值（如学生的ID）；多值 mutivalued属性：对应于一组值（教师的电话号码{phone_num}）</p>
</li>
<li>
<p>派生属性derived：不存储它的值，只在需要的时候计算出来</p>
</li>
</ul>
<h3 id="64">6.4 映射基数<a class="headerlink" href="#64" title="Permanent link">&para;</a></h3>
<p>映射基数(mapping cardinality)：一个实体额能通过一个联系集关联领一些实体的数量</p>
<p>联系集和实体集之间：</p>
<ul>
<li>
<p><strong>有向线段→</strong>指向”一“的一侧，<strong>无向线段–</strong> 指向”多“的一侧</p>
</li>
<li>
<p><strong>双线</strong>表示一个实体在联系集中全部参与</p>
</li>
</ul>
<p>全部参与：一个实体集E中的每一个实体都参与到联系集R的至少一个联系中，否则就是部分参与</p>
<p><code>l..h</code>：l表示最小基数，h表示最大基数</p>
<p><img src="../images/image-20240415112629928.png" alt="image-20240415112629928" style="zoom:50%;" /></p>
<p>​   一位教师可以有0或多名学生，每名学生必须有且只有一位导师</p>
<h3 id="65">6.5 主码<a class="headerlink" href="#65" title="Permanent link">&para;</a></h3>
<h4 id="651-r">6.5.1 联系集R的主码<a class="headerlink" href="#651-r" title="Permanent link">&para;</a></h4>
<p>联系集R的主码：实体集的<span class="arithmatex">\(primary-key(E_i)\)</span> 的集合，也是超码</p>
<p>若有属性，实体集的<span class="arithmatex">\(primary-key(E_i)\)</span> 的集合再并上属性能构成联系集R中一个单独的联系</p>
<p>我们至多允许一个箭头从一个非二元的联系集指出</p>
<h4 id="652">6.5.2 弱实体集<a class="headerlink" href="#652" title="Permanent link">&para;</a></h4>
<p>弱实体集(weak entity set)的存在依赖于另一个标识性实体集(indentifying entity set)；我们使用标识性实体集的<em>主码</em>和<em>分辨符属性</em>(discriminator attribute)来唯一地标识弱实体。</p>
<p>每一个弱实体必须和一个标识性实体相关联，它们的相关联关系被称为标识性联系(identifying relationship)</p>
<ul>
<li><strong>双边框的矩形</strong>描述弱实体集，其分辨符被加上<strong>虚的下划线</strong></li>
<li>关联弱实体集和标识性强实体集的联系集以<strong>双边框的菱形</strong>表示</li>
</ul>
<h3 id="66">6.6 删除冗余属性<a class="headerlink" href="#66" title="Permanent link">&para;</a></h3>
<h3 id="67-e-r">6.7 将E-R图转换成关系模式<a class="headerlink" href="#67-e-r" title="Permanent link">&para;</a></h3>
<h3 id="68">6.8 拓展<a class="headerlink" href="#68" title="Permanent link">&para;</a></h3>
<h4 id="681">6.8.1 特化<a class="headerlink" href="#681" title="Permanent link">&para;</a></h4>
<p>在实体集内部进行分组的过程称为<strong>特化(specialization)</strong></p>
<ul>
<li>特化用从特化实体指向另一方实体的<strong>空心箭头</strong>来表示</li>
</ul>
<p>重叠(overlapping)特化：一个实体可以属于多个特化实体集</p>
<p>不相交(disjoint)特化：一个实体属于至多一个特化实体集</p>
<ul>
<li>特化联系还可以被称作超类-子类联系(superclass-subclass)</li>
</ul>
<h4 id="682">6.8.2 概化<a class="headerlink" href="#682" title="Permanent link">&para;</a></h4>
<h4 id="685">6.8.5 聚集<a class="headerlink" href="#685" title="Permanent link">&para;</a></h4>
<p>聚集(aggregation)是一种抽象</p>
<h4 id="69">6.9 问题<a class="headerlink" href="#69" title="Permanent link">&para;</a></h4>
<h2 id="-">- 联系集中已经隐含相关实体集主码属性了，不能再将它们作为联系集的属性<a class="headerlink" href="#-" title="Permanent link">&para;</a></h2>
<h2 id="7">7 关系数据库设计<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 好的设计关系的特点<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<h4 id="711">7.1.1 分解<a class="headerlink" href="#711" title="Permanent link">&para;</a></h4>
<p>无损分解lossless decomposition：如果用两个关系模式R1和R2去替代R时没有信息丢失，则该分解是一个无损分解。</p>
<h4 id="712">7.1.2 规范化理论<a class="headerlink" href="#712" title="Permanent link">&para;</a></h4>
<h3 id="72">7.2 使用函数依赖进行分解<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<h4 id="721">7.2.1 符号<a class="headerlink" href="#721" title="Permanent link">&para;</a></h4>
<p>属性集：<span class="arithmatex">\(\alpha\)</span></p>
<p><span class="arithmatex">\(r(R)\)</span>​：具有模式R的关系r</p>
<p>K：R的一个超码</p>
<p>函数依赖：<img src="../images/image-20240418101657389.png" alt="image-20240418101657389" style="zoom:33%;" /></p>
<p>如果<span class="arithmatex">\(R_1∩R_2\)</span> 构成<span class="arithmatex">\(R_1\)</span> 或<span class="arithmatex">\(R_2\)</span>​​ 的超码，那么R的该分解就是一个无损分解。</p>
<h4 id="722">7.2.2  函数依赖<a class="headerlink" href="#722" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\(F^{+}\)</span>表示集合F的闭包，即能从给定的集合F 推导出所有函数依赖的集合，<span class="arithmatex">\(F^{+}\)</span>​包含所有的函数依赖</p>
<p><strong>平凡trivial函数依赖</strong>：函数依赖被所有关系满足。一般来说，如果β ⊆ α，则形如α → β的函数依赖是平凡的</p>
<p><img alt="image-20240618211157918" src="../images/image-20240618211157918.png" /></p>
<h4 id="723">7.2.3 无损分解<a class="headerlink" href="#723" title="Permanent link">&para;</a></h4>
<p>有损分解：不能用分解后的几个关系重建原本的关系</p>
<p>无损分解：R分解为（R1，R2）并且R= R1∪R2</p>
<p>无损分解判定方法：</p>
<ul>
<li>当且仅当<span class="arithmatex">\(R_1∩R_2→R_1\)</span> or <span class="arithmatex">\(R_1∩R_2→R_2\)</span> ，或者说<span class="arithmatex">\(R_1∩R_2\)</span>要么构成R1的超码要么构成R2的超码</li>
</ul>
<h5 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h5>
<p><em>For the relation schema R(A, B, C, D) with the functional dependencies set F={A→B, B→CD}.</em>
<em>1)List all candidate keys of the relation.</em>
<em>2)Decompose the relation into a collection of BCNF relations. The decomposition must be lossless-join.</em></p>
<p>1) A是候选码</p>
<p>2) R还不是BCNF，因为存在一条非平凡的函数依赖B→CD，它的左边不是key。
3) R1={B, C, D}, R2={A, B}. F1={B-&gt;CD}, F2={A-&gt;B}。 R1∩R2=(B), B是R1的候选码，所以分解是无损的。</p>
<h3 id="73">7.3 范式<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<h4 id="731-bcnfboyce-codd-normal-form">7.3.1 BCNF(Boyce-Codd Normal Form)<a class="headerlink" href="#731-bcnfboyce-codd-normal-form" title="Permanent link">&para;</a></h4>
<h5 id="bcnf">BCNF 定义<a class="headerlink" href="#bcnf" title="Permanent link">&para;</a></h5>
<p>A relation schema R is in BCNF with respect to a set F of functional dependencies if, for all functional dependencies in <span class="arithmatex">\(F^+\)</span> of the form α → β, where α ⊆ R and β ⊆ R, at least one of the following holds 闭包F^+^中的<strong>所有函数依赖</strong>α → β<strong>至少</strong>满足下面一条：</p>
<ul>
<li>α → β is a trivial functional dependency 平凡函数依赖(即 β ⊆ α).</li>
<li>α is a superkey超码 for schema 关系模式R，即α → R</li>
</ul>
<p><em>没有函数依赖也是BC范式（F是空的）</em></p>
<p>算法：如果左边(α)和右边(β)有公共属性，把右边的公共属性去掉；</p>
<p><img src="../images/image-20240422091745854.png" alt="image-20240422091745854" style="zoom:50%;" /></p>
<p><strong>依赖保持dependency preserving</strong>：如果通过检验单一关系上的函数依赖，就能确保所有的函数依赖成立，那么这样的分解时依赖保持的；或者原来关系R上的每一个函数依赖，都可以在分解后的单一关系上得到检验或者推导得到。</p>
<p><img src="../images/image-20240422163022929.png" alt="image-20240422163022929" style="zoom:50%;" /></p>
<p>令<span class="arithmatex">\(F_1∪F_2∪……∪F_n=F'\)</span>, <span class="arithmatex">\(F'^+=F^+\)</span>的分解为<strong>保持依赖的分解</strong>(dependency-preserving decomposition)</p>
<p>BCNF和函数依赖可能不能同时满足，所以出现了第三范式——放松了对非平凡函数依赖左边必须是超码的约束。</p>
<h5 id="bcnf_1">BCNF检测<a class="headerlink" href="#bcnf_1" title="Permanent link">&para;</a></h5>
<ol>
<li>
<p>检查一个<strong>非平凡</strong>的函数依赖<code>α → β</code>是否违反BCNF：计算<span class="arithmatex">\(\alpha^+\)</span>（α的属性闭包）检查它是否包含R中的所有属性（是否是R的一个超码）；如果是，则满足BCNF</p>
</li>
<li>
<p>检查一个关系模式R知否属于BCNF：检查给定集合F中的依赖是否违反</p>
</li>
<li>
<p>检查R上的一个分解模式<span class="arithmatex">\(R_i\)</span>是否违反BCNF：
   - 检查给定集合中<span class="arithmatex">\(F^+\)</span>中的依赖是否违反
   - 对于<span class="arithmatex">\(R_i\)</span>中属性的每个子集<span class="arithmatex">\(\alpha\)</span>，检查<span class="arithmatex">\(\alpha^+\)</span>，要么不包含<span class="arithmatex">\(R_i-\alpha\)</span>的任何属性，要么包含<span class="arithmatex">\(R_i\)</span>的所有属性；如果<span class="arithmatex">\(R_i\)</span>中某个属性集<span class="arithmatex">\(\alpha\)</span>违反了该条件，则<span class="arithmatex">\(\alpha → (\alpha^+-\alpha)∩R_i\)</span>这个函数依赖说明<span class="arithmatex">\(R_i\)</span>违反了BCNF</p>
</li>
</ol>
<ul>
<li>如果F中没有依赖违法BCNF，则在<span class="arithmatex">\(F^+\)</span>​中也不会有依赖违反BCNF</li>
</ul>
<h5 id="example1">Example1<a class="headerlink" href="#example1" title="Permanent link">&para;</a></h5>
<p>R=(A,B,C), F={A-&gt;B, B-&gt;C}, KEY={A}</p>
<p>R不是BCNF，因为B不是key，但可以通过分解R使之满足BCNF<img alt="image-20240618213324084" src="../images/image-20240618213324084.png" /></p>
<h5 id="example2">Example2<a class="headerlink" href="#example2" title="Permanent link">&para;</a></h5>
<p><em>Decomposition R1=(A, B), R2 =(A, C)</em></p>
<ol>
<li>F1=(A→B}，F2={A→C)</li>
<li>R1 and R2 in BCNF</li>
<li>Lossless-join decomposition</li>
<li>Not dependency preserving, since <span class="arithmatex">\((F1 ∪F2)^+&lt;&gt; F^+\)</span>​ </li>
</ol>
<h5 id="example3">Example3<a class="headerlink" href="#example3" title="Permanent link">&para;</a></h5>
<p>R=(A,B,C), F={A-&gt;B,B-&gt;C) 无损分解</p>
<p><img alt="image-20240618212324239" src="../images/image-20240618212324239.png" /><img alt="image-20240618212339084" src="../images/image-20240618212339084.png" /></p>
<h4 id="732-3nf">7.3.2 第三范式 3NF<a class="headerlink" href="#732-3nf" title="Permanent link">&para;</a></h4>
<p>定义：对<span class="arithmatex">\(F^+\)</span> 中形如 α → β的函数依赖, where α ⊆ R and β ⊆ R, at least one of the following holds:</p>
<ul>
<li>α → β is a trivial functional dependency 平凡函数依赖(即 β ⊆ α).</li>
<li>α is a superkey超码 for schema R</li>
<li>β-α中的每个属性A都被包含在R的一个候选码中（不是单个候选码必须包含β-α的所有属性，属性可以被包含在不同候选码中）</li>
</ul>
<p>BCNF一定是3NF，实际上3NF是为了保证独立性保护的BCNF</p>
<p>3NF有冗余，某些情况需要设置一些空值</p>
<p>3NF要求消除非主属性对主键的传递依赖</p>
<h5 id="3nf">3NF判定<a class="headerlink" href="#3nf" title="Permanent link">&para;</a></h5>
<p>不需要判断闭包中的所有函数依赖,只需要对已有的F中的所有函数依赖进行判断</p>
<p>用闭包可以检查α→β中的a是不是超键；如果不是，就需要检查β中的每一个属性包含在R的候选键中</p>
<h3 id="74">7.4 函数依赖理论<a class="headerlink" href="#74" title="Permanent link">&para;</a></h3>
<h4 id="741">7.4.1 函数依赖的闭包<a class="headerlink" href="#741" title="Permanent link">&para;</a></h4>
<div class="arithmatex">\[\alpha\beta=\alpha∪\beta\]</div>
<p><strong>阿姆斯特朗公理</strong> Armstrong's axiom：用来寻找被逻辑蕴含的函数依赖</p>
<p><img src="../images/image-20240421170133734.png" alt="image-20240421170133734" style="zoom:40%;" /><img src="../images/image-20240421171748126.png" alt="image-20240421171748126" style="zoom: 33%;" /></p>
<h4 id="742">7.4.2 属性集的闭包<a class="headerlink" href="#742" title="Permanent link">&para;</a></h4>
<p>令<span class="arithmatex">\(\alpha\)</span>为一个属性集，如果<span class="arithmatex">\(\alpha\)</span>的闭包<span class="arithmatex">\(\alpha^+\)</span>里包含R中所有属性，则<span class="arithmatex">\(\alpha\)</span>​为超码（画有向图）</p>
<h5 id="_7">用途（为什么计算属性闭包？）<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h5>
<ol>
<li>判断<span class="arithmatex">\(\alpha\)</span>是不是超码（主键）：计算<span class="arithmatex">\(\alpha^+\)</span>，检查其是否包含R中的所有属性；如果a的闭包包含了所有属性，则a是主键</li>
<li>检查函数依赖α → β是否成立（属于<span class="arithmatex">\(F^+\)</span>）：计算<span class="arithmatex">\(\alpha^+\)</span>，检查它是否包含<span class="arithmatex">\(\beta\)</span></li>
<li>计算函数依赖闭包F+，以得到整个关系模式的闭包</li>
</ol>
<h4 id="743-canonical-cover">7.4.3 正则覆盖 Canonical cover<a class="headerlink" href="#743-canonical-cover" title="Permanent link">&para;</a></h4>
<p>正则覆盖是函数依赖关系的最小集合，非正则覆盖的的产生主要是因为有了无关属性</p>
<p><strong>无关属性</strong> extraneous：去除也不改变该函数依赖集的闭包</p>
<p><img alt="image-20240618212622526" src="../images/image-20240618212622526.png" /></p>
<p>从右侧移除一个属性可以使之变成更强的约束：If A ∈ β, to check if A is extraneous, consider the set <code>F′ = (F−{α→β}) ∪ {α→(β−A)}</code>and check if α → A can be inferred from F ′. To do so, compute α+ (the closure of α) under F ′; if α+ includes A, then A is extraneous in β.</p>
<p>从左侧移除一个属性可以使之变成更弱的约束：To test if attribute A∈a is extraneous in a. Let <code>y=a-{A}</code>. Check if y→β can be inferred from F. Compute y<em> using the dependencies in F. If y</em> includes all attributes in β then, A is extraneous in a.</p>
<p><img alt="image-20240618212805358" src="../images/image-20240618212805358.png" /></p>
<h5 id="f_c">正则覆盖<span class="arithmatex">\(F_c\)</span>​​的性质<a class="headerlink" href="#f_c" title="Permanent link">&para;</a></h5>
<ul>
<li><span class="arithmatex">\(F\)</span>和<span class="arithmatex">\(F_c\)</span>互相逻辑蕴含对面</li>
<li><span class="arithmatex">\(F_c\)</span>中的任何函数依赖都不包含无关属性</li>
<li><span class="arithmatex">\(F_c\)</span>中每个函数依赖的左侧都是唯一的，eg 不存在两个依赖关系<span class="arithmatex">\(\alpha_1→\beta_1\)</span>和<span class="arithmatex">\(\alpha_2→\beta_2\)</span>，满足<span class="arithmatex">\(\alpha_1=\alpha_2\)</span>​</li>
</ul>
<p>正则覆盖不一定唯一</p>
<h5 id="example_1">Example<a class="headerlink" href="#example_1" title="Permanent link">&para;</a></h5>
<ol>
<li>
<p>假定F包含 AB → CD, A → E, E → C。为了检验 C 在 AB → CD中是否是无关的，计算F ′ = {AB → D, A → E, E → C}下AB 的属性闭包 。该闭包为ABCDE，包含CD，所以C是无关的。</p>
</li>
<li>
<p>关系R(A, B, C, D, E), F={B → A, A → B, AB → C, B→C, CD→E}。</p>
</li>
</ol>
<p>则正则覆盖为：{ A → B, B → AC, B→C, CD→E}；候选码为AD、BD；R不是BCNF， A → B, A不是key</p>
<p>可BCNF无损分解为：R1(C, D, E), F1={CD→E}，R2(B, C), F2={B→C}，R3(A, B), F3={A→B, B→A}，R4(A,D), F4={A→D}，也是依赖保持的；</p>
<p>或者分解为：R1(B, C), F1={B→C}，R2(A, B), F2={A→B, B→A}，R3(A,D,E), F3={AD→E}，不是依赖保持的无法检验CD→E；</p>
<p>或者分解为：R1(A B), F1={A→B, B→A}，R2(C, D, E), F2={CD→E}，R3(A,C,D), F3={AD→C}，不是依赖保持的，闭包≠原来的，把R3继续分解成R3(A, C), F3={A→C}，R4(A, D), F2={A→D}，依赖保持（不能单独检验但F并起来可以检验）</p>
<p>分解从叶子（末尾）更可能保持依赖</p>
<p><img src="../images/image-20240515232527840.png" alt="image-20240515232527840" style="zoom:50%;" /></p>
<h3 id="76">7.6 使用多值依赖的分解<a class="headerlink" href="#76" title="Permanent link">&para;</a></h3>
<h4 id="761">7.6.1 多值依赖<a class="headerlink" href="#761" title="Permanent link">&para;</a></h4>
<p>多值依赖又称为元组产生依赖</p>
<p>多值依赖 α →→ β：α和β之间的联系独立于 α 和 R-β 之间的联系。若模式R上所有关系都满足多值依赖α →→ β，则α →→ β在模式R上是<strong>平凡的多值依赖</strong>，即  β ⊆ α 或 α∩β=R，则 α →→ β 是平凡的</p>
<p>eg，一位教师与其地址的联系独立于该教师与系之间的联系</p>
<ul>
<li>若α → β，则 α →→ β，即每一个函数依赖也是一个多值依赖</li>
<li>若α →→ β，则 α →→ R- α -β</li>
</ul>
<h4 id="762">7.6.2 第四范式<a class="headerlink" href="#762" title="Permanent link">&para;</a></h4>
<p>定义：对于 <span class="arithmatex">\(D^+\)</span> 中所有形如 α →→ β的多值依赖，其中 α ⊆ R and β ⊆ R，至少有一下之一成立：</p>
<ul>
<li>α →→ β 是一个平凡的多值依赖</li>
<li>α 是 R的一个超码</li>
</ul>
<p>每个4NF都属于BCNF</p>
<h4 id="763-4nf">7.6.3 4NF分解<a class="headerlink" href="#763-4nf" title="Permanent link">&para;</a></h4>
<p>令r(R)是一个关系模式，D为R上的函数依赖和多值依赖的集合。令r1(R1)、r2(R2)为一个分解，当且仅当以下的多值依赖至少有一个属于<span class="arithmatex">\(D^+\)</span>，这个分解是R的无损分解：</p>
<ul>
<li>R1∩R2→→ R1</li>
<li>R1∩R2→→ R2</li>
</ul>
<h5 id="example_2">Example<a class="headerlink" href="#example_2" title="Permanent link">&para;</a></h5>
<p><img alt="image-20240518152501514" src="../images/image-20240518152501514.png" /></p>
<p><img alt="image-20240518154733998" src="../images/image-20240518154733998.png" /></p>
<h3 id="77">7.7 第一范式<a class="headerlink" href="#77" title="Permanent link">&para;</a></h3>
<p>如果一个域的元素被认为是不可再分的单元，则称这个域是原子的（atomic）。如果一个关系模式R的所有属性的域都是原子的，则称R属于<strong>第一范式</strong>。</p>
<p>eg，如果职员的编号组成为“系+号码”（CS0010），则这个属性不是原子的，即该关系模式非第一范式</p>
<ul>
<li>在任何关系数据库中，第一范式都是最基本的要求</li>
<li>第一范式不足：数据冗余、更新数据复杂、插入和删除数据异常</li>
</ul>
<h3 id="questions">Questions<a class="headerlink" href="#questions" title="Permanent link">&para;</a></h3>
<ol>
<li>For a database table, which description is <strong>correct</strong>?  </li>
</ol>
<p><strong>A</strong>. <em>First Normal Form (lNF) requires that each column in the table has atomicity</em> </p>
<p>B. Second Normal Form (2NF) requires that each column in the table is not null </p>
<p>C. Third Normal Form (3NF) requires that each column in the table has uniqueness. </p>
<p>D. Bovce-Codd Normal Form (BCNF) requires that each column in the table is a primary key.</p>
<blockquote>
<ul>
<li>
<p><strong>Third Normal Form (3NF):</strong> A table is in 3NF if it is in 2NF and all the columns are mutually independent except for the primary key dependencies. That means there should be <strong>no transitive dependency</strong> for non-prime attributes as part of another non-prime attribute.</p>
</li>
<li>
<p><strong>Boyce-Codd Normal Form (BCNF):</strong> A stronger version of the 3NF, BCNF is reached when, for every one of its dependencies, the left side is a super key, which is a key that uniquely identifies a row.</p>
</li>
</ul>
</blockquote>
<ol start="2">
<li>For relation schema R(A,B,C,D)with functional dependencies set F={A→C, C→A, AB→CD, BC→AD). 
   1) Find all candidate keys of R. 
   2) Is R in BCNF? Explain the reason.</li>
</ol>
<blockquote>
<ol>
<li>AB, BC</li>
<li>Since there are dependencies (A→C and C→A) where the left-hand side is not a superkey, <strong>R is not in BCNF</strong></li>
</ol>
</blockquote>
<ol start="3">
<li><img alt="微信图片_20240526163330" src="../images/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240526163330.jpg" /></li>
</ol>
<blockquote>
<p>a. Functional Dependencies:</p>
<p>From the table structure and description, we can identify the following functional dependencies:</p>
<ol>
<li>branchID → addressInformation, mgrStaffID, name
   - Since each branchID is unique and identifies a specific branch with its address and manager.</li>
<li>mgrStaffID → name
   - Each manager’s ID identifies a unique manager, and therefore, a unique name.</li>
</ol>
<p>Why this table is not in 3NF:</p>
<p>The table is not in Third Normal Form (3NF) because it violates the rule that every non-key attribute must depend only on the primary key. Here:</p>
<ul>
<li>The non-key attribute <code>name</code> depends on <code>mgrStaffID</code>, which is not part of the primary key (<code>branchID</code>). This dependency creates a transitive dependency (a 3NF violation) as <code>name</code> is dependent on <code>mgrStaffID</code> which in turn depends on <code>branchID</code>.</li>
</ul>
<p>b. Normalization to Third Normal Form (3NF):</p>
<p>Decompose to remove transitive dependencies to make all attributes depend only on the primary key.</p>
<ul>
<li><strong>Table 1 (BranchTable):</strong></li>
<li><strong>branchID</strong>: Primary Key</li>
<li><strong>addressInformation</strong></li>
<li><strong>mgrStaffID</strong>: Foreign Key referencing ManagerTable</li>
<li><strong>Table 2 (ManagerTable):</strong></li>
<li><strong>mgrStaffID</strong>: Primary Key</li>
<li><strong>name</strong></li>
</ul>
<p>c. Primary Key and Foreign Keys in the 3NF Relations:</p>
<p>as b is showed abo</p>
</blockquote>
<h2 id="8">8 存储管理<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 物理存储概述<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<p><img src="../images/image-20240505135247810.png" alt="image-20240505135247810" style="zoom: 40%;" /></p>
<p>高速缓存cache：最快最昂贵
主存 main memory
闪存 flash
磁盘magnetic disk：磁盘读写慢是因为它是机械运动；写比读慢，因为要检查校验位
光学存储器 optical：DVD
磁带/磁盘存储器 magnetic tapes</p>
<p>磁带储存器被称为顺序访问：</p>
<ul>
<li>顺序访问(sequantial access)模式：连续的请求会请求处于相邻的磁道或者相邻的磁道上连续的块。顺序访问中只有读取第一个块时需要寻道，后续的请求不需要寻道。</li>
</ul>
<p>磁盘和SSD存储器被称为随机访问：</p>
<ul>
<li>随机访问模式(random access)模式：相继的请求会请求那些随机位于磁盘上的块，每一次请求都需要一次磁盘寻道。一张磁盘在每秒能够满足的随机块访问的数量取决于寻道时间</li>
</ul>
<p>磁盘和高速缓存的速度差大约7个数量级</p>
<p><img alt="image-20240618214456461" src="../images/image-20240618214456461.png" /></p>
<h3 id="82">8.2 磁盘<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<p>磁盘表面被逻辑地划分为<strong>磁道</strong>（track），磁道又被划分为<strong>扇区</strong>（sector）。<strong>扇区</strong>是磁盘读写信息的<strong>最小单位</strong>（一般512bytes）。
数据以<strong>块</strong>为单位在磁盘和主存间传输。块是一个逻辑单元，包含固定数目的扇区</p>
<p>磁盘质量的主要度量指标：容量capacity、访问时间access time、数据传输率data-transfer rate、可靠性（平均故障时间Mean time to failure）</p>
<p>访问时间 = 寻道时间seek time + 旋转延迟时间rotatinal lantency time</p>
<p>平均故障时间（MTTF）越长越好（我们希望设备无故障运行的时间）</p>
<p>每秒I/O操作数（IOPS）</p>
<p>RAID（Redundant Array of Independent Disk）独立磁盘冗余阵列。</p>
<ul>
<li>通过冗余提高可靠性</li>
<li>通过并行提高性能</li>
</ul>
<p>优化方法：buffering, read-ahead, disk-arm-scheduling, file organization</p>
<h3 id="83">8.3 闪存<a class="headerlink" href="#83" title="Permanent link">&para;</a></h3>
<p>NAND</p>
<p>SSD固态硬盘，和磁盘相比具有更低的数据访问延迟和更高的数据传输带宽</p>
<p>闪存必须先擦除后再写；为了快速访问，逻辑到物理的页面映射被复制到内存中的转换表中</p>
<h3 id="84">8.4 文件组织<a class="headerlink" href="#84" title="Permanent link">&para;</a></h3>
<p>块是储存分配和数据传输的（最小）单位</p>
<p>每条记录被完全包含在块内（不允许跨块存储</p>
<h4 id="841">8.4.1 定长记录<a class="headerlink" href="#841" title="Permanent link">&para;</a></h4>
<p>文件的开头分配了特定数量的字节作为文件头；被删除的记录形成了一条自由链表</p>
<p>每个文件被划分为固定长度的block，block是数据存取/存储空间分配的基本单位</p>
<ul>
<li>记录的长度不能超过block</li>
<li>每条记录一定都是完整的</li>
<li>参考实现：Free List 用链表的形式来存储records</li>
<li>优势：存储和读取访问寻址简单</li>
<li>缺点：可能浪费存储空间</li>
</ul>
<h4 id="842">8.4.2 变长记录<a class="headerlink" href="#842" title="Permanent link">&para;</a></h4>
<p>在记录的初始部分被表示为（偏移量，长度）对，即（数据开始位置，变长属性的字节长度）</p>
<ul>
<li>属性按照顺序连续存储</li>
<li>变长的变量用offset+data的形式存储，空值用null-value bitmap存储</li>
</ul>
<p>空位图(null bitmap)</p>
<p><img alt="image-20240524172058812" src="../images/image-20240524172058812.png" /></p>
<p>分槽的页slotted page结构，记录从末尾处开始<strong>连续</strong>分配空间</p>
<p><img alt="image-20240524172113339" src="../images/image-20240524172113339.png" /></p>
<p>Block Header内容</p>
<ul>
<li>记录的总数</li>
<li>lock中的空闲区域的end</li>
<li>每条记录所在的位置和大小</li>
</ul>
<p>指针指向头中记录的条目</p>
<h4 id="843">8.4.3 列式存储<a class="headerlink" href="#843" title="Permanent link">&para;</a></h4>
<p><img src="../images/image-20240618215950904.png" alt="image-20240618215950904" style="zoom:50%;" /></p>
<p>优点：</p>
<ul>
<li>当只访问部分属性时，减少IO开销</li>
<li>提高CPU缓存性能</li>
<li>提高压缩率</li>
<li>可以在现代CPU架构中实现Vector Processing</li>
</ul>
<p>缺点：</p>
<ul>
<li>行重构开销更大</li>
<li>删除和更新的开销更大</li>
<li>解压所需时间更长</li>
</ul>
<p>列式存储column在数据查询方面表现更好，但是在事务处理方面表现较差</p>
<h3 id="85">8.5 文件中记录的组织<a class="headerlink" href="#85" title="Permanent link">&para;</a></h3>
<h4 id="851">8.5.1 堆文件组织<a class="headerlink" href="#851" title="Permanent link">&para;</a></h4>
<p>自由空间图（free-space map）<img src="../images/image-20240524173906364.png" alt="image-20240524173906364" style="zoom:50%;" /></p>
<p>每个项表示一个比例f，即块中有至少比例为f的空间是自由的</p>
<p>块i的自由空间比例=值/2^n(bits)^</p>
<p>二级自由空间图：每个项表示自由空间图100个项，存储值为100个项中的最大值</p>
<h4 id="852">8.5.2 顺序文件组织<a class="headerlink" href="#852" title="Permanent link">&para;</a></h4>
<p>按某个搜索码排序</p>
<p>搜索码是任意属性或者属性的集合</p>
<p>每条记录指向按搜索码顺序排序的下一条记录，处理时顺序和物理顺序不同</p>
<h4 id="853">8.5.3 多表聚簇文件组织<a class="headerlink" href="#853" title="Permanent link">&para;</a></h4>
<p>聚簇码（cluster key）定义了哪些记录被存储在一起</p>
<h4 id="854">8.5.4 划分<a class="headerlink" href="#854" title="Permanent link">&para;</a></h4>
<p>表划分（table partitioning）通常基于一个属性值完成，将关系划分成更小的关系来存储</p>
<h3 id="86">8.6 数据字典存储<a class="headerlink" href="#86" title="Permanent link">&para;</a></h3>
<p>数据字典存储元数据</p>
<p>元数据（metadata）：关于数据的数据，例如维护关于关系的数据</p>
<h3 id="87">8.7 数据库缓冲区<a class="headerlink" href="#87" title="Permanent link">&para;</a></h3>
<h4 id="871">8.7.1 缓冲区管理器<a class="headerlink" href="#871" title="Permanent link">&para;</a></h4>
<p>在一个进程从缓冲块中读取数据之前，先执行pin（钉住）这个块；进程完成数据读取后，再执行解除钉住操作</p>
<p>对多进程，每个缓冲块维护<strong>钉住计数</strong>，只有一个页面的钉住计数为0时，块才能被移除</p>
<p>共享/排他锁：？</p>
<h4 id="872-buffer-replacement-policy">8.7.2 替换策略 Buffer-Replacement Policy<a class="headerlink" href="#872-buffer-replacement-policy" title="Permanent link">&para;</a></h4>
<p>最近最少使用（LRU）在操作系统中时可以接受的，但在数据库中替换块的最优策略是最近最常使用（MRU）</p>
<p>日志磁盘（log disk）：写操作，先写日志（buffer中，再修改数据</p>
<p><a href="https://chatgpt.com/share/29bc8b7e-8a42-44d6-a99b-45d5d77d95cb">https://chatgpt.com/share/29bc8b7e-8a42-44d6-a99b-45d5d77d95cb</a></p>
<h3 id="questions_1">Questions<a class="headerlink" href="#questions_1" title="Permanent link">&para;</a></h3>
<p>哈希查询适合单点查询，范围查询的话顺序查询更好</p>
<h2 id="9">9 索引<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 基础<a class="headerlink" href="#91" title="Permanent link">&para;</a></h3>
<p>如果一个文件上有多个索引，那它就有多个搜索码</p>
<p>两种基本索引类型：顺序、散列</p>
<p>评价因素：访问类型、访问时间、插入时间、删除时间、空间开销</p>
<p>索引项（index entry）由一个搜索码值和指针构成</p>
<p>主索引（primary index）比secondary index 高效</p>
<h3 id="92">9.2 顺序索引<a class="headerlink" href="#92" title="Permanent link">&para;</a></h3>
<p><strong>聚集（主）索引</strong>：搜索码定义了文件的次序，即允许按照与一个文件中的物理顺序相对应的顺序去读取该文件的记录</p>
<p><strong>稠密</strong>索引（dense index）：每个搜索码值都有一个索引项</p>
<p><strong>稀疏</strong>索引（Sparse index）：只为某些搜索码值search-key建立索引项，只有是聚集索引（顺序文件）时才使用稀疏索引</p>
<p>辅助索引（Secondary Indices）：数据文件中的记录顺序与索引文件中索引项的顺序不一致，应用于需要查询的field并非主键</p>
<p>多级索引（multilevel indices）：把内层索引文件看作顺序数据文件一样，在其上建立外层的稀疏索引</p>
<p>非唯一性搜索码（nonunique search key）：如果一种关系可以又不知一条包含相同搜索码值得记录</p>
<p>复合搜索码（composite search key）：包含多个属性，按字典序排列</p>
<h3 id="93-b">9.3 B+树索引<a class="headerlink" href="#93-b" title="Permanent link">&para;</a></h3>
<h4 id="931">9.3.1 结构<a class="headerlink" href="#931" title="Permanent link">&para;</a></h4>
<p>性质：</p>
<p><img alt="image-20240618220709646" src="../images/image-20240618220709646.png" /></p>
<p>B+树计算：<img src="../images/image-20240511122251045.png" alt="image-20240511122251045" style="zoom:40%;" /></p>
<p>n：B+树每个节点的指针数量</p>
<p>非叶结点有⌈𝑛/2⌉~n个孩子；根节点有2 ~ n个孩子</p>
<ul>
<li>
<p>每个<strong>叶节点</strong>最多可有<strong>n-1</strong>个值，最少包含<strong>⌈(𝑛-1)/2⌉</strong>个值</p>
</li>
<li>
<p>非叶节点是一个多级稀疏索引，最多容纳n个指针，最少容纳⌈𝑛/2⌉个指针</p>
</li>
<li>
<p>根节点包含的指针可以少于⌈𝑛/2⌉，但必须至少包含两个指针（除了树只由一个节点组成）</p>
</li>
</ul>
<p>N：搜索码个数</p>
<p>B^+^树高度估计：</p>
<ul>
<li>最小：所有叶节点都满，<span class="arithmatex">\(h=\lceil{log_n(N)}\rceil\)</span> 不太对</li>
<li>最大：所有叶节点都半满，<span class="arithmatex">\(h=\lceil{log_{\lceil{n/2}\rceil}(N/2)}\rceil\)</span></li>
</ul>
<h4 id="932">9.3.2 查询<a class="headerlink" href="#932" title="Permanent link">&para;</a></h4>
<p>如果文件中有N个搜索码值，那么这条路径的长度（树高）不超过<span class="arithmatex">\(<span class="arithmatex">\(⌈log_{⌈𝑛/2⌉}N⌉\)</span>\)</span>​，这里 n(fan-out or entries)=磁盘规模(4096B)/（搜索码+指针规模）(B)</p>
<ul>
<li>最坏查询Block数量=路径长度+bucket block+查询内容block</li>
</ul>
<p>在叶子节点，如果给定范围内有M个指针，则最多需要访问⌈M/(n/2)⌉+1个叶节点来检索指针</p>
<p>日志结构合并树LSM(log-structured merge tree) trees：一个内存树+多个磁盘树，对写做优化，牺牲了部分读型讷讷感</p>
<h4 id="933">9.3.3 更新<a class="headerlink" href="#933" title="Permanent link">&para;</a></h4>
<p>插入时，将原来叶节点n-1个值和待插入的一个值分成两组，前⌈𝑛/2⌉个值放到原来的节点中</p>
<p>在进行删除后，B+树种非叶节点出现的值可能在树的任何叶节点中都不存在</p>
<p>更新的复杂度：和<span class="arithmatex">\(<span class="arithmatex">\(log_{⌈𝑛/2⌉}N\)</span>\)</span>成正比</p>
<p>Buffer trees：给B+树每个内部节点一个buffer</p>
<p>对于叶节点，索引将被插入到根的缓冲区中，而不是遍历树。如果缓冲区满时，缓冲区中的每个索引记录都会从树向下推一级到相应的子节点。如果子节点是内部节点，则将索引记录添加到子节点节点缓冲区；如果该缓冲区已满，则该缓冲区中的所有记录都会类似地被下推。
缓冲区中的所有记录在按下之前都按搜索键进行排序。如果子节点是一个叶节点，索引记录以通常的方式插入到叶中。如果插入导致过满的叶节点、该节点以通常的B+树方式被分割，其中分裂可能传播到父节点。过满内部的拆分节点是以通常的方式完成的，同时还有拆分缓冲区的附加步骤；这个缓冲区条目根据它们的键值在两个拆分的节点之间进行分区。</p>
<p>插入次数减少，所以I/O次数会少</p>
<h4 id="934">9.3.4 非唯一性搜索码<a class="headerlink" href="#934" title="Permanent link">&para;</a></h4>
<p>方法1：每个码只储存一次，维护一个带有搜索码值的记录指针的桶bucket</p>
<p>方法2：每条记录储存一次搜索码值</p>
<h4 id="quiz">Quiz<a class="headerlink" href="#quiz" title="Permanent link">&para;</a></h4>
<ol>
<li>Considering a B+ tree for indexing, Each node can fit <strong>three pointers</strong> and <strong>two key values</strong>, denoted as <span class="arithmatex">\(&lt;A_1, K_1, A_2, K_2, A_3&gt;\)</span>, Within each node, the keys satisfy K1 &lt; K2, For all search field values X in the sub-tree pointed by Ai, we have:  <span class="arithmatex">\(K_{i-1} ≤ X&lt;K_i\)</span>; for 1&lt;i&lt;3; <span class="arithmatex">\(X&lt;K_i\)</span> , for i=1; <span class="arithmatex">\(K_{i-1}≤X\)</span>, for i=3; Construct a B+ tree for the following set of key values:(2, 3, 6, 4, 5, 1, 8, 7), assuming that values are inserted one by one, and the number of key values in internal nodes and leaf nodes are both 2. When we split a node, one value remains in the left node and the other two are split out to the newly created right one.  </li>
</ol>
<p><img src="../images/43be641ec390918b2522107f7ba9bd6.jpg" alt="43be641ec390918b2522107f7ba9bd6" style="zoom:67%;" /></p>
<ol start="3">
<li>Assume that the B+ tree(n=3) contains 2024 index items, estimate the <strong>height</strong> of the B+ tree. Give the lower and upper bound.</li>
</ol>
<blockquote>
<p>B+ Tree Properties:</p>
<ul>
<li>Each internal node can have between ⌈𝑛/2⌉=2 and 𝑛=3 children.</li>
<li>Each leaf node can have between ⌈𝑛/2⌉−1=1 and 𝑛−1=2 keys.</li>
</ul>
<p><strong>Lower Bound Calculation:</strong></p>
<ul>
<li>For the lower bound, assume the internal nodes have the minimum number of children.</li>
</ul>
<ol>
<li>Height 1 (root level): At least 1 node.</li>
<li>Height 2: At least 2 nodes (each node at level 1 has at least 2 children).</li>
<li>Height 3: At least 2^2^=4 nodes.</li>
<li>Height ℎ: At least 2^ℎ−1^ nodes.</li>
</ol>
<p>So, at height ℎ, we have at least: 
$$
\sum_{i=0}^{h-1}2^i=2^h-1
$$
Given 2024 index items: </p>
<p>2^ℎ^−1 ≥ 2024</p>
<p>ℎ ≥ <span class="arithmatex">\(log⁡_22025\)</span> ≈ 10.001</p>
<p>So, the lower bound height is approximately 11.</p>
<p><strong>Upper Bound Calculation:</strong></p>
<ul>
<li>For the upper bound, assume the internal nodes have the maximum number of children.</li>
</ul>
<ol>
<li>Height 1 (root level): At most 1 node.</li>
<li>Height 2: At most 3 nodes (each node at level 1 has at most 3 children).</li>
<li>Height 3: At most 32=932=9 nodes.</li>
<li>Height ℎ: At most 3^ℎ−1^nodes.</li>
</ol>
<p>So, at height ℎ, we have at most: 
$$
\sum_{i=0}^{h-1}3^i=\frac{3^h-1}{2}
$$
Given 2024 index items:</p>
<p><span class="arithmatex">\(\frac{3^h-1}{2}\)</span>≥2024</p>
<p>ℎ ≥ <span class="arithmatex">\(log⁡_34049\)</span> ≥ 7.56</p>
<p>So, the upper bound height is approximately 8.</p>
</blockquote>
<ol start="4">
<li>Assume that the B+ tree (n=3) contains 2024 index items, estimate the size (i.e. the number of nodes) of the B+ tree. Give the lower and upper bound.</li>
</ol>
<blockquote>
<p><strong>Lower Bound Calculation:</strong></p>
<p>Maximum keys per node: 2 keys (since 𝑛=3<em>n</em>=3, each node can hold 2 keys). 向上取整！</p>
<ul>
<li>Number of leaf nodes: ⌈2024/2⌉=1012.</li>
<li>
<p>Number of internal nodes: ⌈1012/3⌉=338. At the bottom level (just above leaf nodes), each internal node can have up to 3 children (pointers).</p>
</li>
<li>
<p>At the next level: ⌈338/3⌉=113</p>
</li>
<li>At the level above that: ⌈113/3⌉=38</li>
<li>Continuing further: ⌈38/3⌉=13</li>
<li>Next level: ⌈13/3⌉=5</li>
<li>Finally: ⌈5/3⌉=2</li>
<li>And at the root level: ⌈&#8532;⌉=1</li>
</ul>
<p>​ So, the total number of nodes (summing all levels) for the lower bound is approximately: 1012+338+113+38+13+5+2+1=1522</p>
<p><strong>Upper Bound Calculation:</strong></p>
<p>Minimum keys per internal node: 1 key (since each node has at least 2 pointers). 向下取整！</p>
<ul>
<li>Each leaf node can hold at least 1 key.</li>
<li>Number of leaf nodes: ⌈2024/1⌉=2024</li>
<li>Number of internal nodes at the bottom level (just above leaf nodes), each internal node can have at least 2 children: ⌊2024/2⌋=1012</li>
<li>At the next level: ⌊1012/2⌋=506</li>
<li>At the level above that: ⌊506/2⌋=253</li>
<li>Continuing further: ⌊253/2⌋=126</li>
<li>Next level: ⌊126/2⌋=63</li>
<li>And continuing: ⌊63/2⌋=31</li>
<li>Next: ⌊31/2⌋=15</li>
<li>Next: ⌊15/2⌋=7</li>
<li>Finally: ⌊7/2⌋=3</li>
<li>And at the root level: ⌊3/2⌋=1</li>
</ul>
<p>​ So, the total number of nodes (summing all levels) for the upper bound is approximately:  </p>
<p>2024+1012+506+253+126+63+31+15+7+3+1=4041</p>
</blockquote>
<h3 id="94-hash-indices">9.4 散列索引 Hash indices<a class="headerlink" href="#94-hash-indices" title="Permanent link">&para;</a></h3>
<p>索引记录随机分布</p>
<p>桶bucket记录，桶溢出的话用溢出链来处理多条记录</p>
<p>计算<span class="arithmatex">\(h(K_i)\)</span>​确定桶再遍历桶来查找，不支持范围查询</p>
<p>桶的数量：<span class="arithmatex">\((n_r/f_r)*(1+d)\)</span>，<span class="arithmatex">\(f_r\)</span>是每个桶容纳的记录的数量，d是避让因子（0.2表示桶中20%的空间大概是空的）</p>
<h3 id="95">9.5 多码索引<a class="headerlink" href="#95" title="Permanent link">&para;</a></h3>
<h3 id="96">9.6 位图索引<a class="headerlink" href="#96" title="Permanent link">&para;</a></h3>
<h2 id="10">10 查询处理和查询优化<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 概述<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<p><img src="../images/image-20240516103920015.png" alt="image-20240516103920015" style="zoom:50%;" /></p>
<h3 id="102">10.2 查询代价<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<p>在大型数据库中，在<strong>磁盘上存取数据</strong>的代价通常是最主要的代价</p>
<p>总成本cost = b个块*传输一个数据块的时间<span class="arithmatex">\(t_r\)</span> + 执行S次随机I/O*平均块访问时间（寻道+旋转延迟）<span class="arithmatex">\(t_s\)</span>​</p>
<p><span class="arithmatex">\(cost = b*t_r + S*t_s\)</span></p>
<h3 id="103">10.3 关系代数运算的执行<a class="headerlink" href="#103" title="Permanent link">&para;</a></h3>
<h4 id="1031">10.3.1 选择运算<a class="headerlink" href="#1031" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\(h_i\)</span>​：索引的高度
<span class="arithmatex">\(b_r\)</span>​：文件中的块数量
<span class="arithmatex">\(t_T\)</span>：一个块的传输时间
<span class="arithmatex">\(t_s\)</span>：一个块的寻道时间</p>
<p><img src="../images/image-20240516110142366.png" alt="image-20240516110142366"  /></p>
<h5 id="_8">文件扫描<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h5>
<p>A1 线性搜索
A2 聚集索引+key比较
A3 聚集索引+非key比较
A4 辅助索引+key比较
A4 辅助索引+非key比较
A5 聚集索引+比较
A6 非聚集索引+比较</p>
<h5 id="_9">复杂选择<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h5>
<p>合取∧：<img src="../images/image-20240601112121918.png" alt="image-20240601112121918" style="zoom: 50%;" /></p>
<p>析取∨：<img src="../images/image-20240601112158194.png" alt="image-20240601112158194" style="zoom:50%;" /></p>
<p>否定-：<img src="../images/image-20240601112311253.png" alt="image-20240601112311253" style="zoom:50%;" /></p>
<p>A7 使用一个索引的合取选择
A8 使用组合索引的合区选择
A9 使用标识交集的合区选择
A10 使用标识集的析取选择</p>
<h4 id="1032">10.3.2 排序<a class="headerlink" href="#1032" title="Permanent link">&para;</a></h4>
<p>外排序 Merge 归并：对M-1个归并段进行归并，每一次归并段的数量减少为原来的1/(M-1)</p>
<p><span class="arithmatex">\(b_b\)</span>：一次读/写块的个数
buffer blocks per run = read/write <span class="arithmatex">\(b_b\)</span>​​ blocks at a time</p>
<p><span class="arithmatex">\(b_r\)</span>​：关系r记录的总块数</p>
<p>M：刚开始一个归并段有几个块</p>
<table>
<thead>
<tr>
<th>算法</th>
<th>传输块总数 block transfers</th>
<th>寻道次数 seeks</th>
</tr>
</thead>
<tbody>
<tr>
<td>Merge sort</td>
<td><span class="arithmatex">\(b_r ( 2⌈log_{⌊M/b_b⌋–1} (b_r/ M)⌉ + 1)\)</span></td>
<td><span class="arithmatex">\(2⌈b_r/M⌉+⌈b_r/b_b⌉( 2⌈log_{⌊M/b_b⌋–1} (b_r/ M)⌉ - 1)\)</span></td>
</tr>
</tbody>
</table>
<p>Example</p>
<p><img src="../images/image-20240601130228616.png" alt="image-20240601130228616" style="zoom:50%;" /></p>
<p>块传输总数：<span class="arithmatex">\(b_b=1, b_r=12, M=3\)</span>​，12 ∗ (2*2 + 1) = 60 </p>
<p>磁盘寻道总数：<span class="arithmatex">\(b_b=1, b_r=12, M=3\)</span>， 2*12/3 + 12 ∗ (2 ∗2 − 1) = 44 </p>
<h4 id="1033">10.3.3 连接运算<a class="headerlink" href="#1033" title="Permanent link">&para;</a></h4>
<p>等值连接（equal-join）表示形如<img src="../images/image-20240601130658577.png" alt="image-20240601130658577" style="zoom:50%;" />的连接</p>
<h5 id="-nested-loop-join">嵌套-循环 连接（Nested-loop join）<a class="headerlink" href="#-nested-loop-join" title="Permanent link">&para;</a></h5>
<p><strong>r</strong> is called the <strong>outer</strong> relation and <strong>s</strong> the <strong>inner</strong> relation of the join；
r外层s内层
<span class="arithmatex">\(b_r\)</span>：关系r记录的总块数
<span class="arithmatex">\(n_r\)</span>：关系r中包含的元组个数</p>
<p>worst case 缓冲区只能容纳每个关系的一个数据块: <span class="arithmatex">\((b_r + n_r ∗ b_s )block-transfers + (b_r + n_r) seeks\)</span></p>
<p>best case 缓冲区能同时容纳两个关系（或一个能完全放在内存中的关系作为内层）：<span class="arithmatex">\((b_r + b_s )block-transfers + (2) seeks\)</span></p>
<h5 id="-block-nested-loop-join">块嵌套-循环 连接（Block nested-loop join）<a class="headerlink" href="#-block-nested-loop-join" title="Permanent link">&para;</a></h5>
<p>worst case 缓冲区只能容纳每个关系的一个数据块: <span class="arithmatex">\((b_r*b_s + b_r)block-transfers + (2b_r)seeks\)</span></p>
<p>best case 缓冲区能同时容纳两个关系（或一个能完全放在内存中的关系作为内层）: <span class="arithmatex">\((b_s + b_r)block-transfers + (2)seeks\)</span></p>
<p>因为是block所以算的时候是看number of blocks</p>
<ul>
<li>如果两个关系都不能放进内存中，则<strong>小关系作为外层关系</strong>连接效率更高</li>
</ul>
<p>Improved: <img alt="image-20240527105826975" src="../images/image-20240527105826975.png" />M为块数</p>
<h5 id="-indexed-nested-loop-join">索引嵌套-循环连接（indexed nested-loop join）<a class="headerlink" href="#-indexed-nested-loop-join" title="Permanent link">&para;</a></h5>
<p><span class="arithmatex">\(t_T\)</span>：一个块的传输时间
<span class="arithmatex">\(t_s\)</span>：一个块的寻道时间</p>
<p>worst cost = <span class="arithmatex">\(b_r(t_T+t_S)+n_r*c\)</span>​</p>
<ul>
<li>c 表示使用连接条件对关系s进行单次选择操作的代价</li>
<li>最坏情况，缓冲区只能容纳关系r的一块和索引的一块</li>
</ul>
<p>算的时候<span class="arithmatex">\(n_r\)</span>看number of records，<span class="arithmatex">\(b_r\)</span>看number of blocks</p>
<p>将tuple少的关系作为外关系</p>
<h5 id="-merge-join">排序归并-连接（Merge-join)<a class="headerlink" href="#-merge-join" title="Permanent link">&para;</a></h5>
<p>设为每个关系分配<span class="arithmatex">\(b_b\)</span>个缓冲块，假设排序好的（没排序还要算上排序代价）</p>
<p><img src="../images/image-20240523101143163.png" alt="image-20240523101143163" style="zoom:50%;" /></p>
<h5 id="-hash-join">哈希-连接（Hash-join）<a class="headerlink" href="#-hash-join" title="Permanent link">&para;</a></h5>
<p><img src="../images/image-20240616170454659.png" alt="image-20240616170454659" style="zoom:40%;" /></p>
<p>为了使右边si个东西存进内存，n is chosen as <span class="arithmatex">\(⌈b_s/M⌉ * f\)</span>​ where f is a “fudge factor”, typically around 1.2</p>
<p>M: number of pages
n: number of partitions</p>
<p>当<span class="arithmatex">\(M&gt;(b_s/M)+1\)</span>，其中<span class="arithmatex">\(b_s/M=n_h\)</span>分区的规模，则关系不需要递归分区</p>
<p><img alt="image-20240616170636536" src="../images/image-20240616170636536.png" /></p>
<p><span class="arithmatex">\(b_b=\lfloor\frac{M}{n+1}\rfloor=\lfloor\frac{M}{b_s/M+1}\rfloor\)</span> 每次能传输的buffer数</p>
<p>如果需要递归分区（M&gt;<span class="arithmatex">\(\sqrt{b_s}\)</span>）</p>
<p><img alt="image-20240616170754986" src="../images/image-20240616170754986.png" /></p>
<p>散列具有随机性和均匀性</p>
<h5 id="example_3">Example<a class="headerlink" href="#example_3" title="Permanent link">&para;</a></h5>
<p><img alt="image-20240527112154059" src="../images/image-20240527112154059.png" /></p>
<p><img alt="image-20240616171020696" src="../images/image-20240616171020696.png" /></p>
<h3 id="104">10.4 表达式执行<a class="headerlink" href="#104" title="Permanent link">&para;</a></h3>
<p>物化</p>
<p>算子树对表达式进行图形化展示</p>
<p>物化执行：每个中间运算的结果都内创建（物化），然后用于下一层运算的执行</p>
<h3 id="105">10.5 查询优化<a class="headerlink" href="#105" title="Permanent link">&para;</a></h3>
<h4 id="1051">10.5.1 等价关系<a class="headerlink" href="#1051" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>Conjuctive合取选择可分为单个选择运算的级联 <img src="../images/image-20240601161500529.png" alt="image-20240601161500529" style="zoom:50%;" /></p>
</li>
<li>
<p>选择运算满足交换律commutative <img src="../images/image-20240601161536805.png" alt="image-20240601161536805" style="zoom:50%;" /></p>
</li>
<li>
<p>一系列投影运算中只有最后一个是必须的 <img src="../images/image-20240601161618179.png" alt="image-20240601161618179" style="zoom:50%;" /></p>
</li>
<li>
<p>选择运算可与笛卡尔积以及θ连接相结合<img src="../images/image-20240601162140969.png" alt="image-20240601162140969" style="zoom:50%;" /></p>
</li>
<li>
<p>θ连接运算满足交换律 <img src="../images/image-20240601162250594.png" alt="image-20240601162250594" style="zoom:50%;" /></p>
</li>
<li>自然连接结合律<img src="../images/image-20240619104722242.png" alt="image-20240619104722242" style="zoom:50%;" /></li>
<li>θ连接结合律<img src="../images/image-20240619104808091.png" alt="image-20240619104808091" style="zoom:50%;" /></li>
</ol>
<h4 id="1053">10.5.3 查询规模估计<a class="headerlink" href="#1053" title="Permanent link">&para;</a></h4>
<p><span class="arithmatex">\(n_r\)</span>：关系r中的元组数
<span class="arithmatex">\(b_r\)</span>：包含关系r中元组的块数
<span class="arithmatex">\(l_r\)</span>：关系r中一个元组的字节数
<span class="arithmatex">\(f_r\)</span>：关系r的块因子——一个块中能容纳关系r的元组数
V(A,r)：关系r中对于属性A的非重复值的数量，与<span class="arithmatex">\(Π_A(r)\)</span>​的规模相同</p>
<p>record number per block of r = blocksize/<span class="arithmatex">\(l_r\)</span>
blocks of r = <span class="arithmatex">\(n_r\)</span>/record number per block of r（向上取整）</p>
<p><strong>选择规模估计</strong></p>
<p><span class="arithmatex">\(σ_{A=\alpha}(r)\)</span>：<span class="arithmatex">\(\alpha\)</span>是频繁出现的值；否则，没有可用的直方图，假设取值是均匀分布的，估计为<span class="arithmatex">\(n_r/V(A,r)\)</span>个元组</p>
<p><span class="arithmatex">\(σ_{A≤v}(r)\)</span>：假设最大最小储存在目录中，值均匀分布，则<img src="../images/image-20240601164333077.png" alt="image-20240601164333077" style="zoom:50%;" /></p>
<p><strong>复杂选择</strong></p>
<p><img src="../images/image-20240619104910755.png" alt="image-20240619104910755" style="zoom:50%;" /></p>
<p>连接规模估计：</p>
<p><img alt="image-20240619105008753" src="../images/image-20240619105008753.png" /></p>
<h4 id="1054">10.5.4 执行优化<a class="headerlink" href="#1054" title="Permanent link">&para;</a></h4>
<h3 id="exercises">Exercises<a class="headerlink" href="#exercises" title="Permanent link">&para;</a></h3>
<ol>
<li><img alt="image-20240602153039717" src="../images/image-20240602153039717.png" /></li>
</ol>
<p>a. </p>
<h2 id="11">11 事务管理<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="111">11.1 概念<a class="headerlink" href="#111" title="Permanent link">&para;</a></h3>
<p>ACID：原子性一致性隔离性持久性</p>
<ul>
<li>原子性 Atomicity：事务中的所有步骤只能完全执行(commit)或者回滚(rollback)</li>
<li>持久性 Durability：更新之后哪怕软硬件出了问题，更新的数据也必须存在</li>
<li>一致性 Consistency：单独执行事务可以保持数据库的一致性</li>
<li>独立性 Isolation：事务在并行执行的时候不能感知到其他事务正在执行，执行中间结果对于其他并发执行的事务是隐藏的</li>
</ul>
<p>事务的状态：
- active 初始状态，执行中的事务都处于这个状态
- partially committed 在最后一句指令被执行之后
- failed 在发现执行失败之后
- aborted 回滚结束，会选择是重新执行事务还是结束
- committed 事务被完整的执行</p>
<h3 id="115">11.5 并发控制<a class="headerlink" href="#115" title="Permanent link">&para;</a></h3>
<p>调度（schedule）：一系列用于指定并发事务的执行顺序的指令</p>
<p>串行调度（serial）：先执行T1再执行T2，保证数据库一致性</p>
<p>等价调度（equivalent schedule）：改变处理的顺序但是和原来等价</p>
<p>可串行化调度：多个事务的并发执行是正确的，当且仅当其结果与按某一次序串行地执行这些事务时的结果相同，称这样的调度策略为可串行化调度。</p>
<p>可串行化：可以转化成串行调度</p>
<h3 id="116">11.6 可串行化<a class="headerlink" href="#116" title="Permanent link">&para;</a></h3>
<p>对同一数据项Q，只有I、J全是read的情况下，两条指令的顺序才是无关紧要的；如果有至少一条指令是write则I和J是冲突的</p>
<p>如果调度S可以经过一系列非冲突指令的交换而转换成调度S'，则称它们是<strong>冲突等价</strong>（conflict serializable）的</p>
<p>若一个调度S与一个串行调度是冲突等价的，则称S是<strong>冲突可串行化</strong>的（conflict serializable）</p>
<h4 id="example_4">Example<a class="headerlink" href="#example_4" title="Permanent link">&para;</a></h4>
<p><img alt="image-20240530102647913" src="../images/image-20240530102647913.png" /></p>
<p>视图可串行化（view serializability</p>
<p>每个冲突可串行化的调度也是视图~；反之不对</p>
<p><img alt="image-20240530103459073" src="../images/image-20240530103459073.png" /></p>
<ul>
<li>每个不是冲突串行化的视图可串行化调度都有盲写</li>
</ul>
<h5 id="precedence-graph">Precedence graph （前驱图 ）<a class="headerlink" href="#precedence-graph" title="Permanent link">&para;</a></h5>
<p><span class="arithmatex">\(T_i-&gt;T_j\)</span>：</p>
<ol>
<li>Ti write(Q)在Tj read(Q)前</li>
<li>Ti read(Q)在Tj write(Q)前</li>
<li>Ti write(Q)在Tj write(Q)前</li>
</ol>
<h2 id="-_1">- 前驱图无环，则是冲突可串行化的<a class="headerlink" href="#-_1" title="Permanent link">&para;</a></h2>
<h3 id="117">11.7 事物隔离性和原子性<a class="headerlink" href="#117" title="Permanent link">&para;</a></h3>
<p><strong>可恢复调度</strong>（recoverable schedules）：对每对事务<span class="arithmatex">\(T_i\)</span>和<span class="arithmatex">\(T_j\)</span>，如果<span class="arithmatex">\(T_j\)</span>读取了<span class="arithmatex">\(T_i\)</span>之前写过的数据项，则<span class="arithmatex">\(T_i\)</span>必须在<span class="arithmatex">\(T_j\)</span>提交之前先提交
<code>Ti写-&gt;Ti提交-&gt;Tj读-&gt;Tj提交</code> or <code>Ti写-&gt;Tj读-&gt;Ti提交-&gt;Tj提交</code></p>
<p><strong>无级联调度</strong>（cascadeless schedules）：对每对事务<span class="arithmatex">\(T_i\)</span>和<span class="arithmatex">\(T_j\)</span>，如果<span class="arithmatex">\(T_j\)</span>读取了先前由<span class="arithmatex">\(T_i\)</span>所写的一个数据项，则<span class="arithmatex">\(T_i\)</span>的提交操作必须出现在<span class="arithmatex">\(T_j\)</span>这一读操作前；每个无极联调度都是可恢复的
<code>Ti写-&gt;Ti提交-&gt;Tj读</code></p>
<p>因单个事物失效而导致一系列事物回滚的现象称为级联回滚</p>
<h2 id="12">12 并发控制与恢复<a class="headerlink" href="#12" title="Permanent link">&para;</a></h2>
<p>concurrency-control</p>
<h3 id="121">12.1 锁<a class="headerlink" href="#121" title="Permanent link">&para;</a></h3>
<p><img src="../images/image-20240614184748441.png" alt="image-20240614184748441" style="zoom:50%;" /></p>
<h4 id="two-phrase-locking-protocol">two-phrase locking protocol 两阶段封锁协议<a class="headerlink" href="#two-phrase-locking-protocol" title="Permanent link">&para;</a></h4>
<ul>
<li>保证可串行化</li>
<li>不保证不会有死锁</li>
<li>可能发生级联回滚</li>
<li>strict ~：严格的两阶段封锁协议可以避免级联回滚，保证没有脏读（dirty read）</li>
<li>rigorous~：所有锁必须保持到事务commit或者abort</li>
</ul>
<p>机制：</p>
<ul>
<li></li>
</ul>
<p>tree protocol 树协议</p>
<p>只能用排他锁，对一个数据项只能封锁一次</p>
<p>保证冲突可串行化，且不会有死锁</p>
<p><img alt="数据库锁" src="../images/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%81.png" /></p>
<h3 id="122">12.2 死锁处理<a class="headerlink" href="#122" title="Permanent link">&para;</a></h3>
<p>死锁举例：</p>
<p><img src="../images/image-20240616172318172.png" alt="image-20240616172318172" style="zoom:33%;" /> 
Neither T3 nor T4 can make progress — executing  lock-S(B) causes T4 to wait for T3 to release its lock on B, while executing  lock-X(A) causes T3  to wait for T4 to release its lock on A.</p>
<p>Starvation 饥荒：一个事务在等一个数据项的Xlock，一群别的事务在等他release，造成饥荒</p>
<p>12.3 多粒度</p>
<p>granularity</p>
<p>细粒度：低层（叶子层）高并发、封锁代价高</p>
<p>粗粒度：高层（根）</p>
<ul>
<li></li>
</ul>
<h3 id="124">12.4 插入、删除与谓词读<a class="headerlink" href="#124" title="Permanent link">&para;</a></h3>
<p>12.4.1 删除</p>
<p>12.4.2 插入</p>
<p>12.4.3 谓词读和幻象现象</p>
<p>幻象（phantom phenomenon）</p>
<p>索引封锁（index-locking）</p>
<h3 id="128">12.8 故障分类<a class="headerlink" href="#128" title="Permanent link">&para;</a></h3>
<p>恢复机制（recovery schema）</p>
<p>事务故障 transaction failure：</p>
<ul>
<li>逻辑错误：非法输入、溢出、超出资源限制</li>
<li>系统错误：死锁</li>
</ul>
<p>系统崩溃 system crash：硬件、软件或操作系统故障</p>
<p>磁盘故障 disk failure：备份</p>
<h3 id="129">12.9 存储器<a class="headerlink" href="#129" title="Permanent link">&para;</a></h3>
<p>易失性存储器
非易失性存储器
稳定存储器：接近稳定的，保存一份copy用来实现恢复</p>
<h3 id="1210">12.10 恢复与原子性<a class="headerlink" href="#1210" title="Permanent link">&para;</a></h3>
<p>基于日志的恢复（log-based）</p>
<p>恢复算法需要能维持<strong>幂等性（idempotent）</strong>，执行恢复多次的结果一样（恢复过程中中断）</p>
<h4 id="12101">12.10.1 日志记录<a class="headerlink" href="#12101" title="Permanent link">&para;</a></h4>
<p>更新日志记录 <span class="arithmatex">\(&lt;T_i,X_i,V_1,V_2&gt;\)</span>：</p>
<ul>
<li>事务标识 Ti</li>
<li>数据项标识 Xi</li>
<li>旧值 V1</li>
<li>新值 V2</li>
</ul>
<p>立即数据库修改（immediate）：事务还没commit数据库就已经修改了；日志更新记录必须在数据库内容被写之前被写</p>
<p>延迟数据库修改（deferred）：事务直至提交都没有修改</p>
<p><strong>事务提交</strong>：一个事务<em>commit的日志记录被输出到稳定存储器</em>上</p>
<p><strong>撤销undo</strong>：日志中只有<span class="arithmatex">\(&lt;T_i start&gt;\)</span>记录，从后往前一步步撤销，结束于事务开始</p>
<p><strong>重做redo</strong>：日志中包括<span class="arithmatex">\(&lt;T_i start&gt;\)</span>记录以及<span class="arithmatex">\(&lt;T_i commit&gt;\)</span>或<span class="arithmatex">\(&lt;T_i abort&gt;\)</span>​记录，哪里开始出错从哪里开始重做</p>
<p><img alt="image-20240616190910326" src="../images/image-20240616190910326.png" /></p>
<h5 id="_10">单个事务回滚<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h5>
<p>-从后往前扫描，当发现记录<span class="arithmatex">\(&lt;T_i,X_i,V_1,V_2&gt;\)</span>的时候
- 将X的值修改为原本的值
- 在日志的末尾写入记录<span class="arithmatex">\(&lt;T_i,X_i,V_1&gt;\)</span>
- 发现start记录的时候，停止扫描并在日志中写入abort记录</p>
<h4 id="12102-checkpoint">12.10.2 检查点 checkpoint<a class="headerlink" href="#12102-checkpoint" title="Permanent link">&para;</a></h4>
<p>每隔一段时间：</p>
<ol>
<li>Output all log records currently residing in main memory onto stable storage.</li>
<li>Output all modified buffer blocks to the disk. </li>
<li>Write a log record <code>&lt; checkpoint L&gt;</code> onto stable storage where L is a list of all transactions active at the time of checkpoint.</li>
</ol>
<ul>
<li>All updates are stopped while doing checkpointing!!!</li>
</ul>
<p><img alt="image-20240616191956910" src="../images/image-20240616191956910.png" /></p>
<p>模糊检查点（fuzzy checkpoint）</p>
<p><img alt="image-20240616195539201" src="../images/image-20240616195539201.png" /></p>
<p>Write-Ahead Logging 日志先写原则：在checkpoint记录日志后，修改过的缓冲块写到磁盘前开始更新日志</p>
<ul>
<li>只有在修改过的缓冲块列表中所所有缓冲块都输出到磁盘上后，<code>last_checkpoint</code>才会更新</li>
<li>正在输出到磁盘的缓冲块不能更新！</li>
</ul>
<h3 id="1211">12.11 恢复算法<a class="headerlink" href="#1211" title="Permanent link">&para;</a></h3>
<p>在重做阶段，会记录从最近的检查点开始重演的每一天日志记录</p>
<p>重复历史（repeating history）：按照原先的执行次序重复执行动作</p>
<p>恢复的两个阶段：redo和undo</p>
<p>redo需要先找到最后一个check point并且设置undo-list
&gt; 1.从checkpoint开始往下读
&gt; 2.当发现修改值的记录 <Ti, Xj, V1, V2>日志或者 <Ti, Xj, V2>的redo-only日志的时候，执行重做，将值V2写给数据项Xj
&gt; 3.当发现start的时候将这个事务加入undo-list
&gt; 4.当发现commit或者abort的时候将对应的事务从undo-list中移除</p>
<p>undo
&gt; 1.从日志的末尾开始往回读
&gt; 2.当发现记录 <Ti, Xj, V1, V2>并且Ti在undo-list中的时候，进行一次回滚
&gt; 3.当发现Ti start并且Ti在undo-list中的时候，写一条abort日志并且从undo-list中移除Ti
&gt; 4.当undo-list空了的时候停止undo</p>
<h3 id="1212">12.12 缓冲区管理<a class="headerlink" href="#1212" title="Permanent link">&para;</a></h3>
<p>日志记录先存储到缓冲区中，然后等待被输出到稳定存储器</p>
<p>强制日志（log force）</p>
<p>当下述情况之一发生时必须写到稳定存储器：</p>
<ul>
<li>在<T_i,commit>日志记录可以被输出到稳定存储器之前，与事务相关的所有日必须已经被输出到稳定存储器。</li>
<li>在主存中的一个数据块输出到(非易失性存储器中的)数据库之前，与该块中的数据相关的所有日志记录必须已经被输出到稳定存储器。</li>
</ul>
<h3 id="1213-aries-recovery">12.13 ARIES recovery<a class="headerlink" href="#1213-aries-recovery" title="Permanent link">&para;</a></h3>
<p>另一种恢复算法</p>
<p>log sequence number (LSN) to identify log records
标注日志，以页的形式来存储LSN来标注数据库页表中进行了哪些更新</p>
<p>PageLSN 最后改变的日志记录：PageLSN is used during recovery to prevent repeated redo </p>
<p>Dirty page table：</p>
<ul>
<li><em>PageLSN</em> of the page</li>
<li><em>RecLSN</em> is an LSN such that log records before this LSN have
  already been applied to the page version on the disk</li>
<li>使用脏页表(dirty page table) 来避免不必要的redo</li>
</ul>
<p><img src="../images/image-20240619124202440.png" alt="image-20240619124202440" style="zoom:50%;" /></p>
<p>ARIES recovers from a system crash in three passes——三轮遍历</p>
<ul>
<li>Analysis pass: This pass determines which transactions to undo, which pages were dirty at the time of the crash, and the LSN from which the redo pass should start.</li>
<li>Redo pass: This pass starts from a position determined during analysis and performs a redo, repeating history, to bring the database to a state it was in before the crash.</li>
<li>Undo pass: This pass rolls back all transactions that were incomplete at the time of crash. </li>
</ul>
<p><img alt="image-20240617201838038" src="../images/image-20240617201838038.png" /></p>
<p><strong>分析阶段</strong></p>
<p>需要决定哪些事务undo，哪些页是脏页</p>
<p>从最后一条完整的checkpoint日志记录开始</p>
<p>读取脏页表的信息</p>
<ul>
<li>设置RedoLSN = min RecLSN(脏页表中的)，如果脏页表是空的就设置为checkpoint的LSN</li>
<li>设置undo-list：checkpoint中记录的事务</li>
<li>读取undo-list中每一个事务的最后一条记录的LSN</li>
</ul>
<p>从checkpoint开始正向扫描（读后面的日志</p>
<ul>
<li>如果发现了不在undo-list中的记录就写入undo-list</li>
<li>当发现一条更新记录的时候，如果这一页不在脏页表中，用该记录的LSN作为RecLSN写入脏页表中</li>
<li>如果发现了标志事务结束的日志记录(commit, abort) 就从undo-list中移除这个事务</li>
<li>搜索直到undo-list中的每一个事务都到了最后一条</li>
</ul>
<p>分析结束之后</p>
<ul>
<li>
<p>RedoLSN决定了从哪里开始redo</p>
</li>
<li>
<p>所有undo-list中的事务都需要回滚</p>
</li>
</ul>
<p><strong>Redo阶段</strong></p>
<p>从RedoLSN开始正向扫描，当发现更新记录的时候</p>
<ul>
<li>如果这一页不在脏页表中，或者这一条记录的LSN小于页面的RecLSN就忽略这一条</li>
<li>否则从磁盘中读取这一页，如果磁盘中得到的这一页PageLSN比这一条要小，就redo，否则就忽略这一条记录</li>
</ul>
<p><strong>Undo阶段</strong></p>
<p>从日志末尾先向前搜索，undo所有undo-list中有的事务</p>
<p>符合如下条件的记录可以跳过</p>
<ul>
<li>用分析阶段的最后一个LSN来找到每个日志最后的记录</li>
<li>每次选择一个最大的LSN对应的事务undo</li>
</ul>
<p>在undo一条记录之后</p>
<ul>
<li>对于普通的记录，将NextLSN设置为PrevLSN</li>
<li>对于CLR记录，将NextLSN设置为UndoNextLSN</li>
</ul>
<p>如何undo：当一条记录undo的时候</p>
<ul>
<li>生成一个包含执行操作的CLR</li>
<li>设置CLR的UndoNextLSN 为更新记录的LSN</li>
</ul>











<div id="__comments">

    <h3>颜色主题调整</h3>
    
    <!-- <div class="tx-switch">
    <button data-md-color-scheme="default"><code>default</code></button>
    <button data-md-color-scheme="slate"><code>slate</code></button>
    </div>
    
    <script>
    var buttons = document.querySelectorAll("button[data-md-color-scheme]")
    buttons.forEach(function(button) {
            button.addEventListener("click", function() {
            var attr = this.getAttribute("data-md-color-scheme")
            document.body.setAttribute("data-md-color-scheme", attr)
            localStorage.setItem("data-md-color-scheme",attr);
            updateScheme();
            })
    })
    </script> -->
    
    <div class="tx-switch">
    <button class="button1" data-md-color-primary="red" style="background-color:red">red</button>
    <button class="button1" data-md-color-primary="pink" style="background-color:pink;color:black">pink</button>
    <button class="button1" data-md-color-primary="purple" style="background-color:purple">purple</button>
    <button class="button1" data-md-color-primary="indigo" style="background-color:indigo">indigo</button>
    <button class="button1" data-md-color-primary="blue" style="background-color:blue">blue</button>
    <button class="button1" data-md-color-primary="cyan" style="background-color:cyan;color:black">cyan</button>
    <button class="button1" data-md-color-primary="teal" style="background-color:teal">teal</button>
    <button class="button1" data-md-color-primary="green" style="background-color:green">green</button>
    <button class="button1" data-md-color-primary="lime" style="background-color:lime;color:black">lime</button>
    <button class="button1" data-md-color-primary="orange" style="background-color:orange;color:black">orange</button>
    <button class="button1" data-md-color-primary="brown" style="background-color:brown;border-radius:3px">brown</button>
    <!-- <button class="button1" data-md-color-primary="grey" style="background-color:grey">grey</button> -->
    <button class="button1" data-md-color-primary="black" style="background-color:black">black</button>
    <button class="button1" data-md-color-primary="white" style="background-color:white;color:black">white</button>
    </div>
    
    <script>
    var buttons = document.querySelectorAll("button[data-md-color-primary]")
    buttons.forEach(function(button) {
            button.addEventListener("click", function() {
            var attr = this.getAttribute("data-md-color-primary")
            document.body.setAttribute("data-md-color-primary", attr)
            localStorage.setItem("data-md-color-primary",attr);
            })
    })
    </script>
    
    <h2 ><!-- 评论 -->评论区~</h2>
    
    有用的话请给我个赞和 star => <a href="https://cindyzhou2003.github.io/mymkdocs/">
        <img alt="GitHub stars" src="https://img.shields.io/github/stars/CindyZhou2003/mymkdocs.svg?style=plastic&amp;label=Stars"></a>
    
    </br>
    
    快来跟我聊天~
    
    </div>
    
    <script src="https://giscus.app/client.js"
            data-repo="xuan-insr/discussion"
            data-repo-id="R_kgDOIUW7XA"
            data-category="General"
            data-category-id="DIC_kwDOIUW7XM4CSOC3"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="dark"
            data-lang="zh-CN"
            crossorigin="anonymous"
            async>
    
    updateScheme();
    
    </script>
    
    <!-- Synchronize Giscus theme with palette -->
    <script>
    var giscus = document.querySelector("script[src*=giscus]")
    
    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"
        giscus.setAttribute("data-theme", theme) 
    }
    
    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
            var theme = palette.color.scheme === "slate" ? "dark" : "light"
            localStorage.setItem("data-md-color-scheme", palette.color.scheme === "slate" ? "slate" : "default");
            /* Instruct Giscus to change theme */
            var frame = document.querySelector(".giscus-frame")
            frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
            )
        }
        })
    })
    </script>
                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 <a href="https://github.com/CindyZhou2003/mymkdocs"  target="_blank" rel="noopener">Cindy</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/CindyZhou2003/mymkdocs" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
        <script src="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
      
        <script src="../js/katex.js"></script>
      
        <script src="../js/tablesort.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>