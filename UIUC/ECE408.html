
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Cindy的笔记本">
      
      
      
        <link rel="canonical" href="https://cindyzhou2003.github.io/mymkdocs/UIUC/ECE408.html">
      
      
        <link rel="prev" href="../ZJU/%E4%B9%A0%E6%A6%82.html">
      
      
        <link rel="next" href="ECE448.html">
      
      
      <link rel="icon" href="../assets/images/favcion.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>ECE408/CS483 Applied Parallel Programming - Cindy的笔记本</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW+WenKai:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"LXGW WenKai";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/neoteroi-mkdocs.css">
    
      <link rel="stylesheet" href="../css/style.css">
    
      <link rel="stylesheet" href="../css/font.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="forest" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ce408cs483-applied-parallel-programming" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="Cindy的笔记本" class="md-header__button md-logo" aria-label="Cindy的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M384 512H96c-53 0-96-43-96-96V96C0 43 43 0 96 0h304c26.5 0 48 21.5 48 48v288c0 20.9-13.4 38.7-32 45.3V448c17.7 0 32 14.3 32 32s-14.3 32-32 32zM96 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h256v-64zm32-232c0 13.3 10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24H152c-13.3 0-24 10.7-24 24m24 72c-13.3 0-24 10.7-24 24s10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cindy的笔记本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ECE408/CS483 Applied Parallel Programming
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="forest" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="forest-dark" data-md-color-primary="Brown" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/CindyZhou2003/mymkdocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Cindy's notebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../index.html" class="md-tabs__link">
          
  
  
    
  
  主页🤖

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ZJU/DM.html" class="md-tabs__link">
          
  
  
    
  
  ZJU-SE课程📝

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="ECE408.html" class="md-tabs__link">
          
  
  
    
  
  UIUC-MEng courses📚

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../skills/Algorithm.html" class="md-tabs__link">
          
  
  
    
  
  技能⚙️

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../abroad/IELTs_speaking1.html" class="md-tabs__link">
          
  
  
    
  
  出国✈️

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../work/Interview.html" class="md-tabs__link">
          
  
  
    
  
  找工

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../other/test.html" class="md-tabs__link">
          
  
  
    
  
  其他🎊

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cindy的笔记本" class="md-nav__button md-logo" aria-label="Cindy的笔记本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M384 512H96c-53 0-96-43-96-96V96C0 43 43 0 96 0h304c26.5 0 48 21.5 48 48v288c0 20.9-13.4 38.7-32 45.3V448c17.7 0 32 14.3 32 32s-14.3 32-32 32zM96 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h256v-64zm32-232c0 13.3 10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24H152c-13.3 0-24 10.7-24 24m24 72c-13.3 0-24 10.7-24 24s10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>

    </a>
    Cindy的笔记本
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CindyZhou2003/mymkdocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Cindy's notebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../index.html" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    主页🤖
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            主页🤖
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ZJU-SE课程📝
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            ZJU-SE课程📝
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大一春夏
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            大一春夏
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/DM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    离散数学及其应用
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大二秋冬
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            大二秋冬
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/OOP.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    面向对象程序设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/FDS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据结构基础
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大二春夏
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            大二春夏
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/ADS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    高级数据结构与算法分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/DB.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据库系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/ML.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    机器学习（国际化）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/PIS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    信息安全原理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大三秋冬
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            大三秋冬
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/OS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/CN.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    计算机网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/%E6%AF%9B%E6%A6%82.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    毛概
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/IoT.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    物联网技术基础与应用开发
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/SQAT.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    软件质量与保证测试
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大三春夏
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            大三春夏
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/CLDF.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数字逻辑设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ZJU/%E4%B9%A0%E6%A6%82.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    习概
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    UIUC-MEng courses📚
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            UIUC-MEng courses📚
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fall 2025
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Fall 2025
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ECE408/CS483 Applied Parallel Programming
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="ECE408.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ECE408/CS483 Applied Parallel Programming
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1 Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#post-dennard-technology-pivot-parallelism-and-heterogeneity" class="md-nav__link">
    <span class="md-ellipsis">
      Post-Dennard technology pivot – parallelism and heterogeneity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-vs-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      CPU vs GPU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-programming-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Programming Frameworks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallel Programming Frameworks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parallel-computing-challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Computing Challenges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing-pitfall" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Computing Pitfall（陷阱）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amdahls-law" class="md-nav__link">
    <span class="md-ellipsis">
      Amdahl's Law
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-introduction-to-cuda-c-and-data-parallel-programming" class="md-nav__link">
    <span class="md-ellipsis">
      2 Introduction to CUDA C and Data Parallel Programming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 Introduction to CUDA C and Data Parallel Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#types-of-parallelism" class="md-nav__link">
    <span class="md-ellipsis">
      Types of Parallelism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cudaopencl-execution-mode" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA/OpenCL Execution Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threads" class="md-nav__link">
    <span class="md-ellipsis">
      Threads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-addition" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Addition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vector Addition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-organization" class="md-nav__link">
    <span class="md-ellipsis">
      System Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-vector-addition-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      A vector addition kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-device-memory-management-api" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA Device Memory Management API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CUDA Device Memory Management API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-for-managing-device-global-memory" class="md-nav__link">
    <span class="md-ellipsis">
      API for managing device global memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launching-a-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Launching a Grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-addition-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Addition Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiling-a-cuda-program" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling A CUDA Program
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiling A CUDA Program">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-declarations-in-cuda" class="md-nav__link">
    <span class="md-ellipsis">
      Function Declarations in CUDA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-on-function-declarations" class="md-nav__link">
    <span class="md-ellipsis">
      More on Function Declarations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asynchronous-kernel-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Asynchronous Kernel Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-checking" class="md-nav__link">
    <span class="md-ellipsis">
      Error Checking
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    <span class="md-ellipsis">
      Problems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-cuda-parallel-execution-model-multidimensional-grids-data" class="md-nav__link">
    <span class="md-ellipsis">
      3 CUDA Parallel Execution Model: Multidimensional Grids &amp; Data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 CUDA Parallel Execution Model: Multidimensional Grids &amp; Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-thread-grids-are-multi-dimensional" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA Thread Grids are Multi-Dimensional
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CUDA Thread Grids are Multi-Dimensional">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#one-dimensional-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      One Dimensional Indexing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multidimensional-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      Multidimensional Indexing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-multidimensional-grids" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring Multidimensional Grids
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuring Multidimensional Grids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-built-in-dim3-type" class="md-nav__link">
    <span class="md-ellipsis">
      Use built-in dim3 type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layout-of-multidimensional-data" class="md-nav__link">
    <span class="md-ellipsis">
      Layout of Multidimensional Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rgb-to-gray-scale-kernel-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      RGB to Gray-Scale Kernel Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blur-kernel-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Blur Kernel Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matrix-matrix-multiplication" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix-Matrix Multiplication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-compute-architecture-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      4 Compute Architecture and Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 Compute Architecture and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executing-thread-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Executing Thread Blocks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Executing Thread Blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      GPU Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#assigning-blocks-to-sms" class="md-nav__link">
    <span class="md-ellipsis">
      Assigning Blocks to SMs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronization-across-thread-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization across Thread Blocks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sm-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      SM Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SM Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#warps" class="md-nav__link">
    <span class="md-ellipsis">
      Warps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-divergence" class="md-nav__link">
    <span class="md-ellipsis">
      Control Divergence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoiding-branch-divergence" class="md-nav__link">
    <span class="md-ellipsis">
      Avoiding Branch Divergence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lantency-hiding" class="md-nav__link">
    <span class="md-ellipsis">
      Lantency hiding 延迟隐藏
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#occupancy" class="md-nav__link">
    <span class="md-ellipsis">
      Occupancy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-granularity-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Block Granularity Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving" class="md-nav__link">
    <span class="md-ellipsis">
      Problem solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-cuda-memory-model" class="md-nav__link">
    <span class="md-ellipsis">
      5 CUDA Memory Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 CUDA Memory Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-von-neumann-model" class="md-nav__link">
    <span class="md-ellipsis">
      The Von-Neumann Model 冯诺依曼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmers-view-of-cuda-memories" class="md-nav__link">
    <span class="md-ellipsis">
      Programmer’s View of CUDA Memories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registers-vs-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Registers vs Memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallelize-elements-of-p" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelize Elements of P
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallelize Elements of P">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compute-using-2d-blocks-in-a-2d-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Compute Using 2D Blocks in a 2D Grid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-invocation-host-side-code" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Invocation (Host-side Code)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-function" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Function
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kernel Function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matrix-multiplication-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix Multiplication Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_1" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-locality-and-tiled-matrix-multiply" class="md-nav__link">
    <span class="md-ellipsis">
      6 Data Locality and Tiled Matrix Multiply
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6 Data Locality and Tiled Matrix Multiply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Metrics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-bound-and-the-roofline-model" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Bound and the Roofline Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-common-programming-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      A Common Programming Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A Common Programming Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiled-multiply" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled Multiply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiled-matrix-matrix-multiplication" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled Matrix-Matrix Multiplication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bulk-synchronous-steps-based-on-barriers" class="md-nav__link">
    <span class="md-ellipsis">
      Bulk Synchronous Steps Based on Barriers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boundary-conditions" class="md-nav__link">
    <span class="md-ellipsis">
      Boundary Conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      Bottleneck 瓶颈
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bottleneck 瓶颈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-and-occupancy" class="md-nav__link">
    <span class="md-ellipsis">
      Memory and Occupancy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-shared-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Shared Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiling-on-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      Tiling on CPU
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-dram-bandwidth-and-other-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      7 DRAM Bandwidth and other Performance Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7 DRAM Bandwidth and other Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dram" class="md-nav__link">
    <span class="md-ellipsis">
      DRAM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-coalescing" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Coalescing 内存合并
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Coalescing 内存合并">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matrix-matrix-multiplication_1" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix-matrix multiplication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-of-shared-memory-enables-coalescing" class="md-nav__link">
    <span class="md-ellipsis">
      Use of Shared Memory Enables Coalescing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#latency-hiding-with-multiple-banks" class="md-nav__link">
    <span class="md-ellipsis">
      Latency Hiding with Multiple Banks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fine-grain-thread-granularity" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-Grain Thread Granularity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fine-Grain Thread Granularity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-coarsening" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Coarsening 粗化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loop-unrolling" class="md-nav__link">
    <span class="md-ellipsis">
      Loop unrolling 循环展开
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instruction-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Scheduling 指令调度
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#double-buffering" class="md-nav__link">
    <span class="md-ellipsis">
      Double Buffering 双缓冲
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checklist-of-common-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Checklist of Common Optimizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checklist of Common Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trade-off-between-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Trade-off Between Optimizations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_2" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-convolution-concept-constant-cache" class="md-nav__link">
    <span class="md-ellipsis">
      8 Convolution Concept; Constant Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8 Convolution Concept; Constant Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convolution-applications" class="md-nav__link">
    <span class="md-ellipsis">
      Convolution Applications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Convolution Applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1d-kernel-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      1D kernel convolution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-convolution-with-boundary-condition-handling" class="md-nav__link">
    <span class="md-ellipsis">
      2D Convolution with boundary condition handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmer-view-of-cuda-memories" class="md-nav__link">
    <span class="md-ellipsis">
      Programmer View of CUDA Memories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-hierarchies" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Hierarchies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Hierarchies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-2d-convolution-kernel-using-constant-memory-for-f" class="md-nav__link">
    <span class="md-ellipsis">
      A 2D convolution kernel using constant memory for F
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caches-and-locality" class="md-nav__link">
    <span class="md-ellipsis">
      Caches and Locality
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caches-cant-hold-everything" class="md-nav__link">
    <span class="md-ellipsis">
      Caches Can’t Hold Everything
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-memory-vs-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Shared Memory vs. Cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constant-cache-in-gpus" class="md-nav__link">
    <span class="md-ellipsis">
      Constant cache in GPUs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-constant-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Using Constant Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiled-convolution-with-halo-cells" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled convolution with halo cells
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tiled convolution with halo cells">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiled-1d-convolution-basic-idea" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled 1D Convolution Basic Idea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#three-tiling-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Three Tiling Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-2d-tiled-convolution-kernel-reuse-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      9 2D Tiled Convolution Kernel; Reuse Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9 2D Tiled Convolution Kernel; Reuse Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stencil-algorithms" class="md-nav__link">
    <span class="md-ellipsis">
      Stencil Algorithms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-2-parallelize-loading-of-a-tile" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 2: Parallelize Loading of a Tile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 2: Parallelize Loading of a Tile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parallelizing-tile-loading" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelizing Tile Loading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-block-dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Block Dimensions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-tiled-convolution-kernel-with-constant-memory" class="md-nav__link">
    <span class="md-ellipsis">
      2D Tiled Convolution Kernel (with constant memory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reuse-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Reuse Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reuse Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-small-1d-convolution-example" class="md-nav__link">
    <span class="md-ellipsis">
      A Small 1D Convolution Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-2d-convolution-example" class="md-nav__link">
    <span class="md-ellipsis">
      Example of 2D Convolution Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2bflop-for-untiled-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      2B/FLOP for Untiled Convolution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-hierarchy-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Hierarchy Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_3" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-introduction-to-ml-inference-and-training-in-dnns" class="md-nav__link">
    <span class="md-ellipsis">
      10 Introduction to ML; Inference and Training in DNNs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10 Introduction to ML; Inference and Training in DNNs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#machine-learning" class="md-nav__link">
    <span class="md-ellipsis">
      Machine Learning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classification" class="md-nav__link">
    <span class="md-ellipsis">
      Classification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linear-classificationperceptron" class="md-nav__link">
    <span class="md-ellipsis">
      Linear Classification(perceptron感知器)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-layer-perceptron-mlp-for-digit-recognition" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Layer Perceptron (MLP) for Digit Recognition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-Layer Perceptron (MLP) for Digit Recognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-do-we-determine-the-weights" class="md-nav__link">
    <span class="md-ellipsis">
      How Do We Determine the Weights?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-and-backward-propagation" class="md-nav__link">
    <span class="md-ellipsis">
      Forward and Backward Propagation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sigmoidlogistic-function" class="md-nav__link">
    <span class="md-ellipsis">
      Sigmoid/Logistic Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reluactivation-functions" class="md-nav__link">
    <span class="md-ellipsis">
      ReLU(Activation Functions)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-softmax-to-produce-probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Use Softmax to Produce Probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-function" class="md-nav__link">
    <span class="md-ellipsis">
      Error Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stochastic-gradient-descent" class="md-nav__link">
    <span class="md-ellipsis">
      Stochastic Gradient Descent 随机梯度下降
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-gradient-update-with-one-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Gradient Update with One Layer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-computation-in-cnns-and-transformers" class="md-nav__link">
    <span class="md-ellipsis">
      11 Computation in CNNs and Transformers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11 Computation in CNNs and Transformers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-convolution-inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Example convolution Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      Why Convolution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Convolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convolution-vs-multi-layer-perceptron" class="md-nav__link">
    <span class="md-ellipsis">
      Convolution vs Multi-Layer Perceptron
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anatomy-of-a-convolution-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of a Convolution Layer 卷积层剖析
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-d-pooling-subsampling" class="md-nav__link">
    <span class="md-ellipsis">
      2-D Pooling (Subsampling)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-propagation" class="md-nav__link">
    <span class="md-ellipsis">
      Forward Propagation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Forward Propagation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-code-forward-pooling-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Sequential Code: Forward Pooling Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#host-code-for-a-basic-kernel-cuda-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Host Code for a Basic Kernel: CUDA Grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-convolutional-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Forward Convolutional Layer 卷积前向传播
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-atomic-operations-and-histogramming" class="md-nav__link">
    <span class="md-ellipsis">
      13 Atomic Operations and Histogramming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13 Atomic Operations and Histogramming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-races" class="md-nav__link">
    <span class="md-ellipsis">
      Data Races
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quiz" class="md-nav__link">
    <span class="md-ellipsis">
      Quiz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#midterm" class="md-nav__link">
    <span class="md-ellipsis">
      Midterm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Midterm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-code-for-2d-convolution-tiled-matrix-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Cuda code for 2D convolution tiled matrix operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cuda code for 2D convolution tiled matrix operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#host-code" class="md-nav__link">
    <span class="md-ellipsis">
      Host code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-kernel-code" class="md-nav__link">
    <span class="md-ellipsis">
      Cuda kernel code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-tiled-matrix-operation-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      3D tiled matrix operation Convolution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ECE448.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ECE448/CS440 Artificial Intelligence
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ECE598.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ECE498/598 Deep Generative Models
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    技能⚙️
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            技能⚙️
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skills/Algorithm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skills/deeplearning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    深度学习
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    出国✈️
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            出国✈️
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    雅思口语
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            雅思口语
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../abroad/IELTs_speaking1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第一次
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../abroad/IELTs_speaking2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第二次
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../abroad/IELTs_writing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    雅思作文
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    找工
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            找工
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../work/Interview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    面试
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    其他🎊
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            其他🎊
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other/test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other/Debug_issue.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    部署网站时的问题
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1 Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#post-dennard-technology-pivot-parallelism-and-heterogeneity" class="md-nav__link">
    <span class="md-ellipsis">
      Post-Dennard technology pivot – parallelism and heterogeneity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-vs-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      CPU vs GPU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-programming-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Programming Frameworks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallel Programming Frameworks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parallel-computing-challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Computing Challenges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing-pitfall" class="md-nav__link">
    <span class="md-ellipsis">
      Parallel Computing Pitfall（陷阱）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amdahls-law" class="md-nav__link">
    <span class="md-ellipsis">
      Amdahl's Law
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-introduction-to-cuda-c-and-data-parallel-programming" class="md-nav__link">
    <span class="md-ellipsis">
      2 Introduction to CUDA C and Data Parallel Programming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 Introduction to CUDA C and Data Parallel Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#types-of-parallelism" class="md-nav__link">
    <span class="md-ellipsis">
      Types of Parallelism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cudaopencl-execution-mode" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA/OpenCL Execution Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threads" class="md-nav__link">
    <span class="md-ellipsis">
      Threads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-addition" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Addition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vector Addition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-organization" class="md-nav__link">
    <span class="md-ellipsis">
      System Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-vector-addition-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      A vector addition kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-device-memory-management-api" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA Device Memory Management API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CUDA Device Memory Management API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-for-managing-device-global-memory" class="md-nav__link">
    <span class="md-ellipsis">
      API for managing device global memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launching-a-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Launching a Grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-addition-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Addition Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiling-a-cuda-program" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling A CUDA Program
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiling A CUDA Program">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-declarations-in-cuda" class="md-nav__link">
    <span class="md-ellipsis">
      Function Declarations in CUDA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-on-function-declarations" class="md-nav__link">
    <span class="md-ellipsis">
      More on Function Declarations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asynchronous-kernel-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Asynchronous Kernel Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-checking" class="md-nav__link">
    <span class="md-ellipsis">
      Error Checking
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    <span class="md-ellipsis">
      Problems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-cuda-parallel-execution-model-multidimensional-grids-data" class="md-nav__link">
    <span class="md-ellipsis">
      3 CUDA Parallel Execution Model: Multidimensional Grids &amp; Data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 CUDA Parallel Execution Model: Multidimensional Grids &amp; Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-thread-grids-are-multi-dimensional" class="md-nav__link">
    <span class="md-ellipsis">
      CUDA Thread Grids are Multi-Dimensional
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CUDA Thread Grids are Multi-Dimensional">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#one-dimensional-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      One Dimensional Indexing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multidimensional-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      Multidimensional Indexing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-multidimensional-grids" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring Multidimensional Grids
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuring Multidimensional Grids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-built-in-dim3-type" class="md-nav__link">
    <span class="md-ellipsis">
      Use built-in dim3 type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layout-of-multidimensional-data" class="md-nav__link">
    <span class="md-ellipsis">
      Layout of Multidimensional Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rgb-to-gray-scale-kernel-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      RGB to Gray-Scale Kernel Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blur-kernel-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Blur Kernel Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matrix-matrix-multiplication" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix-Matrix Multiplication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-compute-architecture-and-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      4 Compute Architecture and Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 Compute Architecture and Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executing-thread-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Executing Thread Blocks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Executing Thread Blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      GPU Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#assigning-blocks-to-sms" class="md-nav__link">
    <span class="md-ellipsis">
      Assigning Blocks to SMs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronization-across-thread-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization across Thread Blocks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sm-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      SM Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SM Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#warps" class="md-nav__link">
    <span class="md-ellipsis">
      Warps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-divergence" class="md-nav__link">
    <span class="md-ellipsis">
      Control Divergence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoiding-branch-divergence" class="md-nav__link">
    <span class="md-ellipsis">
      Avoiding Branch Divergence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lantency-hiding" class="md-nav__link">
    <span class="md-ellipsis">
      Lantency hiding 延迟隐藏
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#occupancy" class="md-nav__link">
    <span class="md-ellipsis">
      Occupancy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-granularity-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Block Granularity Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving" class="md-nav__link">
    <span class="md-ellipsis">
      Problem solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-cuda-memory-model" class="md-nav__link">
    <span class="md-ellipsis">
      5 CUDA Memory Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 CUDA Memory Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-von-neumann-model" class="md-nav__link">
    <span class="md-ellipsis">
      The Von-Neumann Model 冯诺依曼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmers-view-of-cuda-memories" class="md-nav__link">
    <span class="md-ellipsis">
      Programmer’s View of CUDA Memories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registers-vs-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Registers vs Memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallelize-elements-of-p" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelize Elements of P
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallelize Elements of P">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compute-using-2d-blocks-in-a-2d-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Compute Using 2D Blocks in a 2D Grid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-invocation-host-side-code" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Invocation (Host-side Code)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-function" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Function
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kernel Function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matrix-multiplication-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix Multiplication Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_1" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-locality-and-tiled-matrix-multiply" class="md-nav__link">
    <span class="md-ellipsis">
      6 Data Locality and Tiled Matrix Multiply
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6 Data Locality and Tiled Matrix Multiply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Metrics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-bound-and-the-roofline-model" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Bound and the Roofline Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-common-programming-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      A Common Programming Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A Common Programming Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiled-multiply" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled Multiply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiled-matrix-matrix-multiplication" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled Matrix-Matrix Multiplication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bulk-synchronous-steps-based-on-barriers" class="md-nav__link">
    <span class="md-ellipsis">
      Bulk Synchronous Steps Based on Barriers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boundary-conditions" class="md-nav__link">
    <span class="md-ellipsis">
      Boundary Conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      Bottleneck 瓶颈
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bottleneck 瓶颈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-and-occupancy" class="md-nav__link">
    <span class="md-ellipsis">
      Memory and Occupancy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-shared-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Shared Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiling-on-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      Tiling on CPU
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-dram-bandwidth-and-other-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      7 DRAM Bandwidth and other Performance Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7 DRAM Bandwidth and other Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dram" class="md-nav__link">
    <span class="md-ellipsis">
      DRAM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-coalescing" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Coalescing 内存合并
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Coalescing 内存合并">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matrix-matrix-multiplication_1" class="md-nav__link">
    <span class="md-ellipsis">
      Matrix-matrix multiplication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-of-shared-memory-enables-coalescing" class="md-nav__link">
    <span class="md-ellipsis">
      Use of Shared Memory Enables Coalescing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#latency-hiding-with-multiple-banks" class="md-nav__link">
    <span class="md-ellipsis">
      Latency Hiding with Multiple Banks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fine-grain-thread-granularity" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-Grain Thread Granularity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fine-Grain Thread Granularity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-coarsening" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Coarsening 粗化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loop-unrolling" class="md-nav__link">
    <span class="md-ellipsis">
      Loop unrolling 循环展开
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instruction-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Scheduling 指令调度
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#double-buffering" class="md-nav__link">
    <span class="md-ellipsis">
      Double Buffering 双缓冲
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checklist-of-common-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Checklist of Common Optimizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checklist of Common Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trade-off-between-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Trade-off Between Optimizations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_2" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-convolution-concept-constant-cache" class="md-nav__link">
    <span class="md-ellipsis">
      8 Convolution Concept; Constant Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8 Convolution Concept; Constant Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convolution-applications" class="md-nav__link">
    <span class="md-ellipsis">
      Convolution Applications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Convolution Applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1d-kernel-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      1D kernel convolution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-convolution-with-boundary-condition-handling" class="md-nav__link">
    <span class="md-ellipsis">
      2D Convolution with boundary condition handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmer-view-of-cuda-memories" class="md-nav__link">
    <span class="md-ellipsis">
      Programmer View of CUDA Memories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-hierarchies" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Hierarchies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Hierarchies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-2d-convolution-kernel-using-constant-memory-for-f" class="md-nav__link">
    <span class="md-ellipsis">
      A 2D convolution kernel using constant memory for F
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caches-and-locality" class="md-nav__link">
    <span class="md-ellipsis">
      Caches and Locality
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caches-cant-hold-everything" class="md-nav__link">
    <span class="md-ellipsis">
      Caches Can’t Hold Everything
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-memory-vs-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Shared Memory vs. Cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constant-cache-in-gpus" class="md-nav__link">
    <span class="md-ellipsis">
      Constant cache in GPUs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-constant-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Using Constant Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tiled-convolution-with-halo-cells" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled convolution with halo cells
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tiled convolution with halo cells">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiled-1d-convolution-basic-idea" class="md-nav__link">
    <span class="md-ellipsis">
      Tiled 1D Convolution Basic Idea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#three-tiling-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Three Tiling Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-2d-tiled-convolution-kernel-reuse-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      9 2D Tiled Convolution Kernel; Reuse Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9 2D Tiled Convolution Kernel; Reuse Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stencil-algorithms" class="md-nav__link">
    <span class="md-ellipsis">
      Stencil Algorithms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strategy-2-parallelize-loading-of-a-tile" class="md-nav__link">
    <span class="md-ellipsis">
      Strategy 2: Parallelize Loading of a Tile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 2: Parallelize Loading of a Tile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parallelizing-tile-loading" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelizing Tile Loading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-block-dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Block Dimensions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-tiled-convolution-kernel-with-constant-memory" class="md-nav__link">
    <span class="md-ellipsis">
      2D Tiled Convolution Kernel (with constant memory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reuse-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Reuse Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reuse Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-small-1d-convolution-example" class="md-nav__link">
    <span class="md-ellipsis">
      A Small 1D Convolution Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-2d-convolution-example" class="md-nav__link">
    <span class="md-ellipsis">
      Example of 2D Convolution Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2bflop-for-untiled-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      2B/FLOP for Untiled Convolution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-hierarchy-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Hierarchy Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-solving_3" class="md-nav__link">
    <span class="md-ellipsis">
      Problem Solving
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-introduction-to-ml-inference-and-training-in-dnns" class="md-nav__link">
    <span class="md-ellipsis">
      10 Introduction to ML; Inference and Training in DNNs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10 Introduction to ML; Inference and Training in DNNs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#machine-learning" class="md-nav__link">
    <span class="md-ellipsis">
      Machine Learning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classification" class="md-nav__link">
    <span class="md-ellipsis">
      Classification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linear-classificationperceptron" class="md-nav__link">
    <span class="md-ellipsis">
      Linear Classification(perceptron感知器)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-layer-perceptron-mlp-for-digit-recognition" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Layer Perceptron (MLP) for Digit Recognition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-Layer Perceptron (MLP) for Digit Recognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-do-we-determine-the-weights" class="md-nav__link">
    <span class="md-ellipsis">
      How Do We Determine the Weights?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-and-backward-propagation" class="md-nav__link">
    <span class="md-ellipsis">
      Forward and Backward Propagation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sigmoidlogistic-function" class="md-nav__link">
    <span class="md-ellipsis">
      Sigmoid/Logistic Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reluactivation-functions" class="md-nav__link">
    <span class="md-ellipsis">
      ReLU(Activation Functions)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-softmax-to-produce-probabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Use Softmax to Produce Probabilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-function" class="md-nav__link">
    <span class="md-ellipsis">
      Error Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stochastic-gradient-descent" class="md-nav__link">
    <span class="md-ellipsis">
      Stochastic Gradient Descent 随机梯度下降
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-gradient-update-with-one-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Gradient Update with One Layer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-computation-in-cnns-and-transformers" class="md-nav__link">
    <span class="md-ellipsis">
      11 Computation in CNNs and Transformers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11 Computation in CNNs and Transformers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-convolution-inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Example convolution Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      Why Convolution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Convolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convolution-vs-multi-layer-perceptron" class="md-nav__link">
    <span class="md-ellipsis">
      Convolution vs Multi-Layer Perceptron
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anatomy-of-a-convolution-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of a Convolution Layer 卷积层剖析
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-d-pooling-subsampling" class="md-nav__link">
    <span class="md-ellipsis">
      2-D Pooling (Subsampling)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-propagation" class="md-nav__link">
    <span class="md-ellipsis">
      Forward Propagation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Forward Propagation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-code-forward-pooling-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Sequential Code: Forward Pooling Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#host-code-for-a-basic-kernel-cuda-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Host Code for a Basic Kernel: CUDA Grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-convolutional-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Forward Convolutional Layer 卷积前向传播
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-atomic-operations-and-histogramming" class="md-nav__link">
    <span class="md-ellipsis">
      13 Atomic Operations and Histogramming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13 Atomic Operations and Histogramming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-races" class="md-nav__link">
    <span class="md-ellipsis">
      Data Races
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quiz" class="md-nav__link">
    <span class="md-ellipsis">
      Quiz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#midterm" class="md-nav__link">
    <span class="md-ellipsis">
      Midterm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Midterm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-code-for-2d-convolution-tiled-matrix-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Cuda code for 2D convolution tiled matrix operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cuda code for 2D convolution tiled matrix operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#host-code" class="md-nav__link">
    <span class="md-ellipsis">
      Host code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuda-kernel-code" class="md-nav__link">
    <span class="md-ellipsis">
      Cuda kernel code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-tiled-matrix-operation-convolution" class="md-nav__link">
    <span class="md-ellipsis">
      3D tiled matrix operation Convolution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ce408cs483-applied-parallel-programming">CE408/CS483 Applied Parallel Programming<a class="headerlink" href="#ce408cs483-applied-parallel-programming" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 10195 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M360.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m64.6 136.1c-12.5 12.5-12.5 32.8 0 45.3l73.4 73.4-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0zm-274.7 0c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l73.3-73.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span> 864 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 108 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 45 分钟</p>
</div>
<blockquote>
<p><a href="https://canvas.illinois.edu/courses/60979/assignments/syllabus">https://canvas.illinois.edu/courses/60979/assignments/syllabus</a> </p>
<p><a href="https://uiuc.chat/ECE408FA25/chat">https://uiuc.chat/ECE408FA25/chat</a></p>
</blockquote>
<h2 id="1-introduction">1 Introduction<a class="headerlink" href="#1-introduction" title="Permanent link">&para;</a></h2>
<p>CPU(central processing unit)</p>
<p>GPU(graphical processing unit)</p>
<h3 id="post-dennard-technology-pivot-parallelism-and-heterogeneity">Post-Dennard technology pivot – parallelism and heterogeneity<a class="headerlink" href="#post-dennard-technology-pivot-parallelism-and-heterogeneity" title="Permanent link">&para;</a></h3>
<p><strong>The Moore’s Law</strong> (Imperative) drove feature sizes down, doubling the number of transistors/unit area every 18-24 months</p>
<ul>
<li>Exponential increase in clock speed</li>
</ul>
<p><strong>Dennard Scaling</strong> (based on physics) drove clock speeds up</p>
<ul>
<li>ended around 2005-2006</li>
</ul>
<p><strong>multicore</strong>: execution speed of sequential programs</p>
<p><strong>many-thread</strong>: execution throughput of parallel applications</p>
<h3 id="cpu-vs-gpu">CPU vs GPU<a class="headerlink" href="#cpu-vs-gpu" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250828093148709.png" alt="image-20250828093148709" style="zoom:50%;" /></p>
<table>
<thead>
<tr>
<th style="text-align: center;">CPU</th>
<th style="text-align: center;">GPU</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">A few powerful <strong>ALUs</strong>(Arithmetic Logic Unit)</td>
<td style="text-align: center;">Many small ALUs</td>
</tr>
<tr>
<td style="text-align: center;">Reduced operation latency</td>
<td style="text-align: center;">Long latency, high throughput</td>
</tr>
<tr>
<td style="text-align: center;">Large <strong>caches</strong></td>
<td style="text-align: center;">Heavily pipelined for further throughput</td>
</tr>
<tr>
<td style="text-align: center;">Convert long latency memory accesses to short latency cache accesses</td>
<td style="text-align: center;">Small <strong>caches</strong></td>
</tr>
<tr>
<td style="text-align: center;">Sophisticated <strong>control</strong></td>
<td style="text-align: center;">More area dedicated to computation</td>
</tr>
<tr>
<td style="text-align: center;">Branch prediction to reduce control hazards</td>
<td style="text-align: center;">Simple <strong>control</strong></td>
</tr>
<tr>
<td style="text-align: center;">Data forwarding to reduce data hazards</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">Modest multithreading to hide short latency</td>
<td style="text-align: center;">A massive number of threads to hide the very high latency!</td>
</tr>
<tr>
<td style="text-align: center;"><strong>High clock frequency</strong></td>
<td style="text-align: center;">Moderate clock frequency</td>
</tr>
<tr>
<td style="text-align: center;"><strong>latency-oriented</strong> 延迟导向</td>
<td style="text-align: center;"><strong>throughput-oriented</strong> 吞吐量导向</td>
</tr>
</tbody>
</table>
<p>CPUs for <strong>sequential parts</strong> where latency hurts</p>
<ul>
<li>CPUs can be 10+X faster than GPUs for sequential code</li>
</ul>
<p>GPUs for <strong>parallel parts</strong> where throughput wins</p>
<ul>
<li>GPUs can be 10+X faster than CPUs for parallel code</li>
</ul>
<h3 id="parallel-programming-frameworks">Parallel Programming Frameworks<a class="headerlink" href="#parallel-programming-frameworks" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!NOTE]</p>
<p>Why GPUs?</p>
<p>Why repurpose a graphics processing architecture instead of designing a throughput-oriented architecture from scratch?</p>
<ul>
<li>Chips are expensive to build and require a large volume of sales to amortize the cost</li>
<li>This makes the chip market very difficult to penetrate</li>
<li>When parallel computing became mainstream, GPUs already had (and still have) a large installed base from the gaming sector</li>
</ul>
</blockquote>
<h4 id="parallel-computing-challenges">Parallel Computing Challenges<a class="headerlink" href="#parallel-computing-challenges" title="Permanent link">&para;</a></h4>
<p>Massive Parallelism demands Regularity -&gt; Load Balance</p>
<p>Global Memory Bandwidth -&gt; Ideal vs. Reality</p>
<p>Conflicting Data Accesses Cause Serialization and Delays </p>
<ul>
<li>Massively parallel execution cannot afford serialization</li>
<li>Contentions in accessing critical data causes serialization</li>
</ul>
<h4 id="parallel-computing-pitfall">Parallel Computing Pitfall（陷阱）<a class="headerlink" href="#parallel-computing-pitfall" title="Permanent link">&para;</a></h4>
<p>Consider an application where:</p>
<ol>
<li>The sequential execution time is 100s</li>
<li>The fraction of execution that is parallelizable is 90%</li>
<li>The speedup achieved on the parallelizable part is 1000×</li>
</ol>
<p>What is the overall speedup of the application?
$$
t_{parallel}=(1-0.9)\times 100s +\frac{0.9 \times 100s}{1000}=10.09s\
speedup=\frac{t_{sequential}}{t_{parallel}}=\frac{100s}{10.09s}=9.91\times \text{（9.91为倍数）}
$$</p>
<h4 id="amdahls-law">Amdahl's Law<a class="headerlink" href="#amdahls-law" title="Permanent link">&para;</a></h4>
<p><strong>阿姆达尔定律</strong>：<a href="https://zh.wikipedia.org/wiki/中央處理器">处理器</a><a href="https://zh.wikipedia.org/wiki/並行運算">并行运算</a>之后效率提升的能力</p>
<p><img src="./assets/image-20250828153730248.png" alt="image-20250828153730248" style="zoom: 33%;" /></p>
<p>The maximum speedup of a parallel program is limited by the fraction of execution that is parallelizable, namely, <span class="arithmatex">\(speedup&lt;\frac{1}{1-p}\)</span></p>
<h2 id="2-introduction-to-cuda-c-and-data-parallel-programming">2 Introduction to CUDA C and Data Parallel Programming<a class="headerlink" href="#2-introduction-to-cuda-c-and-data-parallel-programming" title="Permanent link">&para;</a></h2>
<h3 id="types-of-parallelism">Types of Parallelism<a class="headerlink" href="#types-of-parallelism" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: center;">Task Parallelism</th>
<th style="text-align: center;">Data Parallelism</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Different operations performed on same or different data</td>
<td style="text-align: center;">Same operations performed on different data</td>
</tr>
<tr>
<td style="text-align: center;">Usually, a modest number of tasks unleashing a modest amount of parallelism</td>
<td style="text-align: center;">Potentially massive amounts of data unleashing massive amounts of parallelism(Most suitable for GPUs)</td>
</tr>
<tr>
<td style="text-align: center;"><img src="./assets/image-20250828185000905.png" alt="image-20250828185000905" style="zoom:40%;" /></td>
<td style="text-align: center;"><img src="./assets/image-20250828185016719.png" alt="image-20250828185016719" style="zoom:40%;" /></td>
</tr>
</tbody>
</table>
<h3 id="cudaopencl-execution-mode">CUDA/OpenCL Execution Mode<a class="headerlink" href="#cudaopencl-execution-mode" title="Permanent link">&para;</a></h3>
<p><strong>Integrated Host +Device Application(C Program)</strong></p>
<ol>
<li>The execution starts with <em>host code</em> (CPU serial code). 主机代码在CPU上运行</li>
<li>When a kernel function is called, a large number of <em>threads</em> are launched on a device to execute the kernel. All the threads that are launched by a kernel call are collectively called a <strong>grid</strong>. </li>
<li>These threads are the primary vehicle of parallel execution in a CUDA platform</li>
<li>When all threads of a grid have completed their execution, the grid terminates, and the execution continues on the host until another grid is launched</li>
</ol>
<ul>
<li><strong>Host Code (C):</strong> Handles serial or modestly parallel tasks</li>
<li><strong>Device Kernel (C,SPMD Model):</strong> Executes highly parallel sections of the program GPU上运行设备代码</li>
</ul>
<h3 id="threads">Threads<a class="headerlink" href="#threads" title="Permanent link">&para;</a></h3>
<p>A CUDA <strong>kernel</strong> is executed as a grid(array) of threads</p>
<ul>
<li>All threads in the same grid run the <strong>same kernel</strong></li>
<li>Single Program Multiple Data (SPMD model)</li>
<li>Each thread has a <strong>unique index</strong> that it uses to compute memory addresses and make control decisions</li>
</ul>
<p>Thread as a basic unit of computing</p>
<ul>
<li>Threads within a block cooperate via <strong>shared memory, atomic operations</strong> and <strong>barrier synchronization</strong>.  块内的线程通过<strong>共享内存、原子操作</strong>和<strong>屏障同步</strong>进行协作。</li>
<li>Threads in different blocks cooperate less.</li>
</ul>
<p><img src="./assets/image-20250828201313613.png" alt="image-20250828201313613" style="zoom: 40%;" /><img src="./assets/image-20250828201435041.png" alt="image-20250828201435041" style="zoom:33%;" /></p>
<ul>
<li>Thread block and thread organization simplify memory addressing when processing multidimensional data</li>
<li><code>i = blockIdx.x * blockDim.x + threadIdx.x; C[i] = A[i] + B[i];</code></li>
</ul>
<h3 id="vector-addition">Vector Addition<a class="headerlink" href="#vector-addition" title="Permanent link">&para;</a></h3>
<p>We use vector addition to demonstrate the CUDA C program structure.</p>
<p>A simple traditional vector addition C code example.</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// Compute vector sum C = A+B</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vecAdd</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="c1">// Memory allocation for A_h, B_h, and C_h</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="c1">// I/O to read A_h and B_h, N elements...</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">vecAdd</span><span class="p">(</span><span class="n">A_h</span><span class="p">,</span><span class="w"> </span><span class="n">B_h</span><span class="p">,</span><span class="w"> </span><span class="n">C_h</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>主机的变量名称后缀为<code>_h</code>，使用设备的变量名称后缀为<code>_d</code></p>
<h4 id="system-organization">System Organization<a class="headerlink" href="#system-organization" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250828095258922.png" alt="image-20250828095258922" style="zoom:40%;" /></p>
<p>The CPU and GPU have <strong>separate memories</strong> and <strong>cannot access</strong> each others' memories</p>
<ul>
<li>Need to <strong>transfer</strong> data between them（下图五步操作）</li>
</ul>
<p><img src="./assets/image-20250828095329700.png" alt="image-20250828095329700" style="zoom:40%;" /></p>
<h4 id="a-vector-addition-kernel">A vector addition kernel<a class="headerlink" href="#a-vector-addition-kernel" title="Permanent link">&para;</a></h4>
<p>Outline of a revised vecAdd function that moves the work to a device.</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda.h&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vecAdd</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">C_d</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="err">…</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="mf">1.</span><span class="w"> </span><span class="c1">// Allocate device memory for A, B, and C</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// copy A and B to device memory </span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="mf">2.</span><span class="w"> </span><span class="c1">// Kernel launch code – to have the device</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="c1">// to perform the actual vector addition</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="mf">3.</span><span class="w"> </span><span class="c1">// copy C from the device memory</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="c1">// Free device vectors</span>
</span></code></pre></div></td></tr></table></div>
<p><code>vector A + B = vector C</code></p>
<p>Device code can:</p>
<ul>
<li>R/W per-thread registers</li>
<li>R/W per-grid global memory</li>
</ul>
<p>Host code can transfer data to/from per grid global memory</p>
<h3 id="cuda-device-memory-management-api">CUDA Device Memory Management API<a class="headerlink" href="#cuda-device-memory-management-api" title="Permanent link">&para;</a></h3>
<h4 id="api-for-managing-device-global-memory">API for managing device global memory<a class="headerlink" href="#api-for-managing-device-global-memory" title="Permanent link">&para;</a></h4>
<p><strong>Allocating memory</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cm">/*Allocating memory*/</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">cudaError_t</span><span class="w"> </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">devPtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="c1">//devPtr: Pointer to pointer to allocated device memory</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1">//size: Requested allocation size in byte</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="cm">/*VecAdd Host Code*/</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="c1">//详见下面</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Deallocating memory</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">cudaError_t</span><span class="w"> </span><span class="n">cudaFree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">devPtr</span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">//devPtr: Pointer to device memory to free</span>
</span></code></pre></div></td></tr></table></div>
<p><img src="./assets/image-20250902150849141.png" alt="image-20250902150849141" style="zoom:33%;" /></p>
<ul>
<li>指向设备全局内存中对象的指针变量后缀为<code>_d</code></li>
<li><code>A_d</code>, <code>B_d</code> 和 <code>C_d</code> 中的地址指向设备全局内存 device global memory 中的位置。这些地址不应在主机代码中间接引用。它们应该在调用 API 函数和内核函数时使用。</li>
</ul>
<p><strong>Copying memory</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">cudaError_t</span><span class="w"> </span><span class="nf">cudaMemcpy</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">cudaMemcpyKind</span><span class="w"> </span><span class="n">kind</span><span class="p">)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">//Example</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">A_h</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_h</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="w"> </span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">C_h</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li><code>dst</code>: Destination memory address</li>
<li><code>src</code>: Source memory address</li>
<li><code>count</code>: Size in bytes to copy</li>
<li><code>kind</code>: Type of transfer<ul>
<li><code>cudaMemcpyHostToHost</code></li>
<li><code>cudaMemcpyHostToDevice</code></li>
<li><code>cudaMemcpyDeviceToHost</code></li>
<li><code>cudaMemcpyDeviceToDevice</code></li>
</ul>
</li>
</ul>
<p><strong>Return type</strong>: <code>cudaError_t</code></p>
<ul>
<li>Helps with error checking (discussed later)</li>
</ul>
<p><strong>vecAdd Host Code</strong></p>
<p>完整版本</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">vecAdd</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">C_d</span><span class="p">;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="c1">// Transfer A and B to device memory (error-checking omitted)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="c1">// Allocate device memory for</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="c1">// Kernel invocation code – to be shown later</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="err">…</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="c1">// Transfer C from device to host</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="c1">// Free device memory for A, B, C</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">A_d</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">B_d</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">C_d</span><span class="p">);</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Simple strategy of <strong>Parallel Vector Addition</strong>: assign one GPU <strong>thread</strong> per vector element</p>
<h4 id="launching-a-grid">Launching a Grid<a class="headerlink" href="#launching-a-grid" title="Permanent link">&para;</a></h4>
<p>Threads in the same grid execute the same function known as a <strong>kernel</strong></p>
<p>A grid can be launched by calling a kernel and configuring it with appropriate grid and block sizes:</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">/</span><span class="n">numThreadsPerBlock</span><span class="p">;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">vecAddKernel</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="n">numBlocks</span><span class="p">,</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>If n is not a multiple of <code>numThreadsPerBlock</code>, fewer threads will be launched than desired</p>
<ul>
<li>Solution: use the ceiling to launch extra threads then omit the threads after the boundary:</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">vecAddKernel</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mf">256.0</span><span class="p">),</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>More Ways to Compute Grid Dimensions</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1">// Example #1</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">dim3</span><span class="w"> </span><span class="nf">DimGrid</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">numThreadsPerBlock</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DimGrid</span><span class="p">.</span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">dim3</span><span class="w"> </span><span class="n">DimBlock</span><span class="p">(</span><span class="n">numThreadsPerBlock</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">vecAddKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">DimGrid</span><span class="p">,</span><span class="w"> </span><span class="n">DimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="c1">// Example #2</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numBlocks</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="n">numBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">numThreadsPerBlock</span><span class="p">;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="n">vecAddKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">numBlocks</span><span class="p">,</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="vector-addition-kernel">Vector Addition Kernel<a class="headerlink" href="#vector-addition-kernel" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// Compute vector sum C = A+B</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="c1">// Each thread performs one pair-wise addition</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="n">__global__</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">vecAddKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">{</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">C_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B_d</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="p">}</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kt">int</span><span class="w"> </span><span class="n">vecAdd</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="p">{</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="c1">// A_d, B_d, C_d allocations and copies omitted </span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="c1">// Run ceil(n/256) blocks of 256 threads each</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="nf">DimGrid</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="nf">DimBlock</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="n">vecAddKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">DimGrid</span><span class="p">,</span><span class="n">DimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">A_d</span><span class="p">,</span><span class="w"> </span><span class="n">B_d</span><span class="p">,</span><span class="w"> </span><span class="n">C_d</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li><code>DimBlock</code>: number of threads in a block</li>
<li><code>DimGrid</code>: number of blocks in a grid</li>
</ul>
<p><img src="./assets/image-20250828222306765.png" alt="image-20250828222306765" style="zoom:40%;" /></p>
<h3 id="compiling-a-cuda-program">Compiling A CUDA Program<a class="headerlink" href="#compiling-a-cuda-program" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250828222359260.png" alt="image-20250828222359260" style="zoom:40%;" /></p>
<h4 id="function-declarations-in-cuda">Function Declarations in CUDA<a class="headerlink" href="#function-declarations-in-cuda" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250828102908799.png" alt="image-20250828102908799" style="zoom:50%;" /></p>
<p><code>__global__</code> defines a kernel function</p>
<p><code>__device__</code> and <code>__host__</code> can be used together</p>
<h4 id="more-on-function-declarations">More on Function Declarations<a class="headerlink" href="#more-on-function-declarations" title="Permanent link">&para;</a></h4>
<p>The keyword <code>__host__</code> is useful when needing to mark a function as executable on both the host and the device</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">__host__</span><span class="w"> </span><span class="n">__device__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">}</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="kt">void</span><span class="w"> </span><span class="n">vecadd</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">}</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">vecadd_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="asynchronous-kernel-calls">Asynchronous Kernel Calls<a class="headerlink" href="#asynchronous-kernel-calls" title="Permanent link">&para;</a></h4>
<p>By default, kernel calls are <strong>asynchronous</strong> 异步</p>
<ul>
<li>Useful for overlapping GPU computations with CPU computations</li>
</ul>
<p>Use the following API function to wait for the kernel to finish</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">cudaError_t</span><span class="w"> </span><span class="n">cudaDeviceSynchronize</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Blocks until the device has completed all preceding requested tasks</li>
</ul>
<h4 id="error-checking">Error Checking<a class="headerlink" href="#error-checking" title="Permanent link">&para;</a></h4>
<p>All CUDA API calls return an error code <code>cudaError_t</code> that can be used to check if any errors occurred</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">cudaError_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">           </span><span class="p">,</span><span class="w"> </span><span class="n">cudaGetErrorString</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>For kernel calls, one can check the error returned by <code>cudaDeviceSynchronize()</code> or call the following API function:<code>cudaError_t cudaGetLastError()</code></p>
<h3 id="problems">Problems<a class="headerlink" href="#problems" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250828223539044.png" alt="image-20250828223539044" style="zoom: 33%;" /></p>
<p><img src="./assets/image-20250828223600508.png" alt="image-20250828223600508" style="zoom: 33%;" /></p>
<p><img src="./assets/image-20250828223617074.png" alt="image-20250828223617074" style="zoom: 33%;" /></p>
<h2 id="3-cuda-parallel-execution-model-multidimensional-grids-data">3 CUDA Parallel Execution Model: Multidimensional Grids &amp; Data<a class="headerlink" href="#3-cuda-parallel-execution-model-multidimensional-grids-data" title="Permanent link">&para;</a></h2>
<h3 id="cuda-thread-grids-are-multi-dimensional">CUDA Thread Grids are Multi-Dimensional<a class="headerlink" href="#cuda-thread-grids-are-multi-dimensional" title="Permanent link">&para;</a></h3>
<p>CUDA supports multidimensional grids (<mark>up to 3D</mark>)</p>
<p>Each CUDA kernel is executed by a grid,</p>
<ul>
<li>a 3D array of thread blocks, which are 3D arrays of threads.</li>
<li>Each thread executes the same program on distinct data inputs, a <strong>single-program, multiple-data (SPMD) model</strong></li>
</ul>
<p><strong>大小关系：Grid - block - warp - thread</strong></p>
<ul>
<li><code>gridDim</code> - <code>blockIdx</code> - <code>threadIdx</code></li>
</ul>
<p><img src="./assets/image-20250902094030975.png" alt="image-20250902094030975" style="zoom:25%;" /></p>
<p><img src="./assets/image-20250902094119251.png" alt="image-20250902094119251" style="zoom:25%;" /></p>
<ul>
<li>Thread block and thread organization <strong>simplifies memory addressing</strong> when processing multidimensional data</li>
</ul>
<h4 id="one-dimensional-indexing">One Dimensional Indexing<a class="headerlink" href="#one-dimensional-indexing" title="Permanent link">&para;</a></h4>
<p>Defining a working set for a thread</p>
<ul>
<li><code>i = blockIdx.x * blockDim.x + threadIdx.x;</code></li>
<li><img src="./assets/image-20250902094513248.png" alt="image-20250902094513248" style="zoom:25%;" /></li>
</ul>
<h4 id="multidimensional-indexing">Multidimensional Indexing<a class="headerlink" href="#multidimensional-indexing" title="Permanent link">&para;</a></h4>
<p>Defining a working set for a thread</p>
<ul>
<li><code>row = blockIdx.y * blockDim.y + threadIdx.y;</code></li>
<li><code>col = blockIdx.x * blockDim.x + threadIdx.x;</code></li>
<li><img src="./assets/image-20250902094812094.png" alt="image-20250902094812094" style="zoom:25%;" /></li>
</ul>
<h3 id="configuring-multidimensional-grids">Configuring Multidimensional Grids<a class="headerlink" href="#configuring-multidimensional-grids" title="Permanent link">&para;</a></h3>
<h4 id="use-built-in-dim3-type">Use built-in <code>dim3</code> type<a class="headerlink" href="#use-built-in-dim3-type" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">dim3</span><span class="w"> </span><span class="nf">numThreadsPerBlock</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2D</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="n">dim3</span><span class="w"> </span><span class="n">numBlocks</span><span class="p">(</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="p">(</span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="n">kernel</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="n">numBlocks</span><span class="p">,</span><span class="w"> </span><span class="n">numThreadsPerBlock</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="err">…</span><span class="n">kernel</span><span class="w"> </span><span class="n">args</span><span class="err">…</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="layout-of-multidimensional-data">Layout of Multidimensional Data<a class="headerlink" href="#layout-of-multidimensional-data" title="Permanent link">&para;</a></h4>
<ul>
<li>Convention is C is to store data in <strong>row</strong> major order</li>
<li>Elements in the <strong>same row</strong> are <strong>contiguous</strong> in memory</li>
<li><code>index = row * width + col</code></li>
</ul>
<h4 id="rgb-to-gray-scale-kernel-implementation">RGB to Gray-Scale Kernel Implementation<a class="headerlink" href="#rgb-to-gray-scale-kernel-implementation" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">__global__</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">rgb2gray_kernel</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">red</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">green</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">blue</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">gray</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">  </span><span class="c1">// Convert the pixel</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="n">gray</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">red</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">10</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">      </span><span class="o">+</span><span class="w"> </span><span class="n">green</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blue</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">;}</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="blur-kernel-implementation">Blur Kernel Implementation<a class="headerlink" href="#blur-kernel-implementation" title="Permanent link">&para;</a></h4>
<p>Output pixel is the average of the corresponding input pixel and the pixels around it</p>
<p><strong>Parallelization approach</strong>: assign one thread to each output pixel, and have it read multiple input pixels</p>
<ul>
<li>Given two N × N matrices, A and B, we can multiply A by B to compute a third N × N matrix, P: P = AB</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">blur_kernel</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">blurred</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">outRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">inRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outRow</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">BLUR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">inRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outRow</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BLUR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">inRow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">BLUR_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BLUR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">inCol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inRow</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// add this to deal with boundary conditions</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="n">average</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">image</span><span class="p">[</span><span class="n">inRow</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inCol</span><span class="p">];</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="n">blurred</span><span class="p">[</span><span class="n">outRow</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">outCol</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">      </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">)(</span><span class="n">average</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">BLUR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">BLUR_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>[!NOTE]</p>
<p><strong>Rule of thumb:</strong> every memory access must have a corresponding guard that compares its indexes to the array dimensions</p>
</blockquote>
<h3 id="matrix-matrix-multiplication">Matrix-Matrix Multiplication<a class="headerlink" href="#matrix-matrix-multiplication" title="Permanent link">&para;</a></h3>
<p>Given two N × N matrices, A and B, we can multiply A by B to compute a third N × N matrix, P: <span class="arithmatex">\(P = AB\)</span></p>
<ul>
<li><img src="./assets/image-20250902144507954.png" alt="image-20250902144507954" style="zoom:25%;" />矩阵相乘，一行✖️一列</li>
<li><strong>Parallelization approach</strong>: assign one thread to each element in the output matrix (C)</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mm_kernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">  </span><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="4-compute-architecture-and-scheduling">4 Compute Architecture and Scheduling<a class="headerlink" href="#4-compute-architecture-and-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="executing-thread-blocks">Executing Thread Blocks<a class="headerlink" href="#executing-thread-blocks" title="Permanent link">&para;</a></h3>
<p>Threads are assigned to <strong>Streaming Multiprocessors</strong> in block granularity 块粒度的流多处理器</p>
<ul>
<li>Up to <strong>32</strong> blocks to each SM</li>
<li>SMs can take up to <strong>2048</strong> threads</li>
</ul>
<p>Threads run concurrently 并行</p>
<ul>
<li>SM maintains thread/block id #s</li>
<li>SM manages/schedules thread execution</li>
</ul>
<h4 id="gpu-architecture">GPU Architecture<a class="headerlink" href="#gpu-architecture" title="Permanent link">&para;</a></h4>
<p>A GPU consists of <strong>multiple Streaming Multiprocessor (SMs)</strong>, each consisting of multiple cores with <em>shared control and memory</em></p>
<p><img src="./assets/image-20250904094714370.png" alt="image-20250904094714370" style="zoom:25%;" /></p>
<h4 id="assigning-blocks-to-sms">Assigning Blocks to SMs<a class="headerlink" href="#assigning-blocks-to-sms" title="Permanent link">&para;</a></h4>
<p>Threads are assigned to SMs at block granularity</p>
<ul>
<li>One/more thread to one SM</li>
<li>The remaining block wait for others to finish</li>
<li><strong>All threads in a block</strong> are assigned to the <strong>same</strong> SM</li>
</ul>
<p><img src="./assets/image-20250904100000607.png" alt="image-20250904100000607" style="zoom:25%;" /></p>
<ul>
<li><strong>All threads in a block</strong> are assigned to an SM <strong>simultaneously</strong> 同时分配<ul>
<li>A block cannot be assigned to an SM until it secures enough resources for all its threads to execute ==&gt; <em>ZERO-OVERHEAD</em></li>
<li>Otherwise, if some threads reach a barrier and others cannot execute, the system could deadlock</li>
</ul>
</li>
</ul>
<p>Threads in the <strong>same block</strong> can <strong>collaborate</strong> in ways that threads in different blocks cannot:</p>
<ul>
<li>
<p>Lightweight barrier synchronization: <code>__syncthreads()</code></p>
<ul>
<li>Wait for all threads in the block to reach the barrier before any thread can proceed</li>
</ul>
</li>
<li>
<p>Shared memory (discussed later)</p>
<ul>
<li>Access a fast memory that <strong>only threads in the same block can access</strong></li>
</ul>
</li>
<li>
<p>Others (discussed later)</p>
</li>
</ul>
<h4 id="synchronization-across-thread-blocks">Synchronization across Thread Blocks<a class="headerlink" href="#synchronization-across-thread-blocks" title="Permanent link">&para;</a></h4>
<p>If threads in different blocks <strong>do not synchronize</strong> with each other</p>
<ul>
<li>Blocks can execute in any order</li>
<li>Blocks can execute both in parallel with each other or sequentially with respect to each other</li>
<li>Enables <strong>transparent scalability</strong> 透明的可拓展性<ul>
<li>Same code can run on different devices with different amounts of hardware parallelism</li>
<li>Execute blocks sequentially if device has few SMs</li>
<li>Execute blocks in parallel if device has many SMs</li>
</ul>
</li>
</ul>
<p>If threads in different blocks to <strong>synchronize</strong> with each other</p>
<ul>
<li>Deadlock may occur if the synchronizing blocks are not scheduled simultaneously</li>
<li>
<p><strong>Cooperative groups</strong> 合作组 (covered later) allows <em>barrier synchronization</em> across clusters of thread blocks, or across the entire grid by limiting the number of blocks to guarantee that all blocks are executing simultaneously</p>
</li>
<li>
<p>Other techniques (covered later) allow <strong>unidirectional synchronization</strong> 间接同步 by ensuring that the producer block is scheduled before the consumer block</p>
</li>
</ul>
<h3 id="sm-scheduling">SM Scheduling<a class="headerlink" href="#sm-scheduling" title="Permanent link">&para;</a></h3>
<p>Blocks assigned to an SM are further divided into <strong>warps</strong> which are <em>the unit of scheduling</em></p>
<ul>
<li>The SM cores are organized into <strong>processing blocks</strong> 处理快, with each processing block having its own warp scheduler to execute multiple warps concurrently</li>
</ul>
<h4 id="warps">Warps<a class="headerlink" href="#warps" title="Permanent link">&para;</a></h4>
<p>The size of warps is device-specific, but has always been 32 threads to date</p>
<p>Threads in a warp are scheduled together on a processing block and executed following the <strong>SIMD model</strong> 单指令多数据模型</p>
<ul>
<li><u>S</u>ingle <u>I</u>nstruction, <u>M</u>ultiple <u>D</u>ata</li>
<li>One instruction is fetched and executed by all the threads in the warp, each processing different data</li>
<li>All threads ina warp execute the same instruction</li>
</ul>
<h4 id="thread-scheduling">Thread Scheduling<a class="headerlink" href="#thread-scheduling" title="Permanent link">&para;</a></h4>
<p>Each block is executed as <strong>32-thread warps</strong></p>
<p><img src="./assets/image-20250904101235227.png" alt="image-20250904101235227" style="zoom:33%;" /></p>
<p>SM 实现零开销 Warp 调度</p>
<p><img src="./assets/image-20250904101541283.png" alt="image-20250904101541283" style="zoom:33%;" /></p>
<p>Pitfalls: not divisible by 32, other threads idle</p>
<p><strong>Why SIMD?</strong></p>
<blockquote>
<p><strong>Advantage</strong></p>
<ul>
<li>Share the same instruction fetch/dispatch unit across multiple execution units (cores)</li>
</ul>
<p><strong>Disadvantage</strong></p>
<ul>
<li>
<p>Different threads taking different execution paths result in <strong>control divergence</strong></p>
<ul>
<li>Warp does a pass over each unique execution path</li>
<li>In each pass, threads taking the path execute while others are disabled</li>
</ul>
</li>
<li>
<p>The percentage of threads/cores enabled during SIMD execution is called the <strong>SIMD efficiency</strong></p>
</li>
</ul>
</blockquote>
<h4 id="control-divergence">Control Divergence<a class="headerlink" href="#control-divergence" title="Permanent link">&para;</a></h4>
<p>Control Divergence Example</p>
<p><img src="./assets/image-20250904102710933.png" alt="image-20250904102710933" style="zoom: 33%;" /></p>
<p><img src="./assets/image-20250912173030953.png" alt="image-20250912173030953" style="zoom:33%;" /></p>
<blockquote>
<p>[!NOTE]</p>
<p><strong>What is Control Divergence?</strong></p>
<p>On a GPU, a <strong>warp</strong> (a group of 32 threads) is a fundamental execution unit. All 32 threads in a warp execute the same instruction at the same time.</p>
<p><strong>Control divergence</strong> occurs when threads within a single warp encounter a conditional statement (like an <code>if-else</code> block) and disagree on which path to take. If条件中有<code>threadIdx</code>相关变量就可能会产生控制发散</p>
<ul>
<li>Some threads evaluate the condition to <code>true</code>.</li>
<li>Others evaluate it to <code>false</code>.</li>
</ul>
<p>The hardware handles this by running both paths sequentially: first, the <code>true</code> path is executed by the corresponding threads while the others are idle, and then the <code>false</code> path is executed by its threads while the first group is idle. This serialization is a performance penalty. 🤷‍♀️</p>
</blockquote>
<h4 id="avoiding-branch-divergence">Avoiding Branch Divergence<a class="headerlink" href="#avoiding-branch-divergence" title="Permanent link">&para;</a></h4>
<p>Try to <strong>make branch granularity a multiple of warp size</strong> (remember, it <em>may not always be 32</em>!)</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">WARP_SIZE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="c1">// THEN path (lots of lines)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="c1">// ELSE path (lots of lines)</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Still has two control paths</li>
<li>But all threads in any warp follow only one path</li>
</ul>
<h4 id="lantency-hiding">Lantency hiding 延迟隐藏<a class="headerlink" href="#lantency-hiding" title="Permanent link">&para;</a></h4>
<p>When a warp needs to wait for a high latency operation, another warp that is ready is selected and scheduled for execution</p>
<p><img src="./assets/image-20250909092742286.png" alt="image-20250909092742286" style="zoom:25%;" /></p>
<p>Many warps are needed so that there is sufficient work available to hide long latency operations, i.e., there is high chance of finding a warp that is ready</p>
<p>For this reason, <em>an SM typically supports many more threads than the number of cores</em> it has -- Max threads per SM is much higher than cores per SM</p>
<h4 id="occupancy">Occupancy<a class="headerlink" href="#occupancy" title="Permanent link">&para;</a></h4>
<p>The <strong>occupancy</strong> 占用率 of an SM refers to the ratio of the warps or threads active on the SM to the maximum allowed</p>
<p>In general, maximizing occupancy is desirable because it improves latency hiding</p>
<ul>
<li>Common case, but possible to have cases where lower occupancy is desirable</li>
</ul>
<p>Occupancy Example</p>
<p><img src="./assets/image-20250909091357699.png" alt="image-20250909091357699" style="zoom:25%;" /></p>
<h4 id="block-granularity-considerations">Block Granularity Considerations<a class="headerlink" href="#block-granularity-considerations" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250912182406187.png" alt="image-20250912182406187" style="zoom:33%;" /></p>
<h3 id="problem-solving">Problem solving<a class="headerlink" href="#problem-solving" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250912182705088.png" alt="image-20250912182705088" style="zoom: 40%;" /></p>
<p><img src="./assets/image-20250912182557010.png" alt="image-20250912182557010" style="zoom:40%;" /></p>
<p><img src="./assets/image-20250912182621756.png" alt="image-20250912182621756" style="zoom:40%;" /></p>
<h2 id="5-cuda-memory-model">5 CUDA Memory Model<a class="headerlink" href="#5-cuda-memory-model" title="Permanent link">&para;</a></h2>
<h3 id="the-von-neumann-model">The Von-Neumann Model 冯诺依曼<a class="headerlink" href="#the-von-neumann-model" title="Permanent link">&para;</a></h3>
<p>Processing Unit (PU)</p>
<ul>
<li>Performs all arithmetic and logical operations</li>
<li>Includes the <strong>Register File</strong>, where data is temporarily stored for processing</li>
</ul>
<p>Memory</p>
<ul>
<li>Stores both program instructions and data</li>
</ul>
<p>Input/Output (I/O) Subsystem</p>
<ul>
<li>Handles communication between the computer and the external environment</li>
</ul>
<p>Control Unit (CU)</p>
<ul>
<li>Directs the execution of instructions by coordinating all components</li>
</ul>
<p>All operations are performed on data stored in <strong>registers</strong> within the Processing Unit. Before any calculation:</p>
<ul>
<li>Data must be fetched from Memory into registers, and Instructions must be loaded from Memory into the Instruction Register (IR)</li>
</ul>
<p><img src="./assets/image-20250909094006962.png" alt="image-20250909094006962" style="zoom:25%;" /></p>
<p>Instruction processing breaks into steps: <strong>Fetch | Decode | Execute | Memory</strong></p>
<p>Instructions come in three flavors: Operate, Data Transfer, and Control Flow</p>
<p>ADD instruction</p>
<p>LOAD instruction</p>
<h3 id="programmers-view-of-cuda-memories">Programmer’s View of CUDA Memories<a class="headerlink" href="#programmers-view-of-cuda-memories" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20251005202750869.png" alt="image-20251005202750869" style="zoom:50%;" /></p>
<h3 id="registers-vs-memory">Registers vs Memory<a class="headerlink" href="#registers-vs-memory" title="Permanent link">&para;</a></h3>
<p>Registers</p>
<ul>
<li>Fast: 1 cycle; no memory access required</li>
<li>Few: hundreds for CPU, O(10k) for GPU SM</li>
</ul>
<p>Memory</p>
<ul>
<li>Slow: hundreds of cycles</li>
<li>Huge: GB or more</li>
</ul>
<p><img alt="image-20250909095244547" src="assets/image-20250909095244547.png" /></p>
<p>Matrix Multiplication 矩阵乘法：A Simple Host Version in C</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">// Matrix multiplication on the (CPU) host</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MatrixMul</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="p">{</span><span class="w"> </span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">];</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">      </span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="parallelize-elements-of-p">Parallelize Elements of P<a class="headerlink" href="#parallelize-elements-of-p" title="Permanent link">&para;</a></h3>
<p>What can we parallelize?</p>
<ul>
<li>start with the <strong>two outer loops</strong></li>
<li>parallelize the <strong>computation of elements of P</strong></li>
</ul>
<h4 id="compute-using-2d-blocks-in-a-2d-grid">Compute Using 2D Blocks in a 2D Grid<a class="headerlink" href="#compute-using-2d-blocks-in-a-2d-grid" title="Permanent link">&para;</a></h4>
<p><strong>P</strong> is 2D, so organize threads in 2D as well:</p>
<p>Split the output <strong>P</strong> into square tiles of size <code>TILE_WIDTH × TILE_WIDTH</code>(a preprocessor constant)</p>
<p><strong>Each thread block produces one tile</strong> of TILE_WIDTH^2 elements</p>
<p>Create <strong>[ceil (Width / TILE_WIDTH)]^2</strong> thread <strong>blocks</strong> to cover the output matrix</p>
<h3 id="kernel-invocation-host-side-code">Kernel Invocation (Host-side Code)<a class="headerlink" href="#kernel-invocation-host-side-code" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1">// TILE_WIDTH is a #define constant</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">dim3</span><span class="w"> </span><span class="n">dimGrid</span><span class="p">(</span><span class="n">ceil</span><span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="n">Width</span><span class="p">)</span><span class="o">/</span><span class="n">TILE_WIDTH</span><span class="p">),</span><span class="w"> </span><span class="n">ceil</span><span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="n">Width</span><span class="p">)</span><span class="o">/</span><span class="n">TILE_WIDTH</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="n">dim3</span><span class="w"> </span><span class="nf">dimBlock</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="c1">// Launch the device computation threads!</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="n">MatrixMulKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span><span class="w"> </span><span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="w"> </span><span class="n">Nd</span><span class="p">,</span><span class="w"> </span><span class="n">Pd</span><span class="p">,</span><span class="w"> </span><span class="n">Width</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="kernel-function">Kernel Function<a class="headerlink" href="#kernel-function" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// Matrix multiplication kernel – per thread code</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">__global__</span><span class="w"> </span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">MatrixMulKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_M</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">  </span><span class="c1">// Calculate the row index of the d_P element and d_M</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">  </span><span class="c1">// Calculate the column idenx of d_P and d_N</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">  </span><span class="c1">// Pvalue is used to store the element of the matrix</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">  </span><span class="c1">// that is computed by the thread</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="n">d_P</span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><img src="./assets/image-20251005210446452.png" alt="image-20251005210446452" style="zoom:50%;" /></p>
<h4 id="matrix-multiplication-kernel">Matrix Multiplication Kernel<a class="headerlink" href="#matrix-multiplication-kernel" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">__global__</span><span class="w"> </span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">MatrixMulKernel</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_M</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">d_P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="p">{</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">  </span><span class="c1">// Calculate the row index of the d_P element and d_M</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">  </span><span class="c1">// Calculate the column idenx of d_P and d_N</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">    </span><span class="c1">// each thread computes one element of the block sub-matrix</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="w">      </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">d_M</span><span class="p">[</span><span class="n">Row</span><span class="o">*</span><span class="n">Width</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d_N</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">Width</span><span class="o">+</span><span class="n">Col</span><span class="p">];</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="w">    </span><span class="n">d_P</span><span class="p">[</span><span class="n">Row</span><span class="o">*</span><span class="n">Width</span><span class="o">+</span><span class="n">Col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Memory Bandwidth is Overloaded!</p>
<p>That’s a <strong>simple implementation</strong>:</p>
<ul>
<li>
<p>GPU kernel is the <strong>CPU code</strong> with the <strong>outer loops replaced with</strong> per-thread <strong>index calculations</strong>!</p>
</li>
<li>
<p>Unfortunately, performance is quite bad.</p>
</li>
</ul>
<p>Why?</p>
<ul>
<li>With the given approach, global <strong>memory bandwidth</strong> can’t supply enough data to <strong>keep the SMs busy</strong>!</li>
</ul>
<p><img src="./assets/image-20251005212333216.png" alt="image-20251005212333216" style="zoom: 50%;" /></p>
<p><img src="./assets/image-20251007183850576.png" alt="image-20251007183850576" style="zoom: 33%;" /></p>
<p>We should Reuse Memory Accesses</p>
<p>In an <strong>actual execution</strong>, memory is not busy all the time, and the code <strong>runs at</strong> about <strong>25 GFLOPs</strong></p>
<p>To get closer to 1,000 GFLOPs,we <strong>need to</strong> drastically <strong>cut down accesses to global memory</strong> (next lecture)</p>
<h3 id="problem-solving_1">Problem Solving<a class="headerlink" href="#problem-solving_1" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250909102403773.png" alt="image-20250909102403773" style="zoom:25%;" /></p>
<hr />
<p><img src="./assets/image-20250909102713902.png" alt="image-20250909102713902" style="zoom:25%;" /></p>
<blockquote>
<p>The answer is <strong>Either 0 or 1</strong> because of a <strong>race condition</strong>. 🏁</p>
<p>A race condition occurs when multiple threads try to access and modify the same memory location at the same time, and the final result depends on the unpredictable order in which they execute.</p>
<ol>
<li>
<p><strong>Kernel Launch:</strong> The line <code>kernel&lt;&lt;&lt;2,1&gt;&gt;&gt;(dst);</code> launches the kernel with a grid of <strong>2 blocks</strong>, and each block contains <strong>1 thread</strong>.</p>
<ul>
<li>This creates two blocks in total: Block 0 and Block 1.</li>
<li>For Block 0, the built-in variable <code>blockIdx.x</code> is <strong>0</strong>.</li>
<li>For Block 1, the built-in variable <code>blockIdx.x</code> is <strong>1</strong>.</li>
</ul>
</li>
<li>
<p>Conflicting Writes:</p>
<p>Both threads execute the same instruction, dst[0] = blockIdx.x;, but with different values for blockIdx.x:</p>
<ul>
<li>The thread from Block 0 executes <code>dst[0] = 0;</code>.</li>
<li>The thread from Block 1 executes <code>dst[0] = 1;</code>.</li>
</ul>
</li>
<li>
<p>Unpredictable Order:</p>
<p>The CUDA programming model does not guarantee the execution order of different blocks. The GPU's scheduler might run Block 0 first, then Block 1, or vice-versa.</p>
<ul>
<li><strong>Scenario 1:</strong> Block 1's write is the last one to complete. The initial value at <code>dst[0]</code> is overwritten by <code>0</code> (from Block 0), and then finally overwritten by <strong><code>1</code></strong>.</li>
<li><strong>Scenario 2:</strong> Block 0's write is the last one to complete. The initial value is overwritten by <code>1</code> (from Block 1), and then finally overwritten by <strong><code>0</code></strong>.</li>
</ul>
</li>
</ol>
<p>Since there's no way to know which block will "win" the race to write to <code>dst[0]</code> last, the final value stored in that location after the kernel finishes could be either 0 or 1.</p>
</blockquote>
<h2 id="6-data-locality-and-tiled-matrix-multiply">6 Data Locality and Tiled Matrix Multiply<a class="headerlink" href="#6-data-locality-and-tiled-matrix-multiply" title="Permanent link">&para;</a></h2>
<h3 id="performance-metrics">Performance Metrics<a class="headerlink" href="#performance-metrics" title="Permanent link">&para;</a></h3>
<p><strong>FLOPS Rate</strong>: floating point operations per second</p>
<ul>
<li>How much computation a processor’s cores can do per unit time</li>
</ul>
<p><strong>Memory Bandwidth</strong>: bytes per second</p>
<ul>
<li>How much data the memory can supply to the cores per unit time</li>
</ul>
<p><img src="./assets/image-20250911093925332.png" alt="image-20250911093925332" style="zoom:25%;" /></p>
<ul>
<li>FLOPs rate(GLOPS/s)</li>
<li>Memory bandwidth(GB/s)</li>
</ul>
<h4 id="performance-bound-and-the-roofline-model">Performance Bound and the Roofline Model<a class="headerlink" href="#performance-bound-and-the-roofline-model" title="Permanent link">&para;</a></h4>
<p>A kernel can be:</p>
<ul>
<li><strong>Compute-bound</strong> 计算受限: performance limited by the FLOPS rate<ul>
<li>The processor’s cores are fully utilized (always have work to do)</li>
</ul>
</li>
<li><strong>Memory-bound</strong> 内存受限: performance limited by the memory bandwidth<ul>
<li>The processor’s cores are frequently idle because memory cannot supply data fast enough</li>
</ul>
</li>
</ul>
<p>The <strong>roofline model</strong> helps visualize a kernel’s performance bound based on the ratio of operations it 
performs and bytes it accesses from memory</p>
<p><img src="./assets/image-20250911094055993.png" alt="image-20250911094055993" style="zoom:25%;" /></p>
<ul>
<li>先受内存限制后受CPU限制</li>
<li><strong>OP/B ratio</strong>: allows us to determine if a kernel is memory-bound or compute-bound on a specific hardware 根据比例判断类型 </li>
<li><em>OP/B = operations / data</em></li>
</ul>
<p>Knowing the kernel’s bound allows us to determine the best possible performance achievable by the kernel (sometimes called the <strong>speed of light</strong>)</p>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250913220651366.png" alt="image-20250913220651366" style="zoom: 40%;" /></p>
<p><img src="./assets/image-20250913221250249.png" alt="image-20250913221250249" style="zoom:50%;" /></p>
<h3 id="a-common-programming-strategy">A Common Programming Strategy<a class="headerlink" href="#a-common-programming-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Global memory</strong> is implemented with <strong>DRAM</strong>(Dynamic random-access memory) – slow</p>
<p>Sometimes, we are lucky:</p>
<ul>
<li>The thread finds the data in the L1 cache because it was recently loaded by another thread</li>
</ul>
<p>Sometimes, we are not lucky:</p>
<ul>
<li>The data gets evicted from the L1 cache before another thread tries to load it</li>
</ul>
<p>To avoid a Global Memory bottleneck, <strong><mark>tile the input data</mark></strong> to take advantage of Shared Memory 将输入数据平铺以利用共享内存：</p>
<ul>
<li><strong>Partition data into subsets</strong> (<em>tiles</em>) that fit into the (smaller but faster) shared memory</li>
<li><strong>Handle each data subset with one thread block</strong> by:<ul>
<li>Loading the subset from global memory to shared memory, <em>using multiple threads to exploit memory-level parallelism</em> 利用内存级并行性</li>
<li>Performing the computation on the subset from shared memory, each thread can efficiently access any data element</li>
<li>Copying results from shared memory to global memory</li>
</ul>
</li>
<li>Tiles are also called blocks in the literature</li>
</ul>
<p><img src="./assets/image-20250911095949762.png" alt="image-20250911095949762" style="zoom:33%;" /></p>
<h4 id="tiled-multiply">Tiled Multiply<a class="headerlink" href="#tiled-multiply" title="Permanent link">&para;</a></h4>
<p>平铺策略：Break up the execution of the kernel into phases so that the data accesses in each phase are focused on one tile of A and B</p>
<p><img src="./assets/image-20250911100629113.png" alt="image-20250911100629113" style="zoom:33%;" /></p>
<p>For each tile:</p>
<ul>
<li>
<p>Phase 1: Load tiles of A &amp; B into share memory</p>
<ul>
<li>
<p>Each thread loads one A element and one B element in basic tiling code</p>
</li>
<li>
<p>```c
    A[Row][1<em>TILE_WIDTH+tx]
    B[1</em>TILE_WIDTH+ty][Col]</p>
<p>A[Row][q<em>TILE_WIDTH+tx]
A[Row</em>Width + q*TILE_WIDTH + tx]</p>
<p>B[q<em>TILE_WIDTH+ty][Col]
B[(q</em>TILE_WIDTH+ty) * Width + Col]</p>
<p>//A and B are dynamically allocated and can only use 1D indexing
```</p>
</li>
</ul>
</li>
<li>
<p>Phase 2: Calculate partial dot product for tile of C</p>
<ul>
<li><code>c
    //To perform the kth step of the product within the tile
    subTileA[ty][k];
    subTileB[k][tx];</code></li>
</ul>
</li>
</ul>
<h4 id="tiled-matrix-matrix-multiplication">Tiled Matrix-Matrix Multiplication<a class="headerlink" href="#tiled-matrix-matrix-multiplication" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1">// declare arrays in shared memory</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">  </span><span class="c1">// Load tile to shared memory</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">  </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">  </span><span class="n">B_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">  </span><span class="c1">// Compute with tile</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">B_s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="p">}</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>code inside the tunnel</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>We need to <strong>synchronize</strong>! 同步</p>
</blockquote>
<h4 id="bulk-synchronous-steps-based-on-barriers">Bulk Synchronous Steps Based on Barriers<a class="headerlink" href="#bulk-synchronous-steps-based-on-barriers" title="Permanent link">&para;</a></h4>
<p><strong>Bulk synchronous execution</strong>: threads execute roughly in unison</p>
<ol>
<li>Do some work</li>
<li>Wait for others to catch up</li>
<li>Repeat</li>
</ol>
<p>Much easier programming model</p>
<ul>
<li>Threads only parallel within a section</li>
<li>Debug lots of little programs</li>
<li>Instead of one large one</li>
</ul>
<p>Dominates high-performance applications</p>
<p>How does it work?</p>
<ul>
<li>Use a <strong>barrier</strong> to wait for the thread to 'catch up.'</li>
</ul>
<p>A barrier is a synchronization point:</p>
<ul>
<li>each thread <em>calls a function</em> to enter the barrier;</li>
<li>threads <em>block</em> (sleep) in barrier function until all threads have called;</li>
<li><em>After the last thread</em> calls the function, all threads <em>continue</em> past the barrier.</li>
</ul>
<p><img src="./assets/image-20250911102053535.png" alt="image-20250911102053535" style="zoom:25%;" /></p>
<p><strong>API function</strong>: <code>__syncthreads()</code></p>
<p>All threads <strong>in the same block</strong> must reach the <code>__syncthreads()</code> before any can move on</p>
<ul>
<li>To ensure that all elements of a tile are loaded</li>
<li>To ensure that certain computation on elements is complete</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1">// declare arrays in shared memory</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">  </span><span class="c1">// Load tile to shared memory</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">  </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">  </span><span class="n">B_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">  </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w"> </span><span class="c1">// Threads wait for each other to finish loading before computing</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">  </span><span class="c1">// Compute with tile</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">B_s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">  </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w"> </span><span class="c1">// Threads wait for each other to finish loading before computing</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="p">}</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="boundary-conditions">Boundary Conditions<a class="headerlink" href="#boundary-conditions" title="Permanent link">&para;</a></h4>
<p>Different Matrix Dimensions</p>
<ul>
<li>Solution: Write 0 for Missing Elements<ul>
<li>Is the target within input matrix?<ul>
<li>If yes, proceed to load. Otherwise, just write 0 to the shared memory</li>
</ul>
</li>
<li>Benefit<ul>
<li>No specialization during tile use!</li>
<li>Multiplying by 0 guarantees that unwanted terms do not contribute to the inner product.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./assets/image-20250913233126141.png" alt="image-20250913233126141" style="zoom:33%;" /></p>
<p><strong>Modifying the Tile Count</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="c1">//The bound for m implicitly assumes that Width is a multiple of TILE_WIDTH. We need to round up.</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>For non-multiples 非整数倍 of <code>TILE_DIM</code>:<ul>
<li>quotient is unchanged;</li>
<li>add one to round up</li>
</ul>
</li>
<li>For multiples 整数倍 of <code>TILE_DIM</code>:<ul>
<li>quotient is now one smaller, but we add 1.</li>
</ul>
</li>
</ul>
<p><strong>Modifying the Tile Loading Code</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1">// We had: Load tile to shared memory</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">B_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="c1">//Note: the tests for A and B tiles are NOT the same.</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="o">+</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">  </span><span class="c1">// as before</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">  </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">  </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="p">}</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="o">+</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="w">  </span><span class="n">B_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="w">  </span><span class="n">B_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Modifying the Tile Use Code</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c1">// We had: Compute with tile</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">  </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="p">}</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="c1">//Note: no changes are needed, but we might save a little energy (fewer floating-point ops)?</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">  </span><span class="c1">// as before</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Modifying the Write to C</strong></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span>
<span class="normal"><a href="#__codelineno-27-5">5</a></span>
<span class="normal"><a href="#__codelineno-27-6">6</a></span>
<span class="normal"><a href="#__codelineno-27-7">7</a></span>
<span class="normal"><a href="#__codelineno-27-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1">// We had:</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="c1">//We must test for threads outside of C:</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">  </span><span class="c1">// as before</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">  </span><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>[!IMPORTANT]</p>
<p>For each thread, conditions are different for </p>
<ul>
<li>Loading A element</li>
<li>Loading B element</li>
<li>Calculation/storing output elements</li>
</ul>
<p>Branch divergence </p>
<ul>
<li>affects only blocks on boundaries, and should be small for large matrices</li>
</ul>
</blockquote>
<h3 id="bottleneck">Bottleneck 瓶颈<a class="headerlink" href="#bottleneck" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250914145510157.png" alt="image-20250914145510157" style="zoom:33%;" /></p>
<ul>
<li>系统已经从<strong>内存受限</strong>转变为<strong>计算受限</strong> memory-bound to compute-bound</li>
</ul>
<p><img src="./assets/image-20250914165622133.png" alt="image-20250914165622133" style="zoom:33%;" /></p>
<ul>
<li>Memory per Block = 两个矩阵, 16^2个线程,4个字节</li>
<li>Max Blocks (Memory) =  (Total SM Shared Memory) / (Memory per Block) = 64 kB / 2 kB = 32 blocks</li>
<li>Max Blocks (Threads) = (Max Threads on SM) / (Threads per Block) = 2048 / 256 = 8 blocks</li>
<li>Pending loads = maximum number of active blocks ✖️the number of loads per block</li>
</ul>
<p><img src="./assets/image-20250914171006989.png" alt="image-20250914171006989" style="zoom:33%;" /></p>
<h4 id="memory-and-occupancy">Memory and Occupancy<a class="headerlink" href="#memory-and-occupancy" title="Permanent link">&para;</a></h4>
<p>Register usage per thread, and shared memory usage per thread block constrain occupancy</p>
<h4 id="dynamic-shared-memory">Dynamic Shared Memory<a class="headerlink" href="#dynamic-shared-memory" title="Permanent link">&para;</a></h4>
<p>动态分配共享内存</p>
<p>Declaration: <code>extern __shared__ A_s[];</code></p>
<p>Configuration: <code>kernel &lt;&lt;&lt; numBlocks, numThreadsPerBlock, smemPerBlock &gt;&gt;&gt; (...)</code></p>
<h3 id="tiling-on-cpu">Tiling on CPU<a class="headerlink" href="#tiling-on-cpu" title="Permanent link">&para;</a></h3>
<p>Tiling also works for CPU</p>
<ul>
<li>No scratchpad memory, but relies on caches 无需暂存器，但依赖缓存</li>
<li>Cache is sufficiently reliable because there are fewer threads running on the core and the cache is larger 缓存足够可靠，因为核心上运行的线程较少，而且缓存较大</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rowTile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">rowTile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">rowTile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">colTile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">colTile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">colTile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iTile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iTile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">iTile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowTile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">rowTile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colTile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">colTile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">          </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iTile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">iTile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iTile</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="7-dram-bandwidth-and-other-performance-considerations">7 DRAM Bandwidth and other Performance Considerations<a class="headerlink" href="#7-dram-bandwidth-and-other-performance-considerations" title="Permanent link">&para;</a></h2>
<blockquote>
<p>[!NOTE]</p>
<p>Performance optimizations covered so far
  • Tuning resource usage to maximize occupancy to hide latency in cores
  • Threads per block, shared memory per block, registers per thread
  • Reducing control divergence to increase SIMD efficiency
  • Shared memory and register tiling to reduce memory traffic</p>
<p>More optimizations to be covered today
  • Memory coalescing
  • Maximizing occupancy (again) to hide memory latency
  • Thread coarsening
  • Loop unrolling
  • Double-buffering</p>
</blockquote>
<h3 id="dram">DRAM<a class="headerlink" href="#dram" title="Permanent link">&para;</a></h3>
<p><strong>Random Access Memory (RAM)</strong>: same time needed to read/write any address</p>
<p><strong>DRAM(Dynamic RAM)</strong> </p>
<ul>
<li>
<p>is Slow But Dense</p>
</li>
<li>
<p>Capacitance…
    • tiny for the BIT, but
    • huge for the <em>BIT LINE</em>
    • Use an amplifier for higher speed!
    • Still slow…
    • But only need <em>1 transistor per bit</em> 一位只要一个晶体管</p>
</li>
</ul>
<p><strong>A DRAM bank</strong> consists of a 2D array of DRAM cells activated one row at a time, and read at the column</p>
<ul>
<li><em>SELECT</em> lines connect to about 1,000 bit lines</li>
<li>Core DRAM array has about O(1M) bits</li>
<li>Use more address bits to choose bit line(s)</li>
</ul>
<p><img src="./assets/image-20250916095042325.png" alt="image-20250916095042325" style="zoom:30%;" /></p>
<ul>
<li>Accessing data in the same burst is faster than accessing data in different bursts</li>
</ul>
<h3 id="memory-coalescing">Memory Coalescing 内存合并<a class="headerlink" href="#memory-coalescing" title="Permanent link">&para;</a></h3>
<p>When threads in the same warp access <strong>consecutive memory locations</strong> in the <strong>same burst 爆发</strong>, the accesses can be combined and served by one burst</p>
<ul>
<li>One DRAM transaction is needed</li>
<li>Known as memory coalescing</li>
</ul>
<p>If threads in the same warp access locations not in the same burst, accesses cannot be combined</p>
<ul>
<li>
<p>Multiple transactions are needed</p>
</li>
<li>
<p>Takes longer to service data to the warp</p>
</li>
<li>Sometimes called memory divergence</li>
</ul>
<p><img src="./assets/image-20250916100200094.png" alt="image-20250916100200094" style="zoom:33%;" /></p>
<p><img src="./assets/image-20250916100629483.png" alt="image-20250916100629483" style="zoom:33%;" /></p>
<h4 id="matrix-matrix-multiplication_1">Matrix-matrix multiplication<a class="headerlink" href="#matrix-matrix-multiplication_1" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span>
<span class="normal"><a href="#__codelineno-29-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="c1">// Note: a warp contains consecutive threads in the x dimension followed by the y dimension</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="n">For</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">  </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Accesses to M and N are coalesced 合并</p>
<ul>
<li>e.g., threads 0 to 31 access element 0 of M on the first iteration, resulting in one memory transaction to service warp 0</li>
<li>e.g., threads 0 to 31 access elements 0 to 31 of N on the first iteration, resulting in one memory transaction to service warp 0</li>
</ul>
<h4 id="use-of-shared-memory-enables-coalescing">Use of Shared Memory Enables Coalescing<a class="headerlink" href="#use-of-shared-memory-enables-coalescing" title="Permanent link">&para;</a></h4>
<p>Tiled matrix-matrix multiplication</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span>
<span class="normal"><a href="#__codelineno-30-6">6</a></span>
<span class="normal"><a href="#__codelineno-30-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="n">For</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">  </span><span class="n">M_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">  </span><span class="n">N_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[(</span><span class="n">tile</span><span class="o">*</span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="latency-hiding-with-multiple-banks">Latency Hiding with Multiple Banks<a class="headerlink" href="#latency-hiding-with-multiple-banks" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250916101427036.png" alt="image-20250916101427036" style="zoom:33%;" /></p>
<ul>
<li>Need many threads to simultaneously access memory to keep all banks busy</li>
<li>Achieved with having high occupancy in SMs</li>
<li>Similar idea to hiding pipeline latency in the core</li>
</ul>
<h3 id="fine-grain-thread-granularity">Fine-Grain Thread Granularity<a class="headerlink" href="#fine-grain-thread-granularity" title="Permanent link">&para;</a></h3>
<p>So far, parallelization approaches made threads as <em>fine-grain</em> 线程粒度细化 as possible</p>
<ul>
<li>Assign smallest possible unit of parallelizable work per thread<ul>
<li>e.g., one vector element per thread in vector addition</li>
<li>e.g., one output pixel per thread in RGB to gray and in blur</li>
<li>e.g., one output matrix element per thread in matrix-matrix multiplication</li>
</ul>
</li>
</ul>
<p><img src="./assets/image-20251002223538183.png" alt="image-20251002223538183" style="zoom: 67%;" /></p>
<p><strong>Advantage</strong>: provide hardware with as many threads as possible to fully utilize resources</p>
<ul>
<li>If more threads are provided than the GPU can support, the hardware can serialize the work with low overhead</li>
<li>If future GPUs come out with more resources, more parallelism can be extracted without code being rewritten<ul>
<li>Recall: <em>transparent scalability</em></li>
</ul>
</li>
</ul>
<p><strong>Disadvantage</strong>: if there is an overhead for parallelizing work across more threads, that overhead is maximized</p>
<ul>
<li>Okay if threads actually run in parallel</li>
<li>Suboptimal if threads are getting serialized by the hardware</li>
</ul>
<h4 id="thread-coarsening">Thread Coarsening 粗化<a class="headerlink" href="#thread-coarsening" title="Permanent link">&para;</a></h4>
<p><strong>Thread coarsening</strong> is an optimization were a thread is assigned multiple units of parallelizable work</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="n">foo</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="c1">// =&gt; Thread coarsening</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iStart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">  </span><span class="n">foo</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Advantages</strong></p>
<ul>
<li>Reduces the overhead incurred for parallelization</li>
<li>Could be redundant 冗余 memory accesses</li>
<li>Could be redundant computations</li>
<li>Could be synchronization overhead or control divergence</li>
<li>We will see many examples throughout the course</li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul>
<li>More resources(variables allocation memory) per thread which may affect occupancy</li>
<li>Underutilizes resources if coarsening factor is too high</li>
<li>Need to retune 调整 coarsening factor for each device</li>
</ul>
<h4 id="loop-unrolling">Loop unrolling 循环展开<a class="headerlink" href="#loop-unrolling" title="Permanent link">&para;</a></h4>
<p>Loop unrolling transforms a loop by replicating the body of the loop by some factor and reducing the number of loop iterations by the same factor 通过将循环主体复制某个因子并将循环迭代次数减少相同的因子来转换循环</p>
<ul>
<li>Loop unrolling reduces stalls in two ways:<ul>
<li>Fewer loop iterations implies fewer branches</li>
<li>Branches have long-latency in the absence of branch prediction</li>
</ul>
</li>
<li>Exposes more independent instructions for instruction scheduling</li>
</ul>
<p><img src="./assets/image-20251004232213163.png" alt="image-20251004232213163" style="zoom:50%;" /></p>
<h4 id="instruction-scheduling">Instruction Scheduling 指令调度<a class="headerlink" href="#instruction-scheduling" title="Permanent link">&para;</a></h4>
<p><strong>Instruction scheduling</strong> reorders instructions to reduce stalling by placing instructions that depend on </p>
<p>each other farther away from each other</p>
<p>通过重新排序指令，将相互依赖的指令放置得更远，从而减少停顿</p>
<h4 id="double-buffering">Double Buffering 双缓冲<a class="headerlink" href="#double-buffering" title="Permanent link">&para;</a></h4>
<p>Double buffering eliminates false dependences by using a different memory buffer for writing data than the memory buffer containing the data being read 双缓冲通过使用不同的内存缓冲区来写入数据，而不是包含正在读取的数据的内存缓冲区，从而消除了错误的依赖关系</p>
<p><img src="./assets/image-20250916103340842.png" alt="image-20250916103340842" style="zoom:33%;" /></p>
<h3 id="checklist-of-common-optimizations">Checklist of Common Optimizations<a class="headerlink" href="#checklist-of-common-optimizations" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Optimization</th>
<th>Benefit to Compute Cores</th>
<th>Benefit to Memory</th>
<th>Strategies</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Compute utilization</strong></td>
<td>Occupancy tuning</td>
<td>More work to hide pipeline latency</td>
<td>More parallel memory accesses to hide DRAM latency</td>
<td>Tune the usage of SM resources such as threads per block, shared memory per block, and registers per thread</td>
</tr>
<tr>
<td><strong>Compute utilization</strong></td>
<td>Loop unrolling</td>
<td>Fewer branch instructions and more independent instruction sequences with fewer stalls</td>
<td>May enable promoting local arrays to registers to reduce global memory traffic</td>
<td>Performed automatically by the compiler<br><br>Use loops with constant bounds where possible to facilitate the compiler's job</td>
</tr>
<tr>
<td><strong>Compute utilization</strong></td>
<td>Reducing control divergence</td>
<td>High SIMD efficiency (fewer idle cores during SIMD execution)</td>
<td>/</td>
<td>Rearrange the assignment of threads to work and/or data</td>
</tr>
<tr>
<td><strong>Memory utilization</strong></td>
<td>Using coalescable global memory accesses</td>
<td>Fewer pipeline stalls waiting for global memory accesses</td>
<td>Less global memory traffic and better utilization of bursts/cache-lines</td>
<td>Rearranging the layout of the data<br>Rearranging the mapping of threads to data</td>
</tr>
<tr>
<td><strong>Memory utilization</strong></td>
<td>Shared memory tiling</td>
<td>Fewer pipeline stalls waiting for global memory accesses</td>
<td>Less global memory traffic</td>
<td>Transfer data between global memory and shared memory in a coalescable manner and perform irregular accesses in shared memory (e.g., corner turning)<br>Place data that is reused within a block in shared memory so that it is transferred between global memory and the SM only once</td>
</tr>
<tr>
<td><strong>Memory utilization</strong></td>
<td>Register tiling</td>
<td>Fewer pipeline stalls waiting for shared memory accesses</td>
<td>Less shared memory traffic</td>
<td>Place data that is reused within a warp or thread in registers so that it is transferred between shared memory and registers only once</td>
</tr>
<tr>
<td><strong>Synchronization latency</strong></td>
<td>Privatization</td>
<td>Fewer pipeline stalls waiting for atomic updates</td>
<td>Less contention and serialization of atomic updates</td>
<td>Apply partial updates to a private copy of the data then update the public copy when done</td>
</tr>
<tr>
<td><strong>Synchronization latency</strong></td>
<td>Warp-level primitives</td>
<td>Reduce block-wide barrier synchronizations</td>
<td>Less shared memory traffic</td>
<td>Perform operations requiring barrier synchronization at the warp-level, then consolidate warp-level results at the block-level</td>
</tr>
<tr>
<td><strong>Synchronization latency</strong></td>
<td>Double buffering</td>
<td>Eliminates barriers that enforce false dependencies</td>
<td>/</td>
<td>Eliminate false (write-after-read) dependencies by using different buffers for the writes and the preceding reads</td>
</tr>
<tr>
<td><strong>General</strong></td>
<td>Thread coarsening</td>
<td>Depends on the overhead of parallelization</td>
<td>Depends on the overhead of parallelization</td>
<td>Assign multiple units of parallelism to each thread in order to reduce the</td>
</tr>
</tbody>
</table>
<h4 id="trade-off-between-optimizations">Trade-off Between Optimizations<a class="headerlink" href="#trade-off-between-optimizations" title="Permanent link">&para;</a></h4>
<p>Maximizing occupancy 最大化占有率</p>
<ul>
<li>Maximizing occupancy hides pipeline latency, but threads may compete for resources (e.g., registers, shared memory, cache) 最大化占用率可以降低流水线延迟，但线程可能会竞争资源（例如寄存器、共享内存、缓存）</li>
</ul>
<p>Shared memory tiling</p>
<ul>
<li>Using more shared memory enables more data reuse, but may limit occupancy 使用更多共享内存可以实现更多数据重用，但可能会限制占用率</li>
</ul>
<p>Thread coarsening</p>
<ul>
<li>Coarsening reduces parallelization overhead, but requires more resources per thread which may limit occupancy 粗化可以降低并行化开销，但每个线程需要更多资源，这可能会限制占用率</li>
</ul>
<h3 id="problem-solving_2">Problem Solving<a class="headerlink" href="#problem-solving_2" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20251004233101679.png" alt="image-20251004233101679" style="zoom:50%;" /></p>
<blockquote>
<p>Performance hinges on a GPU's ability to perform <strong>coalesced memory access</strong>, and we can't know if access is coalesced without the kernel launch configuration(specifically, the <code>blockDim</code> values)</p>
<p>The performance is not an inherent property of the code line itself but of the interaction between the code and the thread hierarchy.</p>
</blockquote>
<p><img src="./assets/image-20251004233624425.png" alt="image-20251004233624425" style="zoom:50%;" /></p>
<blockquote>
<p>The <strong>DRAM burst size</strong> is the minimum amount of data the memory system will fetch in a single transaction, regardless of how little you ask for. 内存系统在单次事务中获取的最小数据量。即使一个线程只需要 8 个字节，内存控制器也会获取包含这 8 个字节的整个 512 字节块。</p>
<p><strong>Data Needed:</strong> The 32 threads in the warp each need 8 bytes. The total <em>useful</em> data for the warp is <code>32 threads * 8 bytes/thread =</code> <strong>256 bytes</strong>.</p>
<p><strong>Data Fetched:</strong> All the data needed by the warp (from <code>A[0]</code> up to <code>A[4*31 + 1] = A[125]</code>) fits within a single 512-byte memory block. Because of the DRAM burst rule, the system <em>must</em> fetch the entire <strong>512-byte</strong> chunk to satisfy these requests.</p>
<p>Efficiency=Total Fetched Data/Useful Data=256 bytes/512 bytes=0.5</p>
<p>Achieved Throughput=Peak Bandwidth×Efficiency=240GB/s × 0.5=120 GB/s</p>
</blockquote>
<h2 id="8-convolution-concept-constant-cache">8 Convolution Concept; Constant Cache<a class="headerlink" href="#8-convolution-concept-constant-cache" title="Permanent link">&para;</a></h2>
<h3 id="convolution-applications">Convolution Applications<a class="headerlink" href="#convolution-applications" title="Permanent link">&para;</a></h3>
<p><strong>Convolution compuation</strong>: An array operation where each output data element is a weighted sum of a collection of neighboring input elements</p>
<p>The weights used in the weighted sum calculation are defined by an input mask array, commonly referred to as the <em>convolution kernel(convolution filter, or convolution masks)</em>.</p>
<h4 id="1d-kernel-convolution">1D kernel convolution<a class="headerlink" href="#1d-kernel-convolution" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250918095150442.png" alt="image-20250918095150442" style="zoom:33%;" /></p>
<p>Boundary Handling 边界处理</p>
<ul>
<li>This kernel forces all elements outside the valid range to <strong>0</strong></li>
</ul>
<p><img src="./assets/image-20250919113811744.png" alt="image-20250919113811744" style="zoom:33%;" /></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="n">convolution_1D_basic_kernel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Mask_Width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="p">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">N_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">Mask_Width</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Mask_Width</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">N_start_point</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">N_start_point</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">      </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">N_start_point</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="w">  </span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="2d-convolution-with-boundary-condition-handling">2D Convolution with boundary condition handling<a class="headerlink" href="#2d-convolution-with-boundary-condition-handling" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250919114321290.png" alt="image-20250919114321290" style="zoom:33%;" /></p>
<ul>
<li>Boundry conditions also affect the efficiency of tiling</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_2D_basic_kernel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="err">，</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">F</span><span class="err">，</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="p">{</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">outCol</span><span class="o">=</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">outRow</span><span class="o">=</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fRow</span><span class="o">=</span><span class="mi">0</span><span class="o">:</span><span class="n">fRow</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="n">fRow</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fCol</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">fCol</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="n">fCol</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">      </span><span class="n">inRow</span><span class="w"> </span><span class="o">=</span><span class="n">outRow</span><span class="o">+</span><span class="n">fRow</span><span class="p">;</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">      </span><span class="n">inCol</span><span class="o">=</span><span class="n">outCol</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="n">fCol</span><span class="p">;</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">inRow</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inRow</span><span class="o">&lt;</span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">){</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">        </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">fRow</span><span class="p">][</span><span class="n">fCol</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">inRow</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inCol</span><span class="p">];</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="w">    </span><span class="n">P</span><span class="p">[</span><span class="n">outRow</span><span class="p">][</span><span class="n">outCol</span><span class="p">]</span><span class="o">=</span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>For global memory, you just <code>cudaMalloc()</code> and <code>cudaMemcpy()</code> like other arrays: </p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_F</span><span class="p">,</span><span class="w"> </span><span class="n">filterSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_F</span><span class="p">,</span><span class="w"> </span><span class="n">h_F</span><span class="p">,</span><span class="w"> </span><span class="n">filterSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>What does this kernel accomplish?</p>
<p><img src="./assets/image-20250919114747548.png" alt="image-20250919114747548" style="zoom:25%;" /></p>
<ul>
<li>Elements of M are called <strong>mask</strong> (kernel, filter) <strong>coefficients</strong>(weights)</li>
<li>Calculation of all output P elements needs M</li>
<li>M is not changed during grid execution </li>
<li>Bonus - M elements are accessed in the same order when calculating all P elements</li>
<li>M is a good candidate for <strong>Constant Memory</strong></li>
</ul>
<h3 id="programmer-view-of-cuda-memories">Programmer View of CUDA Memories<a class="headerlink" href="#programmer-view-of-cuda-memories" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250919115739416.png" alt="image-20250919115739416" style="zoom:33%;" /></p>
<h3 id="memory-hierarchies">Memory Hierarchies<a class="headerlink" href="#memory-hierarchies" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Review</strong>: If we had to go to global memory to access data all the time, the execution speed of GPUs would be limited by the global memory bandwidth</p>
<ul>
<li>We saw the use of shared memory in tiled matrix multiplication to reduce this limitation</li>
<li>Another important solution: Caches</li>
</ul>
</blockquote>
<h4 id="a-2d-convolution-kernel-using-constant-memory-for-f">A 2D convolution kernel using constant memory for F<a class="headerlink" href="#a-2d-convolution-kernel-using-constant-memory-for-f" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="n">__constant__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// r is the radius of the filter</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_2D_const_mem_kernel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">                                                </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">outRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fRow</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fCol</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">inRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outRow</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fRow</span><span class="p">;</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outCol</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fCol</span><span class="p">;</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inRow</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="w">                </span><span class="n">inCol</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="w">                </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">fRow</span><span class="p">][</span><span class="n">fCol</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">inRow</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inCol</span><span class="p">];</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="w">    </span><span class="n">P</span><span class="p">[</span><span class="n">outRow</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">outCol</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>For constant memory, you must copy the filter to the GPU before launching the kernel 对于常量内存，您必须在启动内核之前将过滤器复制到 GPU：</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">F_const</span><span class="p">,</span><span class="w"> </span><span class="n">h_F</span><span class="p">,</span><span class="w"> </span><span class="n">filterSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="cache">Cache<a class="headerlink" href="#cache" title="Permanent link">&para;</a></h3>
<p>Recall: <strong>memory bursts</strong> </p>
<ul>
<li>contain around <strong>1024 bits</strong> (<strong>128B</strong>) fromconsecutive (linear) addresses</li>
<li>Let’s call a single burst a <strong>line</strong></li>
</ul>
<p>A <strong>cache</strong> is <strong>an 'array' of cache lines</strong></p>
<ul>
<li>A cache line can usually hold data from several consecutive memory addresses</li>
<li>When data is requested from the global memory, an entire cache line that includes the data being accessed is loaded into the cache, in an attempt to reduce global memory requests</li>
<li>The data in the cache is a <strong>“copy” of the original data in global memory</strong></li>
<li>Additional hardware is used to remember the addresses of the data in the cache line</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p><strong>Memory read</strong> <em>produces</em> <strong>a line</strong>, <strong>cache</strong> <em>stores</em> <strong>a copy of the line</strong>, and <strong>tag</strong> <em>records</em> <strong>the line’s memory address</strong></p>
</blockquote>
<h4 id="caches-and-locality">Caches and Locality<a class="headerlink" href="#caches-and-locality" title="Permanent link">&para;</a></h4>
<p><strong>Spatial locality 空间局部性</strong>: when the data elements stored in consecutive memory locations are accessed consecutively</p>
<p><strong>Temporal locality 时间局部性</strong>: when the same data element is accessed multiple times in a short period of time</p>
<ul>
<li>Both spatial locality and temporal locality improve the performance of caches</li>
</ul>
<p>An executing program loads and stores data from memory.</p>
<p>Consider <strong>a sequence of addresses</strong> accessed.</p>
<ul>
<li><strong>Sequence</strong> usually <strong>shows</strong> both types of <strong>locality</strong>:<ul>
<li><strong>spatial</strong>: accessing <strong>X implies</strong> accessing <strong>X+1</strong> (and X+2, and so forth) <strong>soon</strong></li>
<li><em>temporal</em><em>: accessing X</em><em> implies accessing </em><em>X again soon</em>*</li>
</ul>
</li>
<li>Caches improve performance for both types.</li>
</ul>
<h4 id="caches-cant-hold-everything">Caches Can’t Hold Everything<a class="headerlink" href="#caches-cant-hold-everything" title="Permanent link">&para;</a></h4>
<p>Caches are smaller than memory.</p>
<ul>
<li>When the cache is full, it must make room for a new line, usually by <strong>discarding the least recently used line</strong>.</li>
</ul>
<h4 id="shared-memory-vs-cache">Shared Memory vs. Cache<a class="headerlink" href="#shared-memory-vs-cache" title="Permanent link">&para;</a></h4>
<p>Shared memory in CUDA is another type of temporary storage used to relieve main memory contention</p>
<ul>
<li>In terms of distance from the SMs, shared memory is similar to L1 cache </li>
<li>Unlike cache, shared memory doesn't necessarily hold a copy of data that is also in main memory </li>
<li>Shared memory requires <strong>explicit data transfer</strong> instructions into locations in the shared memory, whereas cache doesn’t. 共享内存需要声明变量<code>__shared__</code>并显示地将全局内存变量的值复制到共享内存变量中；使用缓存时，程序会自动保存最近使用的变量并记住它们原始全局内存地址</li>
</ul>
<p>Caches vs. shared memory</p>
<p>• Both on <em>chip</em>, with similar performance (As of Volta generation, both using the same physical resources, </p>
<p>allocated dynamically!)</p>
<p><strong>Difference</strong></p>
<ul>
<li><strong>Programmer controls shared memory</strong> contents (called a scratchpad)</li>
<li><strong>Microarchitecture</strong> automatically <strong>determines the contents of the cache</strong>. (<strong>static RAM</strong>, not DRAM)</li>
</ul>
<h4 id="constant-cache-in-gpus">Constant cache in GPUs<a class="headerlink" href="#constant-cache-in-gpus" title="Permanent link">&para;</a></h4>
<p><strong>Modification to cached data</strong> needs to be (eventually) <strong>reflected back</strong> to the original data in global memory</p>
<ul>
<li>Requires logic to track the modified status, etc.</li>
</ul>
<p><strong>Constant cache</strong> is a special cache for constant data that will <strong>not be modified</strong> during kernel execution by a grid</p>
<ul>
<li>Data declared in the constant memory is not modified during kernel execution.</li>
<li>Constant cache can be accessed with higher throughput than L1 cache for some common patterns</li>
<li>L1 cache may write back, constant doesn't need to support writes</li>
</ul>
<p><strong>To support writes</strong> (modification of lines), <strong>changes</strong> must be <strong>copied back to memory</strong>, and cache must <strong>track</strong> modification <strong>status.</strong></p>
<ul>
<li><strong>L1 cache</strong> in GPU (for global memory accesses) <strong>supports writes</strong>.</li>
<li><strong>Cache for constant</strong> / texture <strong>memory</strong></li>
</ul>
<p>Special case: <strong>lines are read-only</strong></p>
<ul>
<li>Enables higher-throughput access than L1 for common GPU kernel access patterns</li>
</ul>
<hr />
<p>GPU L2/L1 Caches</p>
<p><img src="./assets/image-20250918101255648.png" alt="image-20250918101255648" style="zoom:40%;" /></p>
<ul>
<li>L1 的延迟和带宽速度都接近处理器的速度；L2 缓存更大，访问时间需要十几个时钟周期，通常在多个处理器核心之间共享</li>
<li>Global memory variables and constant memory variables are all in DRAM</li>
</ul>
<h4 id="using-constant-memory">Using Constant Memory<a class="headerlink" href="#using-constant-memory" title="Permanent link">&para;</a></h4>
<p>Declare constant memory array as global variable outside the CUDA kernel and any host function</p>
<ul>
<li><code>__constant__ float filter_c[FILTER_DIM];</code></li>
</ul>
<p>Must initialize constant memory from the host, and cannot modify it during execution</p>
<ul>
<li><code>cudaMemcpyToSymbol(filter_c, filter, FILTER_DIM * sizeof(float), offset = 0, kind = cudaMemcpyHostToDevice);</code></li>
</ul>
<p>General use: <code>cudaMemcpyToSymbol(dest, src, size)</code></p>
<ul>
<li>dest 指向常亮内存中目标位置的指针，src指向主机内存源数据，size要复制的字节数量</li>
</ul>
<p>Can only allocate up to 64KB; Otherwise, input is also constant, but it is too large to put in constant memory</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="cm">/*Host Example*/</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="c1">// MASK_WIDTH is the size of the mask</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="c1">// global variable, outside any kernel/function</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="n">__constant__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Mc</span><span class="p">[</span><span class="n">MASK_WIDTH</span><span class="p">];</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="c1">// Initialize Mask</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="kt">float</span><span class="w"> </span><span class="n">Mask</span><span class="p">[</span><span class="n">MASK_WIDTH</span><span class="p">];</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MASK_WIDTH</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">    </span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">Mc</span><span class="p">,</span><span class="w"> </span><span class="n">Mask</span><span class="p">,</span><span class="w"> </span><span class="n">MASK_WIDTH</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="n">ConvolutionKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span><span class="w"> </span><span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">Nd</span><span class="p">,</span><span class="w"> </span><span class="n">Pd</span><span class="p">,</span><span class="w"> </span><span class="n">MASK_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">WIDTH</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>We are <strong>memory-limited</strong> 内存受限</p>
<ul>
<li>For the 1D case, every output element requires <code>2*MASK_WIDTH</code> loads (of M and N each) and <code>2*MASK_WIDTH</code> floating-point operations. </li>
<li>For the 2D case, every output element requires <code>2*MASK_WIDTH^2</code> loads and <code>2*MASK_WIDTH^2</code> floating-point operations.</li>
</ul>
<h3 id="tiled-convolution-with-halo-cells">Tiled convolution with halo cells<a class="headerlink" href="#tiled-convolution-with-halo-cells" title="Permanent link">&para;</a></h3>
<h4 id="tiled-1d-convolution-basic-idea">Tiled 1D Convolution Basic Idea<a class="headerlink" href="#tiled-1d-convolution-basic-idea" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250919134811711.png" alt="image-20250919134811711" style="zoom:33%;" /></p>
<p><strong>Reuse data read from global memory(use shared memory)</strong></p>
<p><img src="./assets/image-20250919135650456.png" alt="image-20250919135650456" style="zoom:25%;" /></p>
<p><strong>What About the Halos? Do we also copy halos into shared memory?</strong></p>
<p><img src="./assets/image-20250919135736591.png" alt="image-20250919135736591" style="zoom:33%;" /></p>
<p><strong>Approach 1</strong>: Can Access Halo from Global Memory</p>
<ul>
<li>threads <strong>read halo values</strong> directly <strong>from global memory</strong></li>
<li>Advantage: optimize reuse of shared memory(halo reuse is smaller).</li>
<li>Disadvantages:<ul>
<li><strong>Branch divergence</strong>! (shared vs. global reads) 分支分歧</li>
<li>Halo <strong>too narrow to fill</strong> a memory <strong>burst</strong></li>
</ul>
</li>
</ul>
<p><strong>Approach 2</strong>: Can Load Halo to Shared Memory</p>
<ul>
<li><strong>load halos to shared memory</strong></li>
<li>Advantages: <ul>
<li>Coalesce global memory accesses 合并全局内存访问</li>
<li><strong>No branch divergence</strong> during computation</li>
</ul>
</li>
<li>Disadvantages:<ul>
<li>Some threads must do &gt;1 load, so some branch divergence in reading data.</li>
<li>Slightly more shared memory is needed.</li>
</ul>
</li>
</ul>
<h4 id="three-tiling-strategies">Three Tiling Strategies<a class="headerlink" href="#three-tiling-strategies" title="Permanent link">&para;</a></h4>
<h5 id="strategy-1">Strategy 1<a class="headerlink" href="#strategy-1" title="Permanent link">&para;</a></h5>
<p>Variable Meanings for a Block</p>
<p><img src="./assets/image-20250919140806644.png" alt="image-20250919140806644" style="zoom: 40%;" /><img src="./assets/image-20250919141526332.png" alt="image-20250919141526332" style="zoom:25%;" /></p>
<ol>
<li>
<p>Loading the Left Halo</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span>
<span class="normal"><a href="#__codelineno-38-4">4</a></span>
<span class="normal"><a href="#__codelineno-38-5">5</a></span>
<span class="normal"><a href="#__codelineno-38-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mask_Width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">halo_index_left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">radius</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">radius</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="p">(</span><span class="n">halo_index_left</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">halo_index_left</span><span class="p">];</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>Loading the Right Halo</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span>
<span class="normal"><a href="#__codelineno-39-4">4</a></span>
<span class="normal"><a href="#__codelineno-39-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="k">else</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>Loading the Internal Elements</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span>
<span class="normal"><a href="#__codelineno-40-4">4</a></span>
<span class="normal"><a href="#__codelineno-40-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">halo_index_right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">radius</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">    </span><span class="p">(</span><span class="n">halo_index_right</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">halo_index_right</span><span class="p">];</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>Put it together</p>
</li>
</ol>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="c1">// Load left halo </span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="c1">// Load internal elements</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="c1">// Load right halo </span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="c1">// Compute and store results</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Mask_Width</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="w">  </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Mc</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="p">}</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<hr />
<p><strong>Alternative Implementation of Strategy 1</strong></p>
<p><img src="./assets/image-20250919142036598.png" alt="image-20250919142036598" style="zoom:25%;" /></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span>
<span class="normal"><a href="#__codelineno-42-15">15</a></span>
<span class="normal"><a href="#__codelineno-42-16">16</a></span>
<span class="normal"><a href="#__codelineno-42-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="c1">//STEP1</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// all threads</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">start</span><span class="p">];</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">  </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="p">}</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="c1">//STEP2</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MASK_WIDTH</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// some threads</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">;</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">    </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">start</span><span class="p">];</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15"></a><span class="w">    </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TILE_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h5 id="strategy-2">Strategy 2<a class="headerlink" href="#strategy-2" title="Permanent link">&para;</a></h5>
<p><img src="./assets/image-20250919140948710.png" alt="image-20250919140948710" style="zoom:40%;" /></p>
<blockquote>
<p>See in <a href="# Strategy 2: Parallelize Loading of a Tile">next chapter</a></p>
</blockquote>
<h5 id="strategy-3">Strategy 3<a class="headerlink" href="#strategy-3" title="Permanent link">&para;</a></h5>
<p><img src="./assets/image-20250919141017716.png" alt="image-20250919141017716" style="zoom: 40%;" /></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span>
<span class="normal"><a href="#__codelineno-43-21">21</a></span>
<span class="normal"><a href="#__codelineno-43-22">22</a></span>
<span class="normal"><a href="#__codelineno-43-23">23</a></span>
<span class="normal"><a href="#__codelineno-43-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="c1">// Loading data</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">N_ds</span><span class="p">[</span><span class="n">TILE_WIDTH</span><span class="p">];</span><span class="w"> </span><span class="c1">// variable initilization and shared memory declaration</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="c1">// load from global to shared</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="c1">// boundary checking is missing here</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="c1">//Computing</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="kt">int</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mask_Width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="kt">int</span><span class="w"> </span><span class="n">This_tile_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="kt">int</span><span class="w"> </span><span class="n">Next_tile_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="kt">int</span><span class="w"> </span><span class="n">N_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Mask_Width</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">N_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N_start_point</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">N_index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">N_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">N_index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">This_tile_start_point</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="w">        </span><span class="p">(</span><span class="n">N_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Next_tile_start_point</span><span class="p">))</span><span class="w"> </span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="w">      </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">N_ds</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">radius</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21"></a><span class="w">      </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">N_index</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Mc</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23"></a><span class="p">}</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24"></a><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>[!CAUTION]</p>
<p>What Shall We Parallelize?</p>
<ul>
<li>Strategies 1 and 3</li>
</ul>
</blockquote>
<h2 id="9-2d-tiled-convolution-kernel-reuse-analysis">9 2D Tiled Convolution Kernel; Reuse Analysis<a class="headerlink" href="#9-2d-tiled-convolution-kernel-reuse-analysis" title="Permanent link">&para;</a></h2>
<h3 id="stencil-algorithms">Stencil Algorithms<a class="headerlink" href="#stencil-algorithms" title="Permanent link">&para;</a></h3>
<p>Numerical data processing algorithms which update array elements according to some fixed pattern, called a <em>stencil</em> 根据某种固定模式（称为模板）更新数组元素的数值数据处理算法</p>
<p><img src="./assets/image-20250923093928016.png" alt="image-20250923093928016" style="zoom: 33%;" /></p>
<h3 id="strategy-2-parallelize-loading-of-a-tile">Strategy 2: Parallelize Loading of a Tile<a class="headerlink" href="#strategy-2-parallelize-loading-of-a-tile" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250919140948710.png" alt="image-20250919140948710" style="zoom: 40%;" /></p>
<p>Alternately,</p>
<ul>
<li>Thread block matches input tile size</li>
<li>Each thread loads one element of input tile</li>
<li>Some threads do not participate in calculating output</li>
</ul>
<p><strong>Advantage</strong>:</p>
<ul>
<li><mark>No branch divergence for load</mark> (high latency).</li>
<li><strong>Avoid narrow global access</strong> (2 × halo width).</li>
</ul>
<p><strong>Disadvantage</strong>:</p>
<ul>
<li>Branch divergence for compute (low latency).</li>
</ul>
<h4 id="parallelizing-tile-loading">Parallelizing Tile Loading<a class="headerlink" href="#parallelizing-tile-loading" title="Permanent link">&para;</a></h4>
<p>Load a tile of N into shared memory</p>
<ul>
<li>All threads participate in loading</li>
<li>A subset of threads then use each N element in shared memory</li>
<li>Output Tiles Still Cover the Output!</li>
<li>Input Tiles Need to be Larger than Output Tiles</li>
</ul>
<h4 id="setting-block-dimensions">Setting Block Dimensions<a class="headerlink" href="#setting-block-dimensions" title="Permanent link">&para;</a></h4>
<p><code>dim3 dimBlock(TILE_WIDTH + 4,TILE_WIDTH + 4, 1);</code></p>
<p>In general, <strong>block width</strong> (square blocks) should be <code>TILE_WIDTH + (MASK_WIDTH-1)</code></p>
<p><code>dim3 dimGrid(ceil(ceil(P.widthP.height/(1.0*TILE_WIDTH)),/(1.0*TILE_WIDTH)), 1)</code></p>
<ul>
<li>There need to be enough thread blocks to generate all P elements</li>
<li>There need to be enough threads to load entire tile of input</li>
</ul>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span>
<span class="normal"><a href="#__codelineno-44-6">6</a></span>
<span class="normal"><a href="#__codelineno-44-7">7</a></span>
<span class="normal"><a href="#__codelineno-44-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="cm">/* Shifting From Output Coordinates To Input Coordinates */</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">row_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="kt">int</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="kt">int</span><span class="w"> </span><span class="n">row_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_o</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// MASK_WIDTH / 2</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="kt">int</span><span class="w"> </span><span class="n">col_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// (radius in prev. code)</span>
</span></code></pre></div></td></tr></table></div>
<p>Threads That Loads Halos Outside N Should Return 0.0</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span>
<span class="normal"><a href="#__codelineno-45-4">4</a></span>
<span class="normal"><a href="#__codelineno-45-5">5</a></span>
<span class="normal"><a href="#__codelineno-45-6">6</a></span>
<span class="normal"><a href="#__codelineno-45-7">7</a></span>
<span class="normal"><a href="#__codelineno-45-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="cm">/*  Taking Care of Boundaries */</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">row_i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">row_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">col_i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">col_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="n">tile</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">row_i</span><span class="o">*</span><span class="n">Width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col_i</span><span class="p">];</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">    </span><span class="n">tile</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="p">}</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="n">__syncthreads</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="c1">// wait for tile</span>
</span></code></pre></div></td></tr></table></div>
<p>Not All Threads Calculate and Write Output</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">      </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Mc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tile</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">ty</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="n">tx</span><span class="p">];</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row_o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="n">P</span><span class="p">[</span><span class="n">row_o</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col_o</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="2d-tiled-convolution-kernel-with-constant-memory">2D Tiled Convolution Kernel (with constant memory)<a class="headerlink" href="#2d-tiled-convolution-kernel-with-constant-memory" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span>
<span class="normal"><a href="#__codelineno-47-21">21</a></span>
<span class="normal"><a href="#__codelineno-47-22">22</a></span>
<span class="normal"><a href="#__codelineno-47-23">23</a></span>
<span class="normal"><a href="#__codelineno-47-24">24</a></span>
<span class="normal"><a href="#__codelineno-47-25">25</a></span>
<span class="normal"><a href="#__codelineno-47-26">26</a></span>
<span class="normal"><a href="#__codelineno-47-27">27</a></span>
<span class="normal"><a href="#__codelineno-47-28">28</a></span>
<span class="normal"><a href="#__codelineno-47-29">29</a></span>
<span class="normal"><a href="#__codelineno-47-30">30</a></span>
<span class="normal"><a href="#__codelineno-47-31">31</a></span>
<span class="normal"><a href="#__codelineno-47-32">32</a></span>
<span class="normal"><a href="#__codelineno-47-33">33</a></span>
<span class="normal"><a href="#__codelineno-47-34">34</a></span>
<span class="normal"><a href="#__codelineno-47-35">35</a></span>
<span class="normal"><a href="#__codelineno-47-36">36</a></span>
<span class="normal"><a href="#__codelineno-47-37">37</a></span>
<span class="normal"><a href="#__codelineno-47-38">38</a></span>
<span class="normal"><a href="#__codelineno-47-39">39</a></span>
<span class="normal"><a href="#__codelineno-47-40">40</a></span>
<span class="normal"><a href="#__codelineno-47-41">41</a></span>
<span class="normal"><a href="#__codelineno-47-42">42</a></span>
<span class="normal"><a href="#__codelineno-47-43">43</a></span>
<span class="normal"><a href="#__codelineno-47-44">44</a></span>
<span class="normal"><a href="#__codelineno-47-45">45</a></span>
<span class="normal"><a href="#__codelineno-47-46">46</a></span>
<span class="normal"><a href="#__codelineno-47-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="cp">#define IN_TILE_DIM 32</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="cp">#define OUT_TILE_DIM (IN_TILE_DIM - 2 * FILTER_RADIUS)</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="c1">// Tile is split into input (IN_TILE_DIM) and output (OUT_TILE_DIM = IN_TILE_DIM − 2*r)</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="n">__constant__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">F_c</span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// constant memeory</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_tiled_2D_const_mem_kernel</span><span class="p">(</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="p">{</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">    </span><span class="c1">// Compute global indices of input elements (including halo)</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">    </span><span class="c1">// 全局输入坐标</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14"></a>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">    </span><span class="c1">// Shared memory tile (input + halo)</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">N_s</span><span class="p">[</span><span class="n">IN_TILE_DIM</span><span class="p">][</span><span class="n">IN_TILE_DIM</span><span class="p">];</span><span class="c1">// 每个块有 IN_TILE_DIM × IN_TILE_DIM 线程</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17"></a>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="w">    </span><span class="c1">// Load input tile from global memory into shared memory</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="w">        </span><span class="n">N_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="w">        </span><span class="n">N_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23"></a>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25"></a>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26"></a><span class="w">    </span><span class="c1">// Compute output element indices relative to tile</span>
</span><span id="__span-47-27"><a id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tileCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-47-28"><a id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tileRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-47-29"><a id="__codelineno-47-29" name="__codelineno-47-29"></a>
</span><span id="__span-47-30"><a id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="w">    </span><span class="c1">// Check if this thread computes a valid output element</span>
</span><span id="__span-47-31"><a id="__codelineno-47-31" name="__codelineno-47-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tileCol</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tileCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-47-32"><a id="__codelineno-47-32" name="__codelineno-47-32"></a><span class="w">        </span><span class="n">tileRow</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tileRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-47-33"><a id="__codelineno-47-33" name="__codelineno-47-33"></a><span class="w">        </span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span>
</span><span id="__span-47-34"><a id="__codelineno-47-34" name="__codelineno-47-34"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-47-35"><a id="__codelineno-47-35" name="__codelineno-47-35"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-47-36"><a id="__codelineno-47-36" name="__codelineno-47-36"></a>
</span><span id="__span-47-37"><a id="__codelineno-47-37" name="__codelineno-47-37"></a><span class="w">        </span><span class="c1">// Convolution sum over the filter window</span>
</span><span id="__span-47-38"><a id="__codelineno-47-38" name="__codelineno-47-38"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fRow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fRow</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-39"><a id="__codelineno-47-39" name="__codelineno-47-39"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fCol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fCol</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-40"><a id="__codelineno-47-40" name="__codelineno-47-40"></a><span class="w">                </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">F_c</span><span class="p">[</span><span class="n">fRow</span><span class="p">][</span><span class="n">fCol</span><span class="p">]</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-47-41"><a id="__codelineno-47-41" name="__codelineno-47-41"></a><span class="w">                          </span><span class="n">N_s</span><span class="p">[</span><span class="n">tileRow</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fRow</span><span class="p">][</span><span class="n">tileCol</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fCol</span><span class="p">];</span>
</span><span id="__span-47-42"><a id="__codelineno-47-42" name="__codelineno-47-42"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-47-43"><a id="__codelineno-47-43" name="__codelineno-47-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-47-44"><a id="__codelineno-47-44" name="__codelineno-47-44"></a><span class="w">        </span><span class="c1">// Write result to global memory</span>
</span><span id="__span-47-45"><a id="__codelineno-47-45" name="__codelineno-47-45"></a><span class="w">        </span><span class="n">P</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-47-46"><a id="__codelineno-47-46" name="__codelineno-47-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-47"><a id="__codelineno-47-47" name="__codelineno-47-47"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Host code</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span>
<span class="normal"><a href="#__codelineno-48-17">17</a></span>
<span class="normal"><a href="#__codelineno-48-18">18</a></span>
<span class="normal"><a href="#__codelineno-48-19">19</a></span>
<span class="normal"><a href="#__codelineno-48-20">20</a></span>
<span class="normal"><a href="#__codelineno-48-21">21</a></span>
<span class="normal"><a href="#__codelineno-48-22">22</a></span>
<span class="normal"><a href="#__codelineno-48-23">23</a></span>
<span class="normal"><a href="#__codelineno-48-24">24</a></span>
<span class="normal"><a href="#__codelineno-48-25">25</a></span>
<span class="normal"><a href="#__codelineno-48-26">26</a></span>
<span class="normal"><a href="#__codelineno-48-27">27</a></span>
<span class="normal"><a href="#__codelineno-48-28">28</a></span>
<span class="normal"><a href="#__codelineno-48-29">29</a></span>
<span class="normal"><a href="#__codelineno-48-30">30</a></span>
<span class="normal"><a href="#__codelineno-48-31">31</a></span>
<span class="normal"><a href="#__codelineno-48-32">32</a></span>
<span class="normal"><a href="#__codelineno-48-33">33</a></span>
<span class="normal"><a href="#__codelineno-48-34">34</a></span>
<span class="normal"><a href="#__codelineno-48-35">35</a></span>
<span class="normal"><a href="#__codelineno-48-36">36</a></span>
<span class="normal"><a href="#__codelineno-48-37">37</a></span>
<span class="normal"><a href="#__codelineno-48-38">38</a></span>
<span class="normal"><a href="#__codelineno-48-39">39</a></span>
<span class="normal"><a href="#__codelineno-48-40">40</a></span>
<span class="normal"><a href="#__codelineno-48-41">41</a></span>
<span class="normal"><a href="#__codelineno-48-42">42</a></span>
<span class="normal"><a href="#__codelineno-48-43">43</a></span>
<span class="normal"><a href="#__codelineno-48-44">44</a></span>
<span class="normal"><a href="#__codelineno-48-45">45</a></span>
<span class="normal"><a href="#__codelineno-48-46">46</a></span>
<span class="normal"><a href="#__codelineno-48-47">47</a></span>
<span class="normal"><a href="#__codelineno-48-48">48</a></span>
<span class="normal"><a href="#__codelineno-48-49">49</a></span>
<span class="normal"><a href="#__codelineno-48-50">50</a></span>
<span class="normal"><a href="#__codelineno-48-51">51</a></span>
<span class="normal"><a href="#__codelineno-48-52">52</a></span>
<span class="normal"><a href="#__codelineno-48-53">53</a></span>
<span class="normal"><a href="#__codelineno-48-54">54</a></span>
<span class="normal"><a href="#__codelineno-48-55">55</a></span>
<span class="normal"><a href="#__codelineno-48-56">56</a></span>
<span class="normal"><a href="#__codelineno-48-57">57</a></span>
<span class="normal"><a href="#__codelineno-48-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime.h&gt;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="cp">#define TILE_WIDTH 16</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="cp">#define MAX_FILTER_SIZE 49 </span><span class="c1">// example</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="c1">// Declare constant memory on the device</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="n">__constant__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">F_const</span><span class="p">[</span><span class="n">MAX_FILTER_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAX_FILTER_SIZE</span><span class="p">];</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="c1">// Kernel declaration</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_2D_tiled_const_mem_kernel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="w">                                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13"></a>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// filter radius, e.g. 3x3 filter</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">filterWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18"></a>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">imgSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">filterSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filterWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21"></a>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22"></a><span class="w">    </span><span class="c1">// Allocate host memory</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">h_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">imgSize</span><span class="p">);</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">h_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">imgSize</span><span class="p">);</span>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">h_F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">filterSize</span><span class="p">);</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26"></a>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27"></a><span class="w">    </span><span class="c1">// Initialize input and filter (example values, can be omitted)</span>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">h_N</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
</span><span id="__span-48-29"><a id="__codelineno-48-29" name="__codelineno-48-29"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">filterWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filterWidth</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">h_F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">filterWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filterWidth</span><span class="p">);</span>
</span><span id="__span-48-30"><a id="__codelineno-48-30" name="__codelineno-48-30"></a>
</span><span id="__span-48-31"><a id="__codelineno-48-31" name="__codelineno-48-31"></a><span class="w">    </span><span class="c1">// Allocate device memory</span>
</span><span id="__span-48-32"><a id="__codelineno-48-32" name="__codelineno-48-32"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_P</span><span class="p">;</span>
</span><span id="__span-48-33"><a id="__codelineno-48-33" name="__codelineno-48-33"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="n">imgSize</span><span class="p">);</span>
</span><span id="__span-48-34"><a id="__codelineno-48-34" name="__codelineno-48-34"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_P</span><span class="p">,</span><span class="w"> </span><span class="n">imgSize</span><span class="p">);</span>
</span><span id="__span-48-35"><a id="__codelineno-48-35" name="__codelineno-48-35"></a>
</span><span id="__span-48-36"><a id="__codelineno-48-36" name="__codelineno-48-36"></a><span class="w">    </span><span class="c1">// Copy image data to device</span>
</span><span id="__span-48-37"><a id="__codelineno-48-37" name="__codelineno-48-37"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="n">h_N</span><span class="p">,</span><span class="w"> </span><span class="n">imgSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-48-38"><a id="__codelineno-48-38" name="__codelineno-48-38"></a>
</span><span id="__span-48-39"><a id="__codelineno-48-39" name="__codelineno-48-39"></a><span class="w">    </span><span class="c1">// Copy filter to constant memory</span>
</span><span id="__span-48-40"><a id="__codelineno-48-40" name="__codelineno-48-40"></a><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">F_const</span><span class="p">,</span><span class="w"> </span><span class="n">h_F</span><span class="p">,</span><span class="w"> </span><span class="n">filterSize</span><span class="p">);</span>
</span><span id="__span-48-41"><a id="__codelineno-48-41" name="__codelineno-48-41"></a>
</span><span id="__span-48-42"><a id="__codelineno-48-42" name="__codelineno-48-42"></a><span class="w">    </span><span class="c1">// Configure grid and block</span>
</span><span id="__span-48-43"><a id="__codelineno-48-43" name="__codelineno-48-43"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="n">dimBlock</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">);</span>
</span><span id="__span-48-44"><a id="__codelineno-48-44" name="__codelineno-48-44"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="n">dimGrid</span><span class="p">((</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">,</span>
</span><span id="__span-48-45"><a id="__codelineno-48-45" name="__codelineno-48-45"></a><span class="w">                 </span><span class="p">(</span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">);</span>
</span><span id="__span-48-46"><a id="__codelineno-48-46" name="__codelineno-48-46"></a>
</span><span id="__span-48-47"><a id="__codelineno-48-47" name="__codelineno-48-47"></a><span class="w">    </span><span class="c1">// Launch kernel</span>
</span><span id="__span-48-48"><a id="__codelineno-48-48" name="__codelineno-48-48"></a><span class="w">    </span><span class="n">convolution_2D_tiled_const_mem_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span><span class="w"> </span><span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">d_N</span><span class="p">,</span><span class="w"> </span><span class="n">d_P</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>
</span><span id="__span-48-49"><a id="__codelineno-48-49" name="__codelineno-48-49"></a>
</span><span id="__span-48-50"><a id="__codelineno-48-50" name="__codelineno-48-50"></a><span class="w">    </span><span class="c1">// Copy result back to host</span>
</span><span id="__span-48-51"><a id="__codelineno-48-51" name="__codelineno-48-51"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">h_P</span><span class="p">,</span><span class="w"> </span><span class="n">d_P</span><span class="p">,</span><span class="w"> </span><span class="n">imgSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
</span><span id="__span-48-52"><a id="__codelineno-48-52" name="__codelineno-48-52"></a>
</span><span id="__span-48-53"><a id="__codelineno-48-53" name="__codelineno-48-53"></a><span class="w">    </span><span class="c1">// Cleanup</span>
</span><span id="__span-48-54"><a id="__codelineno-48-54" name="__codelineno-48-54"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_N</span><span class="p">);</span><span class="w"> </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_P</span><span class="p">);</span>
</span><span id="__span-48-55"><a id="__codelineno-48-55" name="__codelineno-48-55"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">h_N</span><span class="p">);</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">h_P</span><span class="p">);</span><span class="n">free</span><span class="p">(</span><span class="n">h_F</span><span class="p">);</span>
</span><span id="__span-48-56"><a id="__codelineno-48-56" name="__codelineno-48-56"></a>
</span><span id="__span-48-57"><a id="__codelineno-48-57" name="__codelineno-48-57"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-48-58"><a id="__codelineno-48-58" name="__codelineno-48-58"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Kernel (using shared + constant memory)</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span>
<span class="normal"><a href="#__codelineno-49-26">26</a></span>
<span class="normal"><a href="#__codelineno-49-27">27</a></span>
<span class="normal"><a href="#__codelineno-49-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_2D_tiled_const_mem_kernel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">                                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Ns</span><span class="p">[</span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">][</span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">];</span><span class="w"> </span><span class="c1">// input with halo</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全局输出坐标</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_o</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"> </span><span class="c1">// 输入</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">col_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11"></a>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">    </span><span class="c1">// Load shared memory (with boundary check)</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">row_i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">row_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">col_i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">col_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">))</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">        </span><span class="n">Ns</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">row_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col_i</span><span class="p">];</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">        </span><span class="n">Ns</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17"></a>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19"></a>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row_o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col_o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="w">                </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">F_const</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ns</span><span class="p">[</span><span class="n">ty</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">][</span><span class="n">tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25"></a>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="w">        </span><span class="n">P</span><span class="p">[</span><span class="n">row_o</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col_o</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="reuse-analysis">Reuse Analysis<a class="headerlink" href="#reuse-analysis" title="Permanent link">&para;</a></h3>
<h4 id="a-small-1d-convolution-example">A Small 1D Convolution Example<a class="headerlink" href="#a-small-1d-convolution-example" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250924225144480.png" alt="image-20250924225144480" style="zoom:33%;" /></p>
<ul>
<li><code>8+(5-1) = 12</code> unique elements of input array N loaded</li>
<li><code>8*5=40</code> global memory accesses potentially replaced by shared memory accesses</li>
<li>This gives a bandwidth reduction of <strong>40/12=3.3</strong></li>
<li>This is independent of the size of <code>N</code></li>
</ul>
<blockquote>
<p>[!IMPORTANT]</p>
<p>In General, for <strong>1D Convolution Kernels</strong>(inner tiles)</p>
<p>Load <code>(TILE_WIDTH + MASK_WIDTH – 1)</code> elements from global memory to shared memory</p>
<p>Replace <code>(TILE_WIDTH * MASK_WIDTH)</code> global memory accesses with shared memory accesses</p>
<ul>
<li><strong>Bandwidth reduction</strong> of <code>(TILE_SIZE * MASK_WIDTH) / (TILE_SIZE + MASK_WIDTH - 1)</code></li>
</ul>
</blockquote>
<h5 id="boundary-tiles-ghost-elements-change-ratios">Boundary Tiles (Ghost Elements Change Ratios)<a class="headerlink" href="#boundary-tiles-ghost-elements-change-ratios" title="Permanent link">&para;</a></h5>
<p><img src="./assets/image-20250925173449177.png" alt="image-20250925173449177" style="zoom:33%;" /></p>
<p>For a <strong>boundary tile</strong>, we load <code>TILE_WIDTH + (MASK_WIDTH-1)/2 elements</code></p>
<ul>
<li><code>10</code> in our example of <code>TILE_WIDTH</code> of 8 and <code>MASK_WIDTH</code> of 5</li>
</ul>
<p>Computing boundary elements do not access global memory for ghost cells</p>
<ul>
<li>Total accesses is <code>6*5 + 4 + 3 = 37</code> accesses (when computing the P elements)</li>
</ul>
<p>The reduction is <strong>37/10 = 3.7</strong></p>
<h4 id="example-of-2d-convolution-example">Example of 2D Convolution Example<a class="headerlink" href="#example-of-2d-convolution-example" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250923100747766.png" alt="image-20250923100747766" style="zoom: 25%;" /></p>
<p>Global memory accesses/shared memory accesses</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>In gerneral, for <strong>2D Convolution Kernel</strong>(<em>inner tiles</em>)</p>
<p><code>(TILE_WIDTH+MASK_WIDTH-1)^2</code> elements need to be loaded from N into shared memory</p>
<ul>
<li>The calculation of each P element needs to access <code>MASK_WIDTH^2</code> elements of N</li>
<li><code>(TILE_WIDTH * MASK_WIDTH)^2</code> global memory accesses converted into shared 
      memory accesses</li>
<li><strong>Bandwidth reduction</strong> of <code>(TILE_WIDTH * MASK_WIDTH)^2 / (TILE_WIDTH + MASK_WIDTH - 1)^2</code></li>
</ul>
</blockquote>
<h5 id="boundary-tiles-ghost-elements-change-ratios_1">Boundary Tiles (Ghost Elements Change Ratios)<a class="headerlink" href="#boundary-tiles-ghost-elements-change-ratios_1" title="Permanent link">&para;</a></h5>
<p>For a <strong>boundary tile</strong>, we load <code>[TILE_WIDTH + (MASK_WIDTH-1)/2]^2 elements</code></p>
<ul>
<li><code>100</code> in our example of <code>TILE_WIDTH</code> of 8 and <code>MASK_WIDTH</code> of 5</li>
</ul>
<p>Computing boundary elements do not access global memory for ghost cells</p>
<ul>
<li>Total accesses is <code>3^2 + (3*4)*2 + (3*5)*12 + 4^2 + (4*5)*12 + 5^2*36=1,369</code> accesses (when computing the P elements)</li>
</ul>
<p>The reduction is <strong>1369/100 = 13.69</strong></p>
<h3 id="2bflop-for-untiled-convolution">2B/FLOP for Untiled Convolution<a class="headerlink" href="#2bflop-for-untiled-convolution" title="Permanent link">&para;</a></h3>
<p><strong>How much global memory per FLOP is in untiled convolution?</strong></p>
<ul>
<li>In untiled convolution 无边界卷积, each value from <strong>N</strong> (<em>4B</em> from global memory) is multiplied by a value from <strong>M</strong>(<strong>4B</strong> from constant cache, <em>1 FLOP</em>), then added to a running sum (<em>1 FLOP</em>)</li>
<li>That gives <em>2B/FLOP</em></li>
</ul>
<p><img src="./assets/image-20250923101706216.png" alt="image-20250923101706216" style="zoom: 25%;" /></p>
<p><img src="./assets/image-20250925200115825.png" alt="image-20250925200115825" style="zoom: 25%;" /></p>
<p>Shared memory &rarr; better performance</p>
<hr />
<p>Ampere SM Memory Architecture</p>
<p><img src="./assets/image-20250925201333130.png" alt="image-20250925201333130" style="zoom:33%;" /></p>
<h3 id="memory-hierarchy-considerations">Memory Hierarchy Considerations<a class="headerlink" href="#memory-hierarchy-considerations" title="Permanent link">&para;</a></h3>
<p>Register file is highly banked 高度分组化, but we can have bank conflicts that cause pipeline stalls 流水线停顿</p>
<p><strong>Shared memory is highly banked</strong>, but we can have bank conflicts that cause pipeline stalls</p>
<p>Global memory has multiple channels, banks, pages</p>
<ul>
<li>Relies on bursting 依赖于突发</li>
<li>Coalescing is important. 合并</li>
<li>Need programmer involvement.</li>
</ul>
<p>L1 Cache is non-coherent 非一致性的</p>
<h3 id="problem-solving_3">Problem Solving<a class="headerlink" href="#problem-solving_3" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250925202400763.png" alt="image-20250925202400763" style="zoom: 33%;" /></p>
<p><img src="./assets/image-20250925203524924.png" alt="image-20250925203524924" style="zoom:33%;" /></p>
<p><a href="# Control Divergence">Control Divergence</a></p>
<p>Why It Happens in This Case</p>
<ol>
<li>
<p><strong>The Setup:</strong> You have a 32×32 block of threads. The threads on the outermost border are only responsible for loading the "halo" or "apron" data. Only the inner 30×30 threads are responsible for calculating the final output pixels.</p>
</li>
<li>
<p><strong>The <code>if</code> Statement:</strong> To separate these roles, the kernel code must contain an <code>if</code> statement. Conceptually, it looks like this:</p>
<p>C++</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span>
<span class="normal"><a href="#__codelineno-50-5">5</a></span>
<span class="normal"><a href="#__codelineno-50-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="c1">// thread_x and thread_y are the thread&#39;s coordinates (0-31)</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">thread_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">thread_y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">thread_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w">    </span><span class="c1">// I am an &quot;inner&quot; thread. Do the convolution calculation.</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w">    </span><span class="c1">// I am a &quot;border&quot; thread. Do nothing.</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong>Analyzing a Middle Warp (Warps 1-30):</strong> Let's consider Warp 16, which might handle the 17<sup>th</sup> row of the tile (where <code>thread_y = 16</code>). This warp consists of 32 threads with <code>thread_x</code> coordinates from 0 to 31.</p>
<p>When this warp hits the <code>if</code> statement:</p>
<ul>
<li><strong>Thread 0</strong> (<code>thread_x = 0</code>): The condition is <code>false</code>. It wants to take the <code>else</code> path.</li>
<li><strong>Threads 1 through 30</strong> (<code>thread_x</code> is 1-30): The condition is <code>true</code>. These <strong>30 threads</strong> want to take the <code>if</code> path and compute.</li>
<li><strong>Thread 31</strong> (<code>thread_x = 31</code>): The condition is <code>false</code>. It wants to take the <code>else</code> path.</li>
</ul>
<p>Because the 32 threads within this single warp disagree—30 go one way and 2 go the other—the warp experiences <strong>control divergence</strong>. This exact scenario happens for all the warps that handle rows 1 through 30.</p>
</li>
</ol>
<p>By contrast, Warp 0 (handling row 0) and Warp 31 (handling row 31) have <strong>no divergence</strong> because all 32 threads within them uniformly fail the condition and take the <code>else</code> path together.</p>
<hr />
<p><img src="./assets/image-20250925210040891.png" alt="image-20250925210040891" style="zoom: 40%;" /></p>
<h2 id="10-introduction-to-ml-inference-and-training-in-dnns">10 Introduction to ML; Inference and Training in DNNs<a class="headerlink" href="#10-introduction-to-ml-inference-and-training-in-dnns" title="Permanent link">&para;</a></h2>
<h3 id="machine-learning">Machine Learning<a class="headerlink" href="#machine-learning" title="Permanent link">&para;</a></h3>
<p><strong>Machine learning</strong>: important method of building applications whose logic is not fully understood</p>
<p>Typically, by example:</p>
<ul>
<li><strong>use labeled data</strong> (matched input-output pairs)</li>
<li><strong>to represent</strong> desired <strong>relationship</strong></li>
</ul>
<p><strong>Iteratively adjust program logic</strong> to produce desired/approximate answers (called <strong>training</strong>)</p>
<p>Types of Learning Tasks</p>
<ul>
<li>Classification, Regression &lt;- structured data</li>
<li>Transcription, Translation &lt;- unstructured data</li>
</ul>
<p>ML now: computing power(GPU), data, needs</p>
<ul>
<li><strong>Computing Power</strong>: GPU computing hardware and programming interfaces such as CUDA has enabled very fast research cycle of deep neural net training</li>
<li><strong>Data</strong>: Lots of cheap sensors, cloud storage, IoT, photo sharing, etc.</li>
<li><strong>Needs</strong>: Autonomous Vehicles, Smart Devices, Security, Societal Comfort with Tech, Health Care</li>
</ul>
<h3 id="classification">Classification<a class="headerlink" href="#classification" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20250925210619675.png" alt="image-20250925210619675" style="zoom:33%;" /></p>
<h4 id="linear-classificationperceptron">Linear Classification(perceptron感知器)<a class="headerlink" href="#linear-classificationperceptron" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925210744039.png" alt="image-20250925210744039" style="zoom:33%;" /></p>
<p>perceptron function: <strong>y = sign (W∙x + b)</strong> (-1, 0, 1)</p>
<h3 id="multi-layer-perceptron-mlp-for-digit-recognition">Multi-Layer Perceptron (MLP) for Digit Recognition<a class="headerlink" href="#multi-layer-perceptron-mlp-for-digit-recognition" title="Permanent link">&para;</a></h3>
<p><a href="https://colab.research.google.com/drive/1Y7L_wFvp8ePwsTi7vu74Ni-X8VCANin1?usp=sharing#scrollTo=VgE1LB8I1NS3">https://colab.research.google.com/drive/1Y7L_wFvp8ePwsTi7vu74Ni-X8VCANin1?usp=sharing#scrollTo=VgE1LB8I1NS3</a></p>
<p><img src="./assets/image-20250925212233229.png" alt="image-20250925212233229" style="zoom:33%;" /></p>
<h4 id="how-do-we-determine-the-weights">How Do We Determine the Weights?<a class="headerlink" href="#how-do-we-determine-the-weights" title="Permanent link">&para;</a></h4>
<p>First layer of perceptron:
• <code>784 (28^2)</code> inputs, 10 outputs, fully connected
• <code>[10×784]</code> weight matrix <em>W</em>
• <code>[10 x 1]</code> bias vector <em>b</em></p>
<p>Use labeled training data to pick weights.</p>
<ul>
<li>given enough labeled input data</li>
<li>we can approximate the input-output function.</li>
</ul>
<h4 id="forward-and-backward-propagation">Forward and Backward Propagation<a class="headerlink" href="#forward-and-backward-propagation" title="Permanent link">&para;</a></h4>
<p><strong>Forward (inference)</strong>:</p>
<ul>
<li>given input <em>x</em> (for example, an image)</li>
<li>use parameters <em>ϴ</em> (<em>W</em> and <em>b</em> for each layer)</li>
<li>to compute probabilities <code>k[i]</code> (ex: for each digit i).</li>
</ul>
<p><strong>Backward (training)</strong>:</p>
<ul>
<li>given input <em>x</em>, parameters <em>ϴ</em>, and outputs <code>k[i]</code>,</li>
<li>compute error <em>E</em> based on target label <em>t</em>,</li>
<li>Then adjust <em>ϴ</em> proportionally to <em>E</em> to reduce error.</li>
</ul>
<hr />
<p><strong>To propagate error</strong> backwards 反向传播误差, we <strong>use the chain rule</strong> 链式法则 from calculus. <strong>Smooth functions are useful.</strong> 平滑函数</p>
<h4 id="sigmoidlogistic-function">Sigmoid/Logistic Function<a class="headerlink" href="#sigmoidlogistic-function" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925214555383.png" alt="image-20250925214555383" style="zoom:33%;" /></p>
<h4 id="reluactivation-functions">ReLU(Activation Functions)<a class="headerlink" href="#reluactivation-functions" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925214505498.png" alt="image-20250925214505498" style="zoom:33%;" /></p>
<h4 id="use-softmax-to-produce-probabilities">Use Softmax to Produce Probabilities<a class="headerlink" href="#use-softmax-to-produce-probabilities" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925214729932.png" alt="image-20250925214729932" style="zoom: 25%;" /></p>
<p>Softmax Derivatives</p>
<p><img src="./assets/image-20250925214640388.png" alt="image-20250925214640388" style="zoom: 25%;" /></p>
<h4 id="error-function">Error Function<a class="headerlink" href="#error-function" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925214339683.png" alt="image-20250925214339683" style="zoom: 25%;" /></p>
<h4 id="stochastic-gradient-descent">Stochastic Gradient Descent 随机梯度下降<a class="headerlink" href="#stochastic-gradient-descent" title="Permanent link">&para;</a></h4>
<p><strong>How do we calculate the weights?</strong></p>
<p>One common answer: <strong>stochastic gradient descent</strong>.</p>
<ol>
<li>
<p>Calculate the <strong>derivative</strong> of the sum of error <em>E</em> over all training inputs for all network parameters <em>ϴ</em>.</p>
</li>
<li>
<p>Change <em>ϴ</em> slightly in the opposite direction (to decrease error).</p>
</li>
<li>
<p>Repeat.</p>
</li>
</ol>
<p><img src="./assets/image-20250925213546001.png" alt="image-20250925213546001" style="zoom: 25%;" /></p>
<h4 id="example-gradient-update-with-one-layer">Example: Gradient Update with One Layer<a class="headerlink" href="#example-gradient-update-with-one-layer" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250925213244593.png" alt="image-20250925213244593" style="zoom:33%;" /></p>
<h2 id="11-computation-in-cnns-and-transformers">11 Computation in CNNs and Transformers<a class="headerlink" href="#11-computation-in-cnns-and-transformers" title="Permanent link">&para;</a></h2>
<p><strong>Convolution Naturally Supports Varying Input Size</strong>, while perceptron layers have fixed structure, so number of inputs / outputs is fixed.</p>
<h3 id="example-convolution-inputs">Example convolution Inputs<a class="headerlink" href="#example-convolution-inputs" title="Permanent link">&para;</a></h3>
<p><img src="./assets/image-20251005000016322.png" alt="image-20251005000016322" style="zoom:50%;" /></p>
<h3 id="why-convolution">Why Convolution<a class="headerlink" href="#why-convolution" title="Permanent link">&para;</a></h3>
<p>Sparse interactions</p>
<ul>
<li>Meaningful features in small spatial regions</li>
<li>Need fewer parameters (less storage, better statistical characteristics, faster training)</li>
<li>Need multiple layers for wide receptive field</li>
</ul>
<p>Parameter sharing</p>
<ul>
<li>Kernel mask is applied repeatedly computing layer output</li>
</ul>
<p>Equivariant Representations</p>
<ul>
<li>If input is translated, output is similarly translated</li>
<li>Output is a map of where features appear in input</li>
</ul>
<h4 id="convolution-vs-multi-layer-perceptron">Convolution vs Multi-Layer Perceptron<a class="headerlink" href="#convolution-vs-multi-layer-perceptron" title="Permanent link">&para;</a></h4>
<p><img src="./assets/image-20250930100153659.png" alt="image-20250930100153659" style="zoom: 25%;" /></p>
<h4 id="anatomy-of-a-convolution-layer">Anatomy of a Convolution Layer 卷积层剖析<a class="headerlink" href="#anatomy-of-a-convolution-layer" title="Permanent link">&para;</a></h4>
<p>Input features: A inputs each <span class="arithmatex">\(N_1 × N_2\)</span></p>
<p>Convolution Layer: B convolution kernels each <span class="arithmatex">\(K_1 × K_2\)</span></p>
<p>Output Features (total of B): A × B outputs each <span class="arithmatex">\((N_1 – K_1+1) × (N_2 – K_2+1)\)</span></p>
<h3 id="2-d-pooling-subsampling">2-D Pooling (Subsampling)<a class="headerlink" href="#2-d-pooling-subsampling" title="Permanent link">&para;</a></h3>
<p>A subsampling layer 子采样层</p>
<ul>
<li>Sometimes with bias位置偏差 and non-linearity 非线性 built in</li>
</ul>
<p>Common types</p>
<ul>
<li>max, average, <span class="arithmatex">\(L^2\)</span> norm, weighted average</li>
</ul>
<p>Helps make representation invariant to size scaling and small translations in the input</p>
<p>有助于使表示对输入中的尺寸缩放和小幅平移保持不变 </p>
<h3 id="forward-propagation">Forward Propagation<a class="headerlink" href="#forward-propagation" title="Permanent link">&para;</a></h3>
<p>Example of the Forward Path of a Convolution Layer</p>
<p><img alt="image-20251005001113971" src="assets/image-20251005001113971.png" /></p>
<h4 id="sequential-code-forward-pooling-layer">Sequential Code: Forward Pooling Layer<a class="headerlink" href="#sequential-code-forward-pooling-layer" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span>
<span class="normal"><a href="#__codelineno-51-12">12</a></span>
<span class="normal"><a href="#__codelineno-51-13">13</a></span>
<span class="normal"><a href="#__codelineno-51-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">poolingLayer_forward</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">H_out</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">W_out</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="p">{</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each image</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each output feature map</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">H_out</span><span class="o">/</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each output value (two loops)</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">W_out</span><span class="o">/</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="w">          </span><span class="kt">float</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="w"> </span><span class="c1">// initialize sum to 0</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="c1">// loop over NxN block of Y (two loops)</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="w">                </span><span class="n">acc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">];</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="w">          </span><span class="n">acc</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="c1">// calculate average over block</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="w">          </span><span class="n">S</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bias</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="w"> </span><span class="c1">// bias, non-linearity</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="host-code-for-a-basic-kernel-cuda-grid">Host Code for a Basic Kernel: CUDA Grid<a class="headerlink" href="#host-code-for-a-basic-kernel-cuda-grid" title="Permanent link">&para;</a></h4>
<p>Consider an output feature map:</p>
<ul>
<li>width is <strong>W_out</strong>, andheight is <strong>H_out</strong>.</li>
<li>Assume these are multiples of <strong>TILE_WIDTH</strong>.</li>
<li>Let <strong>X_grid</strong> be the number of blocks needed in X dim.</li>
<li>Let <strong>Y_grid</strong> be the number of blocks needed in Y dim</li>
</ul>
<p>Assuming <code>W_out</code> and <code>H_out</code> are multiples of <code>TILE_WIDTH</code></p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span>
<span class="normal"><a href="#__codelineno-52-2">2</a></span>
<span class="normal"><a href="#__codelineno-52-3">3</a></span>
<span class="normal"><a href="#__codelineno-52-4">4</a></span>
<span class="normal"><a href="#__codelineno-52-5">5</a></span>
<span class="normal"><a href="#__codelineno-52-6">6</a></span>
<span class="normal"><a href="#__codelineno-52-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="cp">#define TILE_WIDTH 16 </span><span class="c1">// We will use 4 for small examples.</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="n">W_grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W_out</span><span class="o">/</span><span class="n">TILE_WIDTH</span><span class="p">;</span><span class="w"> </span><span class="c1">// number of horizontal tiles per output map</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="n">H_grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H_out</span><span class="o">/</span><span class="n">TILE_WIDTH</span><span class="p">;</span><span class="w"> </span><span class="c1">// number of vertical tiles per output map</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H_grid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">W_grid</span><span class="p">;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="n">dim3</span><span class="w"> </span><span class="nf">blockDim</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// output tile for untiled code</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="n">dim3</span><span class="w"> </span><span class="nf">gridDim</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="n">ConvLayerForward_Kernel</span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="n">gridDim</span><span class="p">,</span><span class="w"> </span><span class="n">blockDim</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="forward-convolutional-layer">Forward Convolutional Layer 卷积前向传播<a class="headerlink" href="#forward-convolutional-layer" title="Permanent link">&para;</a></h4>
<p>CPU串行 Sequential Code</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">convLayer_forward</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w">                       </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="p">{</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">H_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// calculate H_out, W_out</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">W_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each image</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each output feature map</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">H_out</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">// for each output value (two loops)</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">W_out</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10"></a><span class="w">          </span><span class="n">Y</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// initialize sum to 0</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">// sum over all input channels</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">// KxK filter</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="w">                </span><span class="n">Y</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">W</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">];</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>最外侧4个循环是grid计算，里面4个循环是thread计算</li>
</ul>
<p>GPU并行 Partial Kernel Code for a Convolution Layer</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ConvLayerForward_Basic_Kernel</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="w">  </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">W_grid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="c1">// cuda内核函数</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="p">{</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每个线程块（Block）负责计算一个输出特征图</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">W_grid</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">W_grid</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// sum over all input channels</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">// loop over KxK filter</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a><span class="w">        </span><span class="n">acc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">W</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">];</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13"></a><span class="w">  </span><span class="n">Y</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc</span><span class="p">;</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Image batch is omitted</li>
</ul>
<h2 id="13-atomic-operations-and-histogramming">13  Atomic Operations and Histogramming<a class="headerlink" href="#13-atomic-operations-and-histogramming" title="Permanent link">&para;</a></h2>
<blockquote>
<p>[!NOTE]</p>
<p>To understand atomic operations
  • Read-modify-write in parallel computation
  • A primitive form of “critical regions” in parallel programs
  • Use of atomic operations in CUDA
  • Why atomic operations reduce memory system throughput
  • How to avoid atomic operations in some parallel algorithms</p>
<p>To learn practical histogram programming techniques
  • Basic histogram algorithm using atomic operations
  • Atomic operation throughput
  • Privatization</p>
</blockquote>
<p>A Common Collaboration Pattern 合作模式</p>
<p>银行每个人数一部分钱，计到总数上，但有些可能没记上</p>
<p>A Common Arbitration Pattern 仲裁模式</p>
<p>多个人单独买自己的机票，但可能最后同一个位置被重复预定</p>
<h3 id="data-races">Data Races<a class="headerlink" href="#data-races" title="Permanent link">&para;</a></h3>
<p>A <strong>data race</strong> occurs when multiple threads access the same memory location concurrently without ordering and at least one access is a write</p>
<ul>
<li>Data races may result in unpredictable program output</li>
<li>To avoid data races, you should use atomic operations 原子操作.</li>
</ul>
<h2 id="quiz">Quiz<a class="headerlink" href="#quiz" title="Permanent link">&para;</a></h2>
<p><img alt="image-20250904152707085" src="assets/image-20250904152707085.png" /></p>
<blockquote>
<p>A is correct
</p>
</blockquote>
<p><img alt="image-20250916180541729" src="assets/image-20250916180541729.png" /></p>
<blockquote>
<p><strong>A</strong></p>
<p>The kernel reads from matrix <code>A</code> and matrix <code>B</code> to compute the output. For each element in the output matrix <code>C</code>, the kernel performs a dot product. This involves reading a full row from <code>A</code> and a full row from <code>B</code> (conceptually, though access patterns might differ).</p>
<ol>
<li><strong>Elements in C:</strong> The output matrix <code>C</code> has <code>numCRows</code> × <code>numCColumns</code> elements.<ul>
<li><code>40 * 33 = 1,320</code> elements.</li>
</ul>
</li>
<li><strong>Reads per C element:</strong> To calculate one element of <code>C</code>, a dot product of length <code>numAColumns</code> is performed. This requires reading <code>numAColumns</code> floats from <code>A</code> and <code>numAColumns</code> floats from <code>B</code>.<ul>
<li>Reads per element = <code>31 (from A) + 31 (from B) = 62</code> floats.</li>
</ul>
</li>
<li><strong>Total floats read:</strong><ul>
<li><code>1,320 elements * 62 floats/element = 81,840</code> floats.</li>
</ul>
</li>
<li><strong>Total bytes read:</strong> Since each float is 4 bytes:<ul>
<li><code>81,840 floats * 4 bytes/float = 327,360</code> bytes.</li>
</ul>
</li>
</ol>
</blockquote>
<p><img alt="image-20250916175752303" src="assets/image-20250916175752303.png" /></p>
<blockquote>
<p>The goal is to choose a block size that allows the Streaming Multiprocessor (SM) to simultaneously reach its maximum thread count <strong>and</strong> its maximum block count.</p>
<ol>
<li><strong>Find the Ideal Threads per Block:</strong> To saturate both limits, divide the total number of threads an SM can handle by the total number of blocks it can handle.
   -   1536 total threads/16 total blocks=96 threads per block</li>
<li><strong>Convert Threads to Warps:</strong> A warp in an NVIDIA GPU always consists of 32 threads. Convert the ideal thread count into warps.<ul>
<li>96 threads per block/32 threads per warp = 3 warps per block</li>
</ul>
</li>
</ol>
</blockquote>
<p>Which of the following CUDA kernels could possibly have control divergence?</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span>
<span class="normal"><a href="#__codelineno-55-3">3</a></span>
<span class="normal"><a href="#__codelineno-55-4">4</a></span>
<span class="normal"><a href="#__codelineno-55-5">5</a></span>
<span class="normal"><a href="#__codelineno-55-6">6</a></span>
<span class="normal"><a href="#__codelineno-55-7">7</a></span>
<span class="normal"><a href="#__codelineno-55-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">E</span><span class="p">(</span><span class="kt">int</span><span class="p">[]</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">control</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">io</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">control</span><span class="p">;</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">  </span><span class="n">io</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">control</span><span class="p">;</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>The number can't be negative for <code>control * threadIdx.x</code>, so no control divergence.</p>
<p>[!CAUTION]</p>
</blockquote>
<p><img alt="image-20250916180502830" src="assets/image-20250916180502830.png" /></p>
<blockquote>
<p><strong>How many warps will be generated?</strong></p>
<ol>
<li><strong>Calculate Grid Dimensions:</strong><ul>
<li>The image has 176 rows and 174 columns.</li>
<li>Each block has 16 threads in the y-direction (height) and 16 threads in the x-direction (width).</li>
<li>Number of blocks in y-dimension: ceil(176/16)=ceil(11)=11 blocks.</li>
<li>Number of blocks in x-dimension: ceil(174/16)=ceil(10.875)=11 blocks.</li>
<li>This gives a grid of <strong>11x11 = 121 blocks</strong>.</li>
</ul>
</li>
<li><strong>Calculate Threads and Warps:</strong><ul>
<li>Each block has <strong>16x16 = 256 threads</strong>.</li>
<li>A <strong>warp</strong> consists of 32 threads.</li>
<li>Warps per block: 256 threads/32 threads/warp=8 warps.</li>
</ul>
</li>
<li><strong>Calculate Total Warps:</strong><ul>
<li>Total Warps = (Total Blocks) × (Warps per Block)</li>
<li>Total Warps = 121×8=968.</li>
</ul>
</li>
</ol>
<p><strong>Answer: <code>968</code></strong></p>
<p><strong>How many warps will have control divergence?</strong></p>
<p>The answer is 168 because control divergence in this kernel originates from <strong>two distinct sources</strong>, and your original calculation of 88 only accounted for one of them. <mark>warp中既有row &gt; col又有row≤col的会产生control divergence</mark> </p>
<ol>
<li>The explicit <code>if (row &gt; col)</code> check.</li>
<li>The implicit boundary check <code>if (... &amp;&amp; (col &lt; numCols))</code>.</li>
</ol>
<p><strong>The <code>if (row &gt; col)</code> Condition</strong></p>
<p>This is the most obvious source of divergence. A warp will diverge if some of its threads satisfy <code>row &gt; col</code> while others don't. This happens in thread blocks that lie on the main diagonal of the image.</p>
<ul>
<li>The grid of blocks is 11x11.</li>
<li>The blocks on the diagonal are those where <code>blockIdx.x == blockIdx.y</code>. There are <strong>11</strong> such blocks (from <code>(0,0)</code> to <code>(10,10)</code>).</li>
<li>Inside these blocks, every single one of the 8 warps will contain a mix of threads that are above and below the local diagonal (<code>threadIdx.y &gt; threadIdx.x</code>), causing them all to diverge.</li>
<li><strong>Divergent Warps from this source:</strong> 11 blocks×8 warps/block=88 warps.</li>
</ul>
<p><strong>The Outer Boundary Check</strong></p>
<p>This is the subtle part you missed. The kernel launches a grid of threads that is slightly larger than the image itself.</p>
<ul>
<li><strong>Grid Width:</strong> The grid has 11 blocks of 16 threads each, for a total width of 11×16=176 threads.</li>
<li><strong>Image Width:</strong> The image's <code>numCols</code> is only <strong>174</strong>.</li>
</ul>
<p>Because of this mismatch, the outer <code>if</code> statement <code>if ((row &lt; numRows) &amp;&amp; (col &lt; numCols))</code> will cause divergence for threads in the <strong>last column of blocks</strong> (where <code>blockIdx.x = 10</code>).</p>
<ul>
<li>In these blocks, threads with a global column index <code>col &lt; 174</code> will pass the check, while threads with <code>col &gt;= 174</code> will fail it.</li>
<li>This boundary occurs within the warps of these blocks, causing all warps in that last column to diverge.</li>
<li>There are <strong>11 blocks</strong> in this last column (<code>blockIdx.x = 10</code>, while <code>blockIdx.y</code> ranges from 0 to 10).</li>
<li><strong>Divergent Warps from this source:</strong> 11 blocks×8 warps/block=88 warps.</li>
</ul>
<p>To get the total number of divergent warps, we add the warps from both sources and subtract the overlap (since the block at <code>(10,10)</code> is in both sets).</p>
<ul>
<li><strong>Total = (Diagonal Warps 对角线) + (Boundary Warps 右边多出来的) - (Overlap Warps)</strong></li>
<li>The overlap is the single block <code>(10,10)</code>, which contains 8 warps.</li>
<li>Total = 88+88−8=168</li>
</ul>
<p>So, there are 80 unique warps on the diagonal, 80 unique warps on the boundary, and 8 warps that are on both, leading to the final correct answer.</p>
</blockquote>
<p><img alt="image-20250916180656441" src="assets/image-20250916180656441.png" /></p>
<blockquote>
<p>Control divergence is not "wait for the longest path"; it's even worse. It's basically going through all the paths sequentially. Suppose you have Path A and Path B that take 10ms/2ms to execute. Control divergence is basically saying you need to <strong>sequentially execute</strong> both path and the total execution time is 10+2=12ms. It has nothing to do with which path is longer since they're not parallel anymore.</p>
<p>'All threads must wait until the longest path is completed. '</p>
<p>This description usually fits <em>barrier synchronization</em> (we will talk about this concept soon), where multiple threads are running concurrently/in parallel and they synchronize at some point in the future. The threads that arrive first will wait for other threads. All threads won't continue until all threads have reached this synchronization point.</p>
</blockquote>
<p><img alt="image-20250916212024053" src="assets/image-20250916212024053.png" /></p>
<blockquote>
<p><strong>A: Operations by Threads for C Elements</strong></p>
<p>This question asks for the number of floating-point operations (flops) required to calculate the final <code>C</code> matrix, ignoring any work done by threads outside the matrix's bounds.</p>
<ol>
<li><strong>Flops per Element:</strong> To calculate a single element of the output matrix <code>C</code>, a dot product is performed. This involves iterating <code>numAColumns</code> (or <code>141</code>) times. Each iteration performs <strong>one multiplication</strong> and <strong>one addition</strong>.<ul>
<li>Operations per element = 141×2=282 flops.</li>
</ul>
</li>
<li><strong>Total Elements in C:</strong> The output matrix <code>C</code> has <code>numCRows</code> x <code>numCColumns</code> elements.<ul>
<li>Total elements = 100×92=9,200 elements.</li>
</ul>
</li>
<li><strong>Total Operations:</strong><ul>
<li>Total flops = (Total elements) × (Operations per element)</li>
<li>Total flops = 9,200×282=2,594,400.</li>
</ul>
</li>
</ol>
<p><strong>A: <code>2594400</code></strong></p>
<hr />
<p><strong>B: Operations by All Launched Threads</strong></p>
<ol>
<li>
<p>Determine the Grid and Block Configuration</p>
<p>First, we determine how many threads are launched in total. This is based on covering the output matrix <code>C</code> (100x92) with 32x32 tiles, where each tile corresponds to a thread block.</p>
<ul>
<li><strong>Grid Height:</strong> ceil(numCRows/32)=ceil(100/32)=4 blocks</li>
<li><strong>Grid Width:</strong> ceil(numCColumns/32)=ceil(92/32)=3 blocks</li>
<li><strong>Total Blocks:</strong> 4×3=12 blocks</li>
<li><strong>Threads per Block:</strong> 32×32=1,024 threads</li>
</ul>
</li>
<li>
<p>Determine the Number of Tile Iterations</p>
<p>For each thread block to compute its 32x32 output tile, it must loop over the tiles of the input matrices (<code>A</code> and <code>B</code>) along their common dimension, which is <code>numAColumns = 141</code>.</p>
<ul>
<li><strong>Tile Loop Iterations:</strong> ceil(numAColumns/32)=ceil(141/32)=5 iterations.</li>
</ul>
</li>
<li>
<p>Determine Operations per Iteration</p>
<p>In each of the 5 iterations, every thread in the block performs a series of multiplications and additions using the 32x32 tiles loaded into shared memory. Each thread performs <strong>32 multiplications</strong> and <strong>32 additions</strong> to contribute to its final output value.</p>
<ul>
<li><strong>Flops per Thread per Iteration:</strong> 32 multiplications+32 additions=64 floating-point operations.</li>
</ul>
</li>
<li>
<p>Calculate Total Floating-Point Operations</p>
<p>Finally, we combine these numbers to find the total work done by all threads across all loop iterations.</p>
<ul>
<li><strong>Total Flops = (Total Blocks) × (Threads per Block) × (Tile Iterations) × (Flops per Iteration)</strong></li>
<li>Total Flops = 12×1,024×5×64  = 12,288×320 = <strong>3,932,160</strong></li>
</ul>
</li>
</ol>
<p>B: <code>3932160</code></p>
</blockquote>
<p><img alt="image-20250916211845709" src="assets/image-20250916211845709.png" /></p>
<blockquote>
<p>Standard way: in the tiled multiplication, the number of blocks that will read a given element <code>A[i][k]</code> is equal to the number of blocks in the x-direction of the grid (which is <code>ceil(numCColumns/tile_width)</code>) because for fixed row i, it is used in all columns j of C.</p>
<p>Similarly, an element <code>B[k][j]</code> is read by all blocks in the y-direction of the grid <code>ceil(numCRows/tile_height)</code>.</p>
<p>So:</p>
<ul>
<li>Each element of A is read by (number of blocks in x-direction) = ceil(69/16)=5 times.</li>
<li>Each element of B is read by (number of blocks in y-direction) = ceil(80/16)=5 times.</li>
</ul>
<p>Therefore:</p>
<p>Total elements read from A = (number of elements in A) * (number of blocks in x-dir) = (80<em>41) * 5 = 3280 * 5 = 16400.
  Total elements read from B = (number of elements in B) * (number of blocks in y-dir) = (41</em>69) * 5 = 2829 * 5 = 14145.</p>
<p>So total elements read = 16400 + 14145 = 30545.
  Then total bytes read = 30545 * 4 bytes = <strong>122180</strong> bytes.</p>
</blockquote>
<p><img alt="image-20250930140436726" src="assets/image-20250930140436726.png" /></p>
<blockquote>
<p>If <code>MASK_WIDTH=3</code>, then you basically have 2 halo cells per block. In strategy 3, each of them are only read once. So basically it means that strategy 3 has the same number of global memory reads as strategy 1 and 2.</p>
<p>An increased number of global memory accesses is the primary reason why we don't want strategy 3 and want to reuse data. And now this downside is invalid for <code>MASK_WIDTH = 3</code>. </p>
<p>Strategy 3 now enjoys 1G for each halo:</p>
<ol>
<li>Smaller shared memory &amp; less number of threads per block =&gt; more blocks in an SM.</li>
<li>No redundant read from shared memory (halo cells are directly read from global memory)</li>
</ol>
<p>But Strategy 2 is 1G+1S for each halo</p>
</blockquote>
<p><img alt="image-20250930140551040" src="assets/image-20250930140551040.png" /></p>
<blockquote>
<ol>
<li>
<p>Block width = 16+9-1=24, then 24^2 threads per block</p>
<p>2048/24^2=3.556 </p>
<p><strong>3</strong> block/SM</p>
</li>
<li>
<p>3 block/SM * 24^2 threads/block * 4 bytes/float = 6912</p>
<p><strong>6912</strong> bytes</p>
</li>
<li>
<p>Average uses per value (internal tile):
        Total uses = outputs × mask_area = 16×16 × 9×9 = 256 × 81 = 20736.
        Values loaded = 24×24 = 576.
        Average = 20736 / 576 = <strong>36.00</strong> (4 significant figures).</p>
</li>
<li>Now each thread loads 4 values (so loaded values per block = 576×4 = 2304).
        With the same mask, choose the input tile such that loaded values = 2304 ⇒ input side = √2304 = 48.
        Outputs = (input side − (mask−1))^2 = (48 − 8)^2 = 40×40 = 1600 outputs.
        Total uses = 1600 × 81 = 129600. Average per loaded value = 129600 / 2304 = <strong>56.25</strong> (4 s.f.).</li>
</ol>
</blockquote>
<p><img alt="image-20250930150135653" src="assets/image-20250930150135653.png" /></p>
<p><img src="./assets/image-20250930150209775.png" alt="image-20250930150209775" style="zoom:25%;" /></p>
<p><img alt="image-20250930150232023" src="assets/image-20250930150232023.png" /></p>
<blockquote>
<p>Strategy 2, no load control divergence but 22 in the calculation</p>
</blockquote>
<h2 id="midterm">Midterm<a class="headerlink" href="#midterm" title="Permanent link">&para;</a></h2>
<h3 id="cuda-code-for-2d-convolution-tiled-matrix-operation">Cuda code for 2D convolution tiled matrix operation<a class="headerlink" href="#cuda-code-for-2d-convolution-tiled-matrix-operation" title="Permanent link">&para;</a></h3>
<p>A kernel computes <code>output = A * B + C</code> using a tiled approach with shared memory.</p>
<h4 id="host-code">Host code<a class="headerlink" href="#host-code" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span>
<span class="normal"><a href="#__codelineno-56-17">17</a></span>
<span class="normal"><a href="#__codelineno-56-18">18</a></span>
<span class="normal"><a href="#__codelineno-56-19">19</a></span>
<span class="normal"><a href="#__codelineno-56-20">20</a></span>
<span class="normal"><a href="#__codelineno-56-21">21</a></span>
<span class="normal"><a href="#__codelineno-56-22">22</a></span>
<span class="normal"><a href="#__codelineno-56-23">23</a></span>
<span class="normal"><a href="#__codelineno-56-24">24</a></span>
<span class="normal"><a href="#__codelineno-56-25">25</a></span>
<span class="normal"><a href="#__codelineno-56-26">26</a></span>
<span class="normal"><a href="#__codelineno-56-27">27</a></span>
<span class="normal"><a href="#__codelineno-56-28">28</a></span>
<span class="normal"><a href="#__codelineno-56-29">29</a></span>
<span class="normal"><a href="#__codelineno-56-30">30</a></span>
<span class="normal"><a href="#__codelineno-56-31">31</a></span>
<span class="normal"><a href="#__codelineno-56-32">32</a></span>
<span class="normal"><a href="#__codelineno-56-33">33</a></span>
<span class="normal"><a href="#__codelineno-56-34">34</a></span>
<span class="normal"><a href="#__codelineno-56-35">35</a></span>
<span class="normal"><a href="#__codelineno-56-36">36</a></span>
<span class="normal"><a href="#__codelineno-56-37">37</a></span>
<span class="normal"><a href="#__codelineno-56-38">38</a></span>
<span class="normal"><a href="#__codelineno-56-39">39</a></span>
<span class="normal"><a href="#__codelineno-56-40">40</a></span>
<span class="normal"><a href="#__codelineno-56-41">41</a></span>
<span class="normal"><a href="#__codelineno-56-42">42</a></span>
<span class="normal"><a href="#__codelineno-56-43">43</a></span>
<span class="normal"><a href="#__codelineno-56-44">44</a></span>
<span class="normal"><a href="#__codelineno-56-45">45</a></span>
<span class="normal"><a href="#__codelineno-56-46">46</a></span>
<span class="normal"><a href="#__codelineno-56-47">47</a></span>
<span class="normal"><a href="#__codelineno-56-48">48</a></span>
<span class="normal"><a href="#__codelineno-56-49">49</a></span>
<span class="normal"><a href="#__codelineno-56-50">50</a></span>
<span class="normal"><a href="#__codelineno-56-51">51</a></span>
<span class="normal"><a href="#__codelineno-56-52">52</a></span>
<span class="normal"><a href="#__codelineno-56-53">53</a></span>
<span class="normal"><a href="#__codelineno-56-54">54</a></span>
<span class="normal"><a href="#__codelineno-56-55">55</a></span>
<span class="normal"><a href="#__codelineno-56-56">56</a></span>
<span class="normal"><a href="#__codelineno-56-57">57</a></span>
<span class="normal"><a href="#__codelineno-56-58">58</a></span>
<span class="normal"><a href="#__codelineno-56-59">59</a></span>
<span class="normal"><a href="#__codelineno-56-60">60</a></span>
<span class="normal"><a href="#__codelineno-56-61">61</a></span>
<span class="normal"><a href="#__codelineno-56-62">62</a></span>
<span class="normal"><a href="#__codelineno-56-63">63</a></span>
<span class="normal"><a href="#__codelineno-56-64">64</a></span>
<span class="normal"><a href="#__codelineno-56-65">65</a></span>
<span class="normal"><a href="#__codelineno-56-66">66</a></span>
<span class="normal"><a href="#__codelineno-56-67">67</a></span>
<span class="normal"><a href="#__codelineno-56-68">68</a></span>
<span class="normal"><a href="#__codelineno-56-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime.h&gt;</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="c1">// Tile width for shared memory implementation</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="cp">#define TILE_WIDTH 32</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="c1">// Forward declaration of a helper function to initialize matrices</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getData</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="c1">// The provided host code starts here</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="cp">#define n 128 </span><span class="c1">// as an example</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">;</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15"></a><span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16"></a><span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17"></a><span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18"></a><span class="w">    </span><span class="n">getData</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"> </span><span class="c1">// this function fills in data for matrices A, B, and C</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19"></a>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20"></a><span class="w">    </span><span class="c1">// 1. Declare and allocate GPU memory</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">d_A</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_B</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_C</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_output</span><span class="p">;</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">matrix_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23"></a>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">d_A</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">);</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">d_B</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">);</span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">d_C</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">);</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27"></a><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">);</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28"></a>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29"></a><span class="w">    </span><span class="c1">// 2. Copy input matrices from host to device</span>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_A</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_B</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">d_C</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span><span id="__span-56-33"><a id="__codelineno-56-33" name="__codelineno-56-33"></a>
</span><span id="__span-56-34"><a id="__codelineno-56-34" name="__codelineno-56-34"></a><span class="w">    </span><span class="c1">// 3. Configure kernel launch parameters</span>
</span><span id="__span-56-35"><a id="__codelineno-56-35" name="__codelineno-56-35"></a><span class="w">    </span><span class="c1">// Block dimensions are fixed as required</span>
</span><span id="__span-56-36"><a id="__codelineno-56-36" name="__codelineno-56-36"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="n">dimBlock</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-56-37"><a id="__codelineno-56-37" name="__codelineno-56-37"></a>
</span><span id="__span-56-38"><a id="__codelineno-56-38" name="__codelineno-56-38"></a><span class="w">    </span><span class="c1">// Grid dimensions are calculated to cover the entire output matrix with tiles</span>
</span><span id="__span-56-39"><a id="__codelineno-56-39" name="__codelineno-56-39"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">grid_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">;</span>
</span><span id="__span-56-40"><a id="__codelineno-56-40" name="__codelineno-56-40"></a><span class="w">    </span><span class="n">dim3</span><span class="w"> </span><span class="n">dimGrid</span><span class="p">(</span><span class="n">grid_dim</span><span class="p">,</span><span class="w"> </span><span class="n">grid_dim</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-56-41"><a id="__codelineno-56-41" name="__codelineno-56-41"></a>
</span><span id="__span-56-42"><a id="__codelineno-56-42" name="__codelineno-56-42"></a><span class="w">    </span><span class="c1">// 4. Launch the kernel on the device</span>
</span><span id="__span-56-43"><a id="__codelineno-56-43" name="__codelineno-56-43"></a><span class="w">    </span><span class="n">MAC</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span><span class="w"> </span><span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">d_A</span><span class="p">,</span><span class="w"> </span><span class="n">d_B</span><span class="p">,</span><span class="w"> </span><span class="n">d_C</span><span class="p">,</span><span class="w"> </span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-56-44"><a id="__codelineno-56-44" name="__codelineno-56-44"></a>
</span><span id="__span-56-45"><a id="__codelineno-56-45" name="__codelineno-56-45"></a><span class="w">    </span><span class="c1">// 5. Copy the result matrix from device back to host</span>
</span><span id="__span-56-46"><a id="__codelineno-56-46" name="__codelineno-56-46"></a><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">d_output</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_size</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
</span><span id="__span-56-47"><a id="__codelineno-56-47" name="__codelineno-56-47"></a>
</span><span id="__span-56-48"><a id="__codelineno-56-48" name="__codelineno-56-48"></a><span class="w">    </span><span class="c1">// 6. Free all allocated memory</span>
</span><span id="__span-56-49"><a id="__codelineno-56-49" name="__codelineno-56-49"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_A</span><span class="p">);</span>
</span><span id="__span-56-50"><a id="__codelineno-56-50" name="__codelineno-56-50"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_B</span><span class="p">);</span>
</span><span id="__span-56-51"><a id="__codelineno-56-51" name="__codelineno-56-51"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_C</span><span class="p">);</span>
</span><span id="__span-56-52"><a id="__codelineno-56-52" name="__codelineno-56-52"></a><span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">d_output</span><span class="p">);</span>
</span><span id="__span-56-53"><a id="__codelineno-56-53" name="__codelineno-56-53"></a>
</span><span id="__span-56-54"><a id="__codelineno-56-54" name="__codelineno-56-54"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</span><span id="__span-56-55"><a id="__codelineno-56-55" name="__codelineno-56-55"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="__span-56-56"><a id="__codelineno-56-56" name="__codelineno-56-56"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
</span><span id="__span-56-57"><a id="__codelineno-56-57" name="__codelineno-56-57"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>
</span><span id="__span-56-58"><a id="__codelineno-56-58" name="__codelineno-56-58"></a>
</span><span id="__span-56-59"><a id="__codelineno-56-59" name="__codelineno-56-59"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-56-60"><a id="__codelineno-56-60" name="__codelineno-56-60"></a><span class="p">}</span>
</span><span id="__span-56-61"><a id="__codelineno-56-61" name="__codelineno-56-61"></a>
</span><span id="__span-56-62"><a id="__codelineno-56-62" name="__codelineno-56-62"></a><span class="c1">// Dummy implementation for getData to make the code runnable</span>
</span><span id="__span-56-63"><a id="__codelineno-56-63" name="__codelineno-56-63"></a><span class="kt">void</span><span class="w"> </span><span class="nf">getData</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-64"><a id="__codelineno-56-64" name="__codelineno-56-64"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-65"><a id="__codelineno-56-65" name="__codelineno-56-65"></a><span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
</span><span id="__span-56-66"><a id="__codelineno-56-66" name="__codelineno-56-66"></a><span class="w">        </span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span>
</span><span id="__span-56-67"><a id="__codelineno-56-67" name="__codelineno-56-67"></a><span class="w">        </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
</span><span id="__span-56-68"><a id="__codelineno-56-68" name="__codelineno-56-68"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-69"><a id="__codelineno-56-69" name="__codelineno-56-69"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="cuda-kernel-code">Cuda kernel code<a class="headerlink" href="#cuda-kernel-code" title="Permanent link">&para;</a></h4>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span>
<span class="normal"><a href="#__codelineno-57-22">22</a></span>
<span class="normal"><a href="#__codelineno-57-23">23</a></span>
<span class="normal"><a href="#__codelineno-57-24">24</a></span>
<span class="normal"><a href="#__codelineno-57-25">25</a></span>
<span class="normal"><a href="#__codelineno-57-26">26</a></span>
<span class="normal"><a href="#__codelineno-57-27">27</a></span>
<span class="normal"><a href="#__codelineno-57-28">28</a></span>
<span class="normal"><a href="#__codelineno-57-29">29</a></span>
<span class="normal"><a href="#__codelineno-57-30">30</a></span>
<span class="normal"><a href="#__codelineno-57-31">31</a></span>
<span class="normal"><a href="#__codelineno-57-32">32</a></span>
<span class="normal"><a href="#__codelineno-57-33">33</a></span>
<span class="normal"><a href="#__codelineno-57-34">34</a></span>
<span class="normal"><a href="#__codelineno-57-35">35</a></span>
<span class="normal"><a href="#__codelineno-57-36">36</a></span>
<span class="normal"><a href="#__codelineno-57-37">37</a></span>
<span class="normal"><a href="#__codelineno-57-38">38</a></span>
<span class="normal"><a href="#__codelineno-57-39">39</a></span>
<span class="normal"><a href="#__codelineno-57-40">40</a></span>
<span class="normal"><a href="#__codelineno-57-41">41</a></span>
<span class="normal"><a href="#__codelineno-57-42">42</a></span>
<span class="normal"><a href="#__codelineno-57-43">43</a></span>
<span class="normal"><a href="#__codelineno-57-44">44</a></span>
<span class="normal"><a href="#__codelineno-57-45">45</a></span>
<span class="normal"><a href="#__codelineno-57-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="cp">#define TILE_WIDTH 32</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MAC</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="p">{</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">    </span><span class="c1">// Shared memory to store tiles from A and B</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">TILE_WIDTH</span><span class="p">][</span><span class="n">TILE_WIDTH</span><span class="p">];</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">TILE_WIDTH</span><span class="p">][</span><span class="n">TILE_WIDTH</span><span class="p">];</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">    </span><span class="c1">// Thread indices within the block (tx: 0-31, ty: 0-31)</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12"></a>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="w">    </span><span class="c1">// Calculate the global row and column for the single output element this thread computes</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16"></a>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="w">    </span><span class="c1">// Accumulator register for the single output element</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19"></a>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20"></a><span class="w">    </span><span class="c1">// Loop over all tiles needed to compute the dot product</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22"></a><span class="w">        </span><span class="c1">// Load one element from global matrix A into shared memory A_s</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23"></a><span class="w">        </span><span class="n">A_s</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24"></a>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25"></a><span class="w">        </span><span class="c1">// Load one element from global matrix B into shared memory B_s</span>
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26"></a><span class="w">        </span><span class="n">B_s</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">B</span><span class="p">[(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27"></a>
</span><span id="__span-57-28"><a id="__codelineno-57-28" name="__codelineno-57-28"></a><span class="w">        </span><span class="c1">// Synchronize to ensure all data is loaded into shared memory before proceeding</span>
</span><span id="__span-57-29"><a id="__codelineno-57-29" name="__codelineno-57-29"></a><span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-57-30"><a id="__codelineno-57-30" name="__codelineno-57-30"></a>
</span><span id="__span-57-31"><a id="__codelineno-57-31" name="__codelineno-57-31"></a><span class="w">        </span><span class="c1">// Perform matrix multiplication for the current tiles from shared memory</span>
</span><span id="__span-57-32"><a id="__codelineno-57-32" name="__codelineno-57-32"></a><span class="w">        </span><span class="c1">// Each thread calculates one partial dot product</span>
</span><span id="__span-57-33"><a id="__codelineno-57-33" name="__codelineno-57-33"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_WIDTH</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-34"><a id="__codelineno-57-34" name="__codelineno-57-34"></a><span class="w">            </span><span class="n">acc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A_s</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_s</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span>
</span><span id="__span-57-35"><a id="__codelineno-57-35" name="__codelineno-57-35"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-57-36"><a id="__codelineno-57-36" name="__codelineno-57-36"></a>
</span><span id="__span-57-37"><a id="__codelineno-57-37" name="__codelineno-57-37"></a><span class="w">        </span><span class="c1">// Synchronize to ensure all calculations are done before loading the next tile</span>
</span><span id="__span-57-38"><a id="__codelineno-57-38" name="__codelineno-57-38"></a><span class="w">        </span><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-57-39"><a id="__codelineno-57-39" name="__codelineno-57-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-57-40"><a id="__codelineno-57-40" name="__codelineno-57-40"></a>
</span><span id="__span-57-41"><a id="__codelineno-57-41" name="__codelineno-57-41"></a><span class="w">    </span><span class="c1">// After the loops, add the element from C and write the final result</span>
</span><span id="__span-57-42"><a id="__codelineno-57-42" name="__codelineno-57-42"></a><span class="w">    </span><span class="c1">// to the output matrix, guarded by a boundary check.</span>
</span><span id="__span-57-43"><a id="__codelineno-57-43" name="__codelineno-57-43"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-44"><a id="__codelineno-57-44" name="__codelineno-57-44"></a><span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
</span><span id="__span-57-45"><a id="__codelineno-57-45" name="__codelineno-57-45"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-57-46"><a id="__codelineno-57-46" name="__codelineno-57-46"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3d-tiled-matrix-operation-convolution">3D tiled matrix operation Convolution<a class="headerlink" href="#3d-tiled-matrix-operation-convolution" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span>
<span class="normal"><a href="#__codelineno-58-22">22</a></span>
<span class="normal"><a href="#__codelineno-58-23">23</a></span>
<span class="normal"><a href="#__codelineno-58-24">24</a></span>
<span class="normal"><a href="#__codelineno-58-25">25</a></span>
<span class="normal"><a href="#__codelineno-58-26">26</a></span>
<span class="normal"><a href="#__codelineno-58-27">27</a></span>
<span class="normal"><a href="#__codelineno-58-28">28</a></span>
<span class="normal"><a href="#__codelineno-58-29">29</a></span>
<span class="normal"><a href="#__codelineno-58-30">30</a></span>
<span class="normal"><a href="#__codelineno-58-31">31</a></span>
<span class="normal"><a href="#__codelineno-58-32">32</a></span>
<span class="normal"><a href="#__codelineno-58-33">33</a></span>
<span class="normal"><a href="#__codelineno-58-34">34</a></span>
<span class="normal"><a href="#__codelineno-58-35">35</a></span>
<span class="normal"><a href="#__codelineno-58-36">36</a></span>
<span class="normal"><a href="#__codelineno-58-37">37</a></span>
<span class="normal"><a href="#__codelineno-58-38">38</a></span>
<span class="normal"><a href="#__codelineno-58-39">39</a></span>
<span class="normal"><a href="#__codelineno-58-40">40</a></span>
<span class="normal"><a href="#__codelineno-58-41">41</a></span>
<span class="normal"><a href="#__codelineno-58-42">42</a></span>
<span class="normal"><a href="#__codelineno-58-43">43</a></span>
<span class="normal"><a href="#__codelineno-58-44">44</a></span>
<span class="normal"><a href="#__codelineno-58-45">45</a></span>
<span class="normal"><a href="#__codelineno-58-46">46</a></span>
<span class="normal"><a href="#__codelineno-58-47">47</a></span>
<span class="normal"><a href="#__codelineno-58-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="cp">#define IN_TILE_DIM 32</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="cp">#define OUT_TILE_DIM ((IN_TILE_DIM) - 2*(FILTER_RADIUS))</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="n">__constant__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">F_c</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">FILTER_RADIUS</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">FILTER_RADIUS</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">FILTER_RADIUS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">convolution_tiled_3D_const_mem_kernel</span><span class="p">(</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="p">,</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="p">{</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14"></a><span class="w">    </span><span class="c1">// Allocate 3D shared memory tile</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15"></a><span class="w">    </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">N_s</span><span class="p">[</span><span class="n">IN_TILE_DIM</span><span class="p">][</span><span class="n">IN_TILE_DIM</span><span class="p">][</span><span class="n">IN_TILE_DIM</span><span class="p">];</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16"></a>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17"></a><span class="w">    </span><span class="c1">// Load input tile (including halo)</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19"></a><span class="w">        </span><span class="n">N_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20"></a><span class="w">            </span><span class="n">N</span><span class="p">[</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22"></a><span class="w">        </span><span class="n">N_s</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">][</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23"></a>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24"></a><span class="w">    </span><span class="n">__syncthreads</span><span class="p">();</span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25"></a>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26"></a><span class="w">    </span><span class="c1">// Compute output tile indices</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tileX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-28"><a id="__codelineno-58-28" name="__codelineno-58-28"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tileY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-29"><a id="__codelineno-58-29" name="__codelineno-58-29"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tileZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="p">;</span>
</span><span id="__span-58-30"><a id="__codelineno-58-30" name="__codelineno-58-30"></a>
</span><span id="__span-58-31"><a id="__codelineno-58-31" name="__codelineno-58-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-32"><a id="__codelineno-58-32" name="__codelineno-58-32"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tileX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tileX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-58-33"><a id="__codelineno-58-33" name="__codelineno-58-33"></a><span class="w">            </span><span class="n">tileY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tileY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-58-34"><a id="__codelineno-58-34" name="__codelineno-58-34"></a><span class="w">            </span><span class="n">tileZ</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tileZ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OUT_TILE_DIM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-35"><a id="__codelineno-58-35" name="__codelineno-58-35"></a>
</span><span id="__span-58-36"><a id="__codelineno-58-36" name="__codelineno-58-36"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
</span><span id="__span-58-37"><a id="__codelineno-58-37" name="__codelineno-58-37"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fz</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-38"><a id="__codelineno-58-38" name="__codelineno-58-38"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fy</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-39"><a id="__codelineno-58-39" name="__codelineno-58-39"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FILTER_RADIUS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">fx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-40"><a id="__codelineno-58-40" name="__codelineno-58-40"></a><span class="w">                        </span><span class="n">Pvalue</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">F_c</span><span class="p">[</span><span class="n">fz</span><span class="p">][</span><span class="n">fy</span><span class="p">][</span><span class="n">fx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-58-41"><a id="__codelineno-58-41" name="__codelineno-58-41"></a><span class="w">                                  </span><span class="n">N_s</span><span class="p">[</span><span class="n">tileZ</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fz</span><span class="p">][</span><span class="n">tileY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fy</span><span class="p">][</span><span class="n">tileX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fx</span><span class="p">];</span>
</span><span id="__span-58-42"><a id="__codelineno-58-42" name="__codelineno-58-42"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-58-43"><a id="__codelineno-58-43" name="__codelineno-58-43"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-58-44"><a id="__codelineno-58-44" name="__codelineno-58-44"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-58-45"><a id="__codelineno-58-45" name="__codelineno-58-45"></a><span class="w">            </span><span class="n">P</span><span class="p">[</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pvalue</span><span class="p">;</span>
</span><span id="__span-58-46"><a id="__codelineno-58-46" name="__codelineno-58-46"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-58-47"><a id="__codelineno-58-47" name="__codelineno-58-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-58-48"><a id="__codelineno-58-48" name="__codelineno-58-48"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><img alt="image-20251006214521808" src="assets/image-20251006214521808.png" /></p>
<blockquote>
<p>For Strategy 3</p>
<p><strong>Output Tile Size</strong>: 16×16=256 pixels loaded into the shared memory tile</p>
<p><strong>Mask Size</strong>: 9×5=45 elements</p>
<p><strong>Total Computational Reads</strong>: 256×45=11,520</p>
<p>11,520(Total Reads)−9,176(Shared Reads)=2,344 halo loads.</p>
<p><strong>9176 / 256</strong> represents the <strong>average reuse of data within the shared memory tile</strong></p>
<p><strong>11520/2600</strong> is the average reuse of <strong>total computational reads to total global memory loads</strong>.</p>
<hr />
<p>How to get 9176:</p>
<ol>
<li>Height Dimension Calculation (Filter Height = 9)</li>
</ol>
<p>We analyze how many times each of the <strong>16</strong> input rows in shared memory is accessed by the <strong>9-element</strong> tall filter. We can break the 16 rows into three regions.</p>
<ul>
<li><strong>Top Edge (Rows 0-3):</strong> These rows are too close to the edge to be used by the full height of the filter.<ul>
<li>Row 0 is used <strong>5</strong> times.</li>
<li>Row 1 is used <strong>6</strong> times.</li>
<li>Row 2 is used <strong>7</strong> times.</li>
<li>Row 3 is used <strong>8</strong> times.</li>
<li><em>Subtotal: 26</em></li>
</ul>
</li>
<li><strong>Middle (Rows 4-11):</strong> These 8 rows are far from the edges, so each one is fully used by the filter <strong>9</strong> times.<ul>
<li>8 rows×9 uses/row=72</li>
<li><em>Subtotal: 72</em></li>
</ul>
</li>
<li><strong>Bottom Edge (Rows 12-15):</strong> This is a mirror image of the top edge.<ul>
<li><em>Subtotal: 26</em></li>
</ul>
</li>
</ul>
<p>The total number of vertical accesses is 26+72+26=124.</p>
<ol start="2">
<li>Width Dimension Calculation (Filter Width = 5)</li>
</ol>
<p>Next, we do the same for the width. We analyze how many times each of the <strong>16</strong> input columns in shared memory is accessed by the <strong>5-element</strong> wide filter.</p>
<ul>
<li><strong>Left Edge (Columns 0-1):</strong><ul>
<li>Column 0 is used <strong>3</strong> times.</li>
<li>Column 1 is used <strong>4</strong> times.</li>
<li><em>Subtotal: 7</em></li>
</ul>
</li>
<li><strong>Middle (Columns 2-13):</strong> These 12 columns are each fully used by the filter <strong>5</strong> times.<ul>
<li>12 columns×5 uses/column=60</li>
<li><em>Subtotal: 60</em></li>
</ul>
</li>
<li><strong>Right Edge (Columns 14-15):</strong> This is a mirror image of the left edge.<ul>
<li><em>Subtotal: 7</em></li>
</ul>
</li>
</ul>
<p>The total number of horizontal accesses is 7+60+7=74.</p>
<p>Combining the Dimensions: To get the total number of reads from the 2D shared memory tile, we multiply the totals from the height and width calculations.</p>
<p>Total Shared Reads=(Total Vertical Accesses)×(Total Horizontal Accesses)</p>
<p>Total Shared Reads=124×74=9,176</p>
</blockquote>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年10月10日 00:34:04 CST">2025年10月10日 00:34:04</span>
  </span>

    
    
    
    
  </aside>




<div id="__comments">
  
    <h2 ><!-- 评论 -->评论区~</h2>
    
    有用的话请给我个赞和 star => <a href="https://cindyzhou2003.github.io/mymkdocs/">
        <img alt="GitHub stars" src="https://img.shields.io/github/stars/CindyZhou2003/mymkdocs.svg?style=plastic&amp;label=Stars"></a>
    
    
    </div>
    <script src="https://giscus.app/client.js"
        data-repo="CindyZhou2003/mymkdocs"
        data-repo-id="R_kgDOJHRt5g"
        data-category="General"
        data-category-id="DIC_kwDOJHRt5s4Cge0r"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>

        updateScheme();

    </script>
    
    
    <!-- Synchronize Giscus theme with palette -->
    <script>
    var giscus = document.querySelector("script[src*=giscus]")
    
    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"
        giscus.setAttribute("data-theme", theme) 
    }
    
    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
            var theme = palette.color.scheme === "slate" ? "dark" : "light"
            localStorage.setItem("data-md-color-scheme", palette.color.scheme === "slate" ? "slate" : "default");
            /* Instruct Giscus to change theme */
            var frame = document.querySelector(".giscus-frame")
            frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
            )
        }
        })
    })
    </script>
                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../ZJU/%E4%B9%A0%E6%A6%82.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: 习概">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                习概
              </div>
            </div>
          </a>
        
        
          
          <a href="ECE448.html" class="md-footer__link md-footer__link--next" aria-label="下一页: ECE448/CS440 Artificial Intelligence">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                ECE448/CS440 Artificial Intelligence
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024-2025 <a href="https://github.com/CindyZhou2003/mymkdocs"  target="_blank" rel="noopener">Cindy</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/CindyZhou2003/mymkdocs" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "navigation.indexes", "navigation.expand", "toc.follow", "navigation.top", "search.suggest", "navigation.footer", "navigation.tabs", "navigation.tracking", "navigation.instant.progress", "content.code.copy", "search.highlight", "search.share", "content.code.annotate", "navigation.tabs"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
      
        <script src="../js/katex.js"></script>
      
        <script src="../js/tablesort.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>